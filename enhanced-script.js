// ===== PROFESSIONAL POS SYSTEM =====
// Multi-language, Multi-currency, Multi-user with all professional features

// ===== CONFIGURATION & DATA =====

// Multi-language support (English, Arabic, French, Spanish)
const languages = {
    en: {
        welcome: 'Welcome to MyPOS',
        categories: 'Categories',
        products: 'Products',
        currentOrder: 'Current Order',
        subtotal: 'Subtotal',
        tax: 'Tax',
        total: 'Total',
        clearCart: 'Clear Cart',
        checkout: 'Checkout',
        emptyCart: 'No items in cart',
        allItems: 'All Items',
        food: 'Food',
        drinks: 'Drinks',
        snacks: 'Snacks',
        cashier: 'Cashier',
        admin: 'Admin',
        manager: 'Manager',
        login: 'Login',
        logout: 'Logout',
        username: 'Username',
        password: 'Password',
        lowStock: 'Low Stock Alert',
        printReceipt: 'Print Receipt',
        reports: 'Reports',
        inventory: 'Inventory',
        settings: 'Settings',
        currency: 'Currency',
        language: 'Language',
        sales: 'Sales',
        dashboard: 'Dashboard',
        users: 'Users',
        addProduct: 'Add Product',
        editProduct: 'Edit Product',
        deleteProduct: 'Delete Product',
        stock: 'Stock',
        price: 'Price',
        barcode: 'Barcode',
        category: 'Category',
        save: 'Save',
        cancel: 'Cancel',
        delete: 'Delete',
        edit: 'Edit',
        add: 'Add',
        search: 'Search',
        filter: 'Filter',
        export: 'Export',
        import: 'Import',
        backup: 'Backup',
        restore: 'Restore',
        invoice: 'Invoice',
        receipt: 'Receipt',
        printInvoice: 'Print Invoice',
        lowStockReport: 'Low Stock Report',
        expiredItems: 'Expired Items',
        printLowStock: 'Print Low Stock',
        printExpired: 'Print Expired',
        productImage: 'Product Image',
        uploadImage: 'Upload Image',
        changeImage: 'Change Image',
        removeImage: 'Remove Image',
        expiryDate: 'Expiry Date',
        expired: 'Expired',
        nearExpiry: 'Near Expiry',
        supplier: 'Supplier',
        cost: 'Cost',
        profit: 'Profit',
        margin: 'Margin',
        todaysSales: 'Today\'s Sales',
        thisWeek: 'This Week',
        thisMonth: 'This Month',
        totalProducts: 'Total Products',
        transactions: 'Transactions',
        averageTransaction: 'Average Transaction',
        topSellingProducts: 'Top Selling Products',
        cashierPerformance: 'Cashier Performance',
        recentSales: 'Recent Sales',
        dailyReport: 'Daily Report',
        weeklyReport: 'Weekly Report',
        monthlyReport: 'Monthly Report',
        salesReport: 'Sales Report',
        inventoryReport: 'Inventory Report',
        profitReport: 'Profit Report',
        taxReport: 'Tax Report',
        customerReceipt: 'Customer Receipt',
        businessInvoice: 'Business Invoice',
        companyInfo: 'Company Information',
        customerInfo: 'Customer Information',
        itemsNeedRestocking: 'items need restocking',
        activeProducts: 'active products',
        outOfStock: 'Out of Stock',
        inStock: 'In Stock',
        lowStock: 'Low Stock',
        goodStock: 'Good Stock',
        description: 'Description',
        quantity: 'Quantity',
        time: 'Time',
        date: 'Date',
        summary: 'Summary',
        urgentAction: 'Urgent Action Required',
        restockImmediately: 'Restock these items immediately',
        productName: 'Product Name',
        currentStock: 'Current Stock',
        minimumStock: 'Minimum Stock',
        generatedBy: 'Generated by',
        printedOn: 'Printed on',
        noLowStockItems: 'No low stock items found',
        noExpiredItems: 'No expired or near-expiry items found',
        expiryStatus: 'Expiry Status',
        daysUntilExpiry: 'Days Until Expiry',
        daysOverdue: 'Days Overdue',
        scanBarcode: 'Scan Barcode',
        enterBarcode: 'Enter Barcode',
        useCamera: 'Use Camera',
        manualEntry: 'Manual Entry',
        connectScanner: 'Connect Scanner',
        pointCameraAtBarcode: 'Point camera at barcode',
        productAdded: 'Product Added',
        productNotFound: 'Product Not Found',
        scannerConnected: 'Scanner Connected',
        scannerDisconnected: 'Scanner Disconnected',
        cameraAccessError: 'Camera access denied or not available',
        totalSales: 'Total Sales',
        totalTransactions: 'Total Transactions',
        paymentMethod: 'Payment Method',
        companyLogo: 'Company Logo',
        uploadLogo: 'Upload Logo',
        removeLogo: 'Remove Logo',
        companySettings: 'Company Settings',
        logoSettings: 'Logo Settings',
        addProduct: 'Add Product',
        editProduct: 'Edit Product',
        allItems: 'All Items',
        emptyCart: 'Cart is empty',
        address: 'Address',
        phone: 'Phone',
        receiptFooter: 'Receipt Footer',
        recommendedSize: 'Recommended size',
        invalidFileType: 'Please select a valid image file (PNG, JPG, GIF)',
        fileTooLarge: 'File size must be less than 2MB',
        logoUpdated: 'Logo updated successfully!',
        confirmRemoveLogo: 'Are you sure you want to remove the company logo?',
        logoRemoved: 'Logo removed successfully!',
        addUser: 'Add User',
        exportUsers: 'Export Users',
        saveSettings: 'Save Settings',
        resetSettings: 'Reset to Defaults',
        exportData: 'Export Data',
        importData: 'Import Data',
        createBackup: 'Create Backup',
        clearAllData: 'Clear All Data',
        lowStockReport: 'Low Stock Report',
        inventoryExported: 'Inventory exported successfully!',
        reportsExported: 'Reports exported successfully!',
        usersExported: 'Users exported successfully!',
        accessDenied: 'Access denied',
        confirmResetSettings: 'Are you sure you want to reset all settings to defaults?',
        settingsReset: 'Settings reset to defaults successfully!',
        dataExported: 'Data exported successfully!',
        confirmImportData: 'This will replace current data. Are you sure?',
        dataImported: 'Data imported successfully!',
        importError: 'Import error',
        confirmClearAllData: 'WARNING: This will delete all products and sales data!',
        confirmClearAllDataFinal: 'FINAL WARNING: This action cannot be undone!',
        allDataCleared: 'All data cleared successfully!',
        username: 'Username',
        active: 'Active',
        inactive: 'Inactive',
        status: 'Status',
        allStockLevels: 'All Stock Levels',
        lowStockOnly: 'Low Stock Only',
        outOfStockOnly: 'Out of Stock Only',
        search: 'Search',
        selectPaymentMethod: 'Please select a payment method',
        insufficientStock: 'Insufficient stock',
        available: 'Available',
        saleCompleted: 'Sale completed',
        cardNumber: 'Card Number',
        cardAccess: 'Card Access',
        categories: 'Categories',
        categoryManagement: 'Category Management',
        addCategory: 'Add Category',
        editCategory: 'Edit Category',
        categoryName: 'Category Name',
        charts: 'Charts',
        salesChart: 'Sales Chart',
        productChart: 'Product Chart',
        dailySales: 'Daily Sales',
        weeklySales: 'Weekly Sales',
        monthlySales: 'Monthly Sales',
        category: 'Category',
        addedSuccessfully: 'added successfully',
        updatedSuccessfully: 'updated successfully',
        successfully: 'successfully',
        activated: 'activated',
        deactivated: 'deactivated',
        cannotDeleteCategory: 'Cannot delete category',
        productsUsingCategory: 'products using this category',
        confirmDeleteCategory: 'Are you sure you want to delete category',
        deletedSuccessfully: 'deleted successfully',
        categoriesExported: 'Categories exported successfully',
        productsSold: 'Products Sold',
        tools: 'Tools',
        hardware: 'Hardware',
        construction: 'Construction',
        electrical: 'Electrical',
        plumbing: 'Plumbing',
        accessDenied: 'Access Denied',
        noPermissionCategories: 'You don\'t have permission to manage categories.',
        topSellingProducts: 'Top Selling Products',
        minStock: 'Min Stock',
        supplier: 'Supplier',
        adjustStock: 'Adjust Stock',
        id: 'ID',
        notAvailable: 'N/A',
        report: 'Report',
        fullName: 'Full Name',
        newPassword: 'New Password (leave blank to keep current)',
        englishName: 'English Name',
        arabicName: 'Arabic Name',
        frenchName: 'French Name',
        spanishName: 'Spanish Name',
        requested: 'Requested',
        outOfStock: 'Out of Stock',
        remaining: 'remaining',
        andMore: 'and {0} more',
        time: 'Time',
        items: 'Items',
        completeSale: 'Complete Sale',
        printBarcode: 'Print Barcode',
        generateBarcode: 'Generate Barcode',
        barcodeGenerated: 'Barcode generated and ready to print',
        noBarcodeFound: 'No barcode available for this product',
        bulkBarcodePrint: 'Bulk Barcode Print',
        selectProductsForBarcode: 'Select products to print barcodes',
        printSelectedBarcodes: 'Print Selected Barcodes',
        quantityPerProduct: 'Quantity per product',
        selectAll: 'Select All',
        deselectAll: 'Deselect All',
        selectWithoutBarcode: 'Select Without Barcode',
        selectAtLeastOneProduct: 'Please select at least one product',
        products: 'products',
        name: 'Name',
        actions: 'Actions',
        adminOnlySettings: 'System settings can only be modified by administrators.',
        contactAdministrator: 'Please contact your system administrator for changes.',
        unitPrice: 'Unit Price',
        qty: 'Qty',
        managerAuthRequired: 'Manager Authorization Required',
        managerAuthMessage: 'This action requires manager or administrator authorization.',
        enterManagerUsername: 'Enter manager username',
        enterManagerPassword: 'Enter manager password',
        authorize: 'Authorize',
        pleaseEnterCredentials: 'Please enter username and password',
        invalidManagerCredentials: 'Invalid manager credentials',
        confirmClearCart: 'Are you sure you want to clear the cart',
        cartCleared: 'Cart cleared successfully',
        authorizedBy: 'Authorized by',
        pleaseSelectPayment: 'Please select a payment method',
        saleCompleted: 'Sale Completed',
        receiptNumber: 'Receipt #',
        thankYou: 'Thank you for your business',
        quickCash: 'Quick Cash',
        quickCard: 'Quick Card',
        printQuotation: 'Print Quotation',
        quotation: 'Quotation',
        quotationNumber: 'Quotation #',
        validUntil: 'Valid Until',
        quotationNote: 'This is a quotation only. No payment has been processed.',
        quotationFooter: 'Thank you for considering our services',
        preparedBy: 'Prepared By',
        status: 'Status',
        pending: 'Pending',
        item: 'Item',
        note: 'Note',
        generatedOn: 'Generated On',
        noProductsFound: 'No products found',
        tryDifferentCategory: 'Try selecting a different category',
        regular: 'Regular',
        multiPriceOptions: 'Multi-Price Options',
        optional: 'Optional',
        wholesalePrice: 'Wholesale Price',
        retailPrice: 'Retail Price',
        vipPrice: 'VIP Price',
        bulkPrice: 'Bulk Price',
        priceType: 'Price Type',
        selectPriceType: 'Select Price Type',
        cannotAddMore: 'Cannot add more',
        onlyInStock: 'Only in stock',
        product: 'Product',
        each: 'each',
        scan: 'Scan',
        priceTypeChanged: 'Price type changed to',
        editQuantity: 'Edit quantity',
        removeItem: 'Remove item',
        invalidQuantity: 'Invalid quantity. Please enter a valid number.'
    },
    ar: {
        welcome: 'مرحباً بـ MyPOS',
        categories: 'الفئات',
        products: 'المنتجات',
        currentOrder: 'الطلب الحالي',
        subtotal: 'المجموع الفرعي',
        tax: 'الضريبة',
        total: 'المجموع',
        clearCart: 'مسح السلة',
        checkout: 'الدفع',
        emptyCart: 'لا توجد عناصر في السلة',
        allItems: 'جميع العناصر',
        food: 'طعام',
        drinks: 'مشروبات',
        snacks: 'وجبات خفيفة',
        cashier: 'أمين الصندوق',
        admin: 'مدير',
        manager: 'مدير',
        login: 'تسجيل الدخول',
        logout: 'تسجيل الخروج',
        username: 'اسم المستخدم',
        password: 'كلمة المرور',
        lowStock: 'تنبيه مخزون منخفض',
        printReceipt: 'طباعة الإيصال',
        reports: 'التقارير',
        inventory: 'المخزون',
        settings: 'الإعدادات',
        currency: 'العملة',
        language: 'اللغة',
        sales: 'المبيعات',
        dashboard: 'لوحة التحكم',
        users: 'المستخدمون',
        addProduct: 'إضافة منتج',
        editProduct: 'تعديل منتج',
        deleteProduct: 'حذف منتج',
        stock: 'المخزون',
        price: 'السعر',
        barcode: 'الباركود',
        category: 'الفئة',
        save: 'حفظ',
        cancel: 'إلغاء',
        delete: 'حذف',
        edit: 'تعديل',
        add: 'إضافة',
        search: 'بحث',
        filter: 'تصفية',
        export: 'تصدير',
        import: 'استيراد',
        backup: 'نسخ احتياطي',
        restore: 'استعادة',
        dinar: 'دينار جزائري',
        invoice: 'فاتورة',
        receipt: 'إيصال',
        printInvoice: 'طباعة فاتورة',
        lowStockReport: 'تقرير المخزون المنخفض',
        expiredItems: 'المواد المنتهية الصلاحية',
        printLowStock: 'طباعة المخزون المنخفض',
        printExpired: 'طباعة المنتهية الصلاحية',
        productImage: 'صورة المنتج',
        uploadImage: 'رفع صورة',
        changeImage: 'تغيير الصورة',
        removeImage: 'إزالة الصورة',
        expiryDate: 'تاريخ انتهاء الصلاحية',
        expired: 'منتهي الصلاحية',
        nearExpiry: 'قريب من انتهاء الصلاحية',
        supplier: 'المورد',
        cost: 'التكلفة',
        profit: 'الربح',
        margin: 'هامش الربح',
        todaysSales: 'مبيعات اليوم',
        thisWeek: 'هذا الأسبوع',
        thisMonth: 'هذا الشهر',
        totalProducts: 'إجمالي المنتجات',
        transactions: 'المعاملات',
        averageTransaction: 'متوسط المعاملة',
        topSellingProducts: 'المنتجات الأكثر مبيعاً',
        cashierPerformance: 'أداء أمناء الصندوق',
        recentSales: 'المبيعات الأخيرة',
        dailyReport: 'التقرير اليومي',
        weeklyReport: 'التقرير الأسبوعي',
        monthlyReport: 'التقرير الشهري',
        salesReport: 'تقرير المبيعات',
        inventoryReport: 'تقرير المخزون',
        profitReport: 'تقرير الأرباح',
        taxReport: 'تقرير الضرائب',
        customerReceipt: 'إيصال العميل',
        businessInvoice: 'فاتورة تجارية',
        companyInfo: 'معلومات الشركة',
        customerInfo: 'معلومات العميل',
        itemsNeedRestocking: 'عناصر تحتاج إعادة تخزين',
        activeProducts: 'منتجات نشطة',
        outOfStock: 'نفد من المخزون',
        inStock: 'متوفر في المخزون',
        lowStock: 'مخزون منخفض',
        goodStock: 'مخزون جيد',
        description: 'الوصف',
        quantity: 'الكمية',
        time: 'الوقت',
        date: 'التاريخ',
        summary: 'الملخص',
        urgentAction: 'إجراء عاجل مطلوب',
        restockImmediately: 'أعد تخزين هذه العناصر فوراً',
        productName: 'اسم المنتج',
        currentStock: 'المخزون الحالي',
        minimumStock: 'الحد الأدنى للمخزون',
        generatedBy: 'تم إنشاؤه بواسطة',
        printedOn: 'طُبع في',
        noLowStockItems: 'لا توجد عناصر مخزون منخفض',
        noExpiredItems: 'لا توجد عناصر منتهية الصلاحية أو قريبة من انتهاء الصلاحية',
        expiryStatus: 'حالة انتهاء الصلاحية',
        daysUntilExpiry: 'أيام حتى انتهاء الصلاحية',
        daysOverdue: 'أيام متأخرة',
        scanBarcode: 'مسح الباركود',
        enterBarcode: 'أدخل الباركود',
        useCamera: 'استخدم الكاميرا',
        manualEntry: 'إدخال يدوي',
        connectScanner: 'ربط الماسح',
        pointCameraAtBarcode: 'وجه الكاميرا نحو الباركود',
        productAdded: 'تم إضافة المنتج',
        productNotFound: 'المنتج غير موجود',
        scannerConnected: 'الماسح متصل',
        scannerDisconnected: 'الماسح غير متصل',
        cameraAccessError: 'تم رفض الوصول للكاميرا أو غير متاحة',
        totalSales: 'إجمالي المبيعات',
        totalTransactions: 'إجمالي المعاملات',
        paymentMethod: 'طريقة الدفع',
        companyLogo: 'شعار الشركة',
        uploadLogo: 'رفع شعار',
        removeLogo: 'إزالة الشعار',
        companySettings: 'إعدادات الشركة',
        logoSettings: 'إعدادات الشعار',
        addProduct: 'إضافة منتج',
        editProduct: 'تعديل المنتج',
        allItems: 'جميع العناصر',
        emptyCart: 'السلة فارغة',
        address: 'العنوان',
        phone: 'الهاتف',
        receiptFooter: 'تذييل الإيصال',
        recommendedSize: 'الحجم المُوصى به',
        invalidFileType: 'يرجى اختيار ملف صورة صالح (PNG, JPG, GIF)',
        fileTooLarge: 'يجب أن يكون حجم الملف أقل من 2 ميجابايت',
        logoUpdated: 'تم تحديث الشعار بنجاح!',
        confirmRemoveLogo: 'هل أنت متأكد من أنك تريد إزالة شعار الشركة؟',
        logoRemoved: 'تم حذف الشعار بنجاح!',
        addUser: 'إضافة مستخدم',
        exportUsers: 'تصدير المستخدمين',
        saveSettings: 'حفظ الإعدادات',
        resetSettings: 'إعادة تعيين للافتراضي',
        exportData: 'تصدير البيانات',
        importData: 'استيراد البيانات',
        createBackup: 'إنشاء نسخة احتياطية',
        clearAllData: 'مسح جميع البيانات',
        lowStockReport: 'تقرير المخزون المنخفض',
        inventoryExported: 'تم تصدير المخزون بنجاح!',
        reportsExported: 'تم تصدير التقارير بنجاح!',
        usersExported: 'تم تصدير المستخدمين بنجاح!',
        accessDenied: 'تم رفض الوصول',
        confirmResetSettings: 'هل أنت متأكد من أنك تريد إعادة تعيين جميع الإعدادات للافتراضي؟',
        settingsReset: 'تم إعادة تعيين الإعدادات للافتراضي بنجاح!',
        dataExported: 'تم تصدير البيانات بنجاح!',
        confirmImportData: 'سيؤدي هذا إلى استبدال البيانات الحالية. هل أنت متأكد؟',
        dataImported: 'تم استيراد البيانات بنجاح!',
        importError: 'خطأ في الاستيراد',
        confirmClearAllData: 'تحذير: سيؤدي هذا إلى حذف جميع المنتجات وبيانات المبيعات!',
        confirmClearAllDataFinal: 'تحذير أخير: لا يمكن التراجع عن هذا الإجراء!',
        allDataCleared: 'تم مسح جميع البيانات بنجاح!',
        username: 'اسم المستخدم',
        active: 'نشط',
        inactive: 'غير نشط',
        status: 'الحالة',
        allStockLevels: 'جميع مستويات المخزون',
        lowStockOnly: 'المخزون المنخفض فقط',
        outOfStockOnly: 'نفد من المخزون فقط',
        search: 'بحث',
        selectPaymentMethod: 'يرجى اختيار طريقة الدفع',
        insufficientStock: 'مخزون غير كافي',
        available: 'متوفر',
        saleCompleted: 'تمت عملية البيع',
        cardNumber: 'رقم البطاقة',
        cardAccess: 'الوصول بالبطاقة',
        categories: 'الفئات',
        categoryManagement: 'إدارة الفئات',
        addCategory: 'إضافة فئة',
        editCategory: 'تعديل الفئة',
        categoryName: 'اسم الفئة',
        charts: 'الرسوم البيانية',
        salesChart: 'رسم بياني للمبيعات',
        productChart: 'رسم بياني للمنتجات',
        dailySales: 'المبيعات اليومية',
        weeklySales: 'المبيعات الأسبوعية',
        monthlySales: 'المبيعات الشهرية',
        category: 'الفئة',
        addedSuccessfully: 'تمت الإضافة بنجاح',
        updatedSuccessfully: 'تم التحديث بنجاح',
        successfully: 'بنجاح',
        activated: 'تم التفعيل',
        deactivated: 'تم إلغاء التفعيل',
        cannotDeleteCategory: 'لا يمكن حذف الفئة',
        productsUsingCategory: 'منتجات تستخدم هذه الفئة',
        confirmDeleteCategory: 'هل أنت متأكد من أنك تريد حذف الفئة',
        deletedSuccessfully: 'تم الحذف بنجاح',
        categoriesExported: 'تم تصدير الفئات بنجاح',
        productsSold: 'المنتجات المباعة',
        tools: 'أدوات',
        hardware: 'أجهزة',
        construction: 'بناء',
        electrical: 'كهربائي',
        plumbing: 'سباكة',
        accessDenied: 'تم رفض الوصول',
        noPermissionCategories: 'ليس لديك إذن لإدارة الفئات.',
        topSellingProducts: 'المنتجات الأكثر مبيعاً',
        minStock: 'الحد الأدنى للمخزون',
        supplier: 'المورد',
        adjustStock: 'تعديل المخزون',
        id: 'المعرف',
        notAvailable: 'غير متوفر',
        report: 'تقرير',
        fullName: 'الاسم الكامل',
        newPassword: 'كلمة مرور جديدة (اتركها فارغة للاحتفاظ بالحالية)',
        englishName: 'الاسم الإنجليزي',
        arabicName: 'الاسم العربي',
        frenchName: 'الاسم الفرنسي',
        spanishName: 'الاسم الإسباني',
        requested: 'مطلوب',
        outOfStock: 'نفد المخزون',
        remaining: 'متبقي',
        andMore: 'و {0} أكثر',
        time: 'الوقت',
        items: 'العناصر',
        completeSale: 'إتمام البيع',
        printBarcode: 'طباعة الباركود',
        generateBarcode: 'إنشاء باركود',
        barcodeGenerated: 'تم إنشاء الباركود وهو جاهز للطباعة',
        noBarcodeFound: 'لا يوجد باركود متاح لهذا المنتج',
        bulkBarcodePrint: 'طباعة باركود مجمعة',
        selectProductsForBarcode: 'اختر المنتجات لطباعة الباركود',
        printSelectedBarcodes: 'طباعة الباركود المحددة',
        quantityPerProduct: 'الكمية لكل منتج',
        selectAll: 'تحديد الكل',
        deselectAll: 'إلغاء تحديد الكل',
        selectWithoutBarcode: 'تحديد بدون باركود',
        selectAtLeastOneProduct: 'يرجى تحديد منتج واحد على الأقل',
        products: 'منتجات',
        name: 'الاسم',
        actions: 'الإجراءات',
        adminOnlySettings: 'إعدادات النظام يمكن تعديلها من قبل المديرين فقط.',
        contactAdministrator: 'يرجى الاتصال بمدير النظام لإجراء التغييرات.',
        unitPrice: 'سعر الوحدة',
        qty: 'الكمية',
        managerAuthRequired: 'مطلوب تفويض المدير',
        managerAuthMessage: 'هذا الإجراء يتطلب تفويض المدير أو المسؤول.',
        enterManagerUsername: 'أدخل اسم مستخدم المدير',
        enterManagerPassword: 'أدخل كلمة مرور المدير',
        authorize: 'تفويض',
        pleaseEnterCredentials: 'يرجى إدخال اسم المستخدم وكلمة المرور',
        invalidManagerCredentials: 'بيانات اعتماد المدير غير صحيحة',
        confirmClearCart: 'هل أنت متأكد من أنك تريد مسح السلة',
        cartCleared: 'تم مسح السلة بنجاح',
        authorizedBy: 'مفوض من قبل',
        pleaseSelectPayment: 'يرجى اختيار طريقة الدفع',
        saleCompleted: 'تمت عملية البيع',
        receiptNumber: 'رقم الإيصال',
        thankYou: 'شكراً لك على تعاملك معنا',
        quickCash: 'دفع نقدي سريع',
        quickCard: 'دفع بالبطاقة سريع',
        printQuotation: 'طباعة عرض سعر',
        quotation: 'عرض سعر',
        quotationNumber: 'رقم عرض السعر',
        validUntil: 'صالح حتى',
        quotationNote: 'هذا عرض سعر فقط. لم يتم معالجة أي دفعة.',
        quotationFooter: 'شكراً لك على النظر في خدماتنا',
        preparedBy: 'أعده',
        status: 'الحالة',
        pending: 'قيد الانتظار',
        item: 'الصنف',
        note: 'ملاحظة',
        generatedOn: 'تم إنشاؤه في',
        noProductsFound: 'لم يتم العثور على منتجات',
        tryDifferentCategory: 'جرب اختيار فئة مختلفة',
        regular: 'عادي',
        multiPriceOptions: 'خيارات الأسعار المتعددة',
        optional: 'اختياري',
        wholesalePrice: 'سعر الجملة',
        retailPrice: 'سعر التجزئة',
        vipPrice: 'سعر كبار الشخصيات',
        bulkPrice: 'سعر الكمية',
        priceType: 'نوع السعر',
        selectPriceType: 'اختر نوع السعر',
        cannotAddMore: 'لا يمكن إضافة المزيد',
        onlyInStock: 'متوفر فقط',
        product: 'المنتج',
        each: 'للقطعة',
        scan: 'مسح',
        priceTypeChanged: 'تم تغيير نوع السعر إلى',
        editQuantity: 'تعديل الكمية',
        removeItem: 'إزالة العنصر',
        invalidQuantity: 'كمية غير صحيحة. يرجى إدخال رقم صحيح.'
    },
    fr: {
        welcome: 'Bienvenue à MyPOS',
        categories: 'Catégories',
        products: 'Produits',
        currentOrder: 'Commande Actuelle',
        subtotal: 'Sous-total',
        tax: 'Taxe',
        total: 'Total',
        clearCart: 'Vider le Panier',
        checkout: 'Paiement',
        emptyCart: 'Aucun article dans le panier',
        allItems: 'Tous les Articles',
        food: 'Nourriture',
        drinks: 'Boissons',
        snacks: 'Collations',
        cashier: 'Caissier',
        admin: 'Administrateur',
        manager: 'Gestionnaire',
        login: 'Connexion',
        logout: 'Déconnexion',
        username: 'Nom d\'utilisateur',
        password: 'Mot de passe',
        lowStock: 'Alerte Stock Faible',
        printReceipt: 'Imprimer Reçu',
        reports: 'Rapports',
        inventory: 'Inventaire',
        settings: 'Paramètres',
        currency: 'Devise',
        language: 'Langue',
        sales: 'Ventes',
        dashboard: 'Tableau de Bord',
        users: 'Utilisateurs',
        addProduct: 'Ajouter Produit',
        editProduct: 'Modifier Produit',
        deleteProduct: 'Supprimer Produit',
        stock: 'Stock',
        price: 'Prix',
        barcode: 'Code-barres',
        category: 'Catégorie',
        save: 'Enregistrer',
        cancel: 'Annuler',
        delete: 'Supprimer',
        edit: 'Modifier',
        add: 'Ajouter',
        search: 'Rechercher',
        filter: 'Filtrer',
        export: 'Exporter',
        import: 'Importer',
        backup: 'Sauvegarde',
        restore: 'Restaurer',
        invoice: 'Facture',
        receipt: 'Reçu',
        printInvoice: 'Imprimer Facture',
        lowStockReport: 'Rapport Stock Faible',
        expiredItems: 'Articles Expirés',
        printLowStock: 'Imprimer Stock Faible',
        printExpired: 'Imprimer Expirés',
        productImage: 'Image Produit',
        uploadImage: 'Télécharger Image',
        changeImage: 'Changer Image',
        removeImage: 'Supprimer Image',
        expiryDate: 'Date d\'Expiration',
        expired: 'Expiré',
        nearExpiry: 'Proche Expiration',
        supplier: 'Fournisseur',
        cost: 'Coût',
        profit: 'Profit',
        margin: 'Marge',
        todaysSales: 'Ventes d\'Aujourd\'hui',
        thisWeek: 'Cette Semaine',
        thisMonth: 'Ce Mois',
        totalProducts: 'Total Produits',
        transactions: 'Transactions',
        averageTransaction: 'Transaction Moyenne',
        topSellingProducts: 'Produits les Plus Vendus',
        cashierPerformance: 'Performance Caissiers',
        recentSales: 'Ventes Récentes',
        dailyReport: 'Rapport Quotidien',
        weeklyReport: 'Rapport Hebdomadaire',
        monthlyReport: 'Rapport Mensuel',
        salesReport: 'Rapport des Ventes',
        inventoryReport: 'Rapport d\'Inventaire',
        profitReport: 'Rapport de Profit',
        taxReport: 'Rapport de Taxes',
        customerReceipt: 'Reçu Client',
        businessInvoice: 'Facture Commerciale',
        companyInfo: 'Informations Société',
        customerInfo: 'Informations Client',
        itemsNeedRestocking: 'articles nécessitent réapprovisionnement',
        activeProducts: 'produits actifs',
        outOfStock: 'Rupture de Stock',
        inStock: 'En Stock',
        lowStock: 'Stock Faible',
        goodStock: 'Bon Stock',
        description: 'Description',
        quantity: 'Quantité',
        time: 'Heure',
        date: 'Date',
        summary: 'Résumé',
        urgentAction: 'Action Urgente Requise',
        restockImmediately: 'Réapprovisionner ces articles immédiatement',
        productName: 'Nom du Produit',
        currentStock: 'Stock Actuel',
        minimumStock: 'Stock Minimum',
        generatedBy: 'Généré par',
        printedOn: 'Imprimé le',
        noLowStockItems: 'Aucun article en stock faible trouvé',
        noExpiredItems: 'Aucun article expiré ou proche de l\'expiration trouvé',
        expiryStatus: 'Statut d\'Expiration',
        daysUntilExpiry: 'Jours Jusqu\'à Expiration',
        daysOverdue: 'Jours de Retard',
        totalSales: 'Ventes Totales',
        totalTransactions: 'Transactions Totales',
        paymentMethod: 'Méthode de Paiement',
        companyLogo: 'Logo de l\'Entreprise',
        uploadLogo: 'Télécharger Logo',
        removeLogo: 'Supprimer Logo',
        companySettings: 'Paramètres Entreprise',
        logoSettings: 'Paramètres Logo',
        addProduct: 'Ajouter Produit',
        editProduct: 'Modifier Produit',
        allItems: 'Tous les Articles',
        emptyCart: 'Panier vide',
        address: 'Adresse',
        phone: 'Téléphone',
        receiptFooter: 'Pied de Page Reçu',
        recommendedSize: 'Taille recommandée',
        invalidFileType: 'Veuillez sélectionner un fichier image valide (PNG, JPG, GIF)',
        fileTooLarge: 'La taille du fichier doit être inférieure à 2 Mo',
        logoUpdated: 'Logo mis à jour avec succès!',
        confirmRemoveLogo: 'Êtes-vous sûr de vouloir supprimer le logo de l\'entreprise?',
        logoRemoved: 'Logo supprimé avec succès!',
        addUser: 'Ajouter Utilisateur',
        exportUsers: 'Exporter Utilisateurs',
        saveSettings: 'Sauvegarder Paramètres',
        resetSettings: 'Réinitialiser par Défaut',
        exportData: 'Exporter Données',
        importData: 'Importer Données',
        createBackup: 'Créer Sauvegarde',
        clearAllData: 'Effacer Toutes Données',
        lowStockReport: 'Rapport Stock Faible',
        inventoryExported: 'Inventaire exporté avec succès!',
        reportsExported: 'Rapports exportés avec succès!',
        usersExported: 'Utilisateurs exportés avec succès!',
        accessDenied: 'Accès refusé',
        confirmResetSettings: 'Êtes-vous sûr de vouloir réinitialiser tous les paramètres par défaut?',
        settingsReset: 'Paramètres réinitialisés par défaut avec succès!',
        dataExported: 'Données exportées avec succès!',
        confirmImportData: 'Cela remplacera les données actuelles. Êtes-vous sûr?',
        dataImported: 'Données importées avec succès!',
        importError: 'Erreur d\'importation',
        confirmClearAllData: 'ATTENTION: Cela supprimera tous les produits et données de vente!',
        confirmClearAllDataFinal: 'DERNIER AVERTISSEMENT: Cette action ne peut pas être annulée!',
        allDataCleared: 'Toutes les données effacées avec succès!',
        username: 'Nom d\'utilisateur',
        active: 'Actif',
        inactive: 'Inactif',
        status: 'Statut',
        allStockLevels: 'Tous Niveaux de Stock',
        lowStockOnly: 'Stock Faible Seulement',
        outOfStockOnly: 'Rupture de Stock Seulement',
        search: 'Rechercher',
        selectPaymentMethod: 'Veuillez sélectionner un mode de paiement',
        insufficientStock: 'Stock insuffisant',
        available: 'Disponible',
        saleCompleted: 'Vente terminée',
        cardNumber: 'Numéro de Carte',
        cardAccess: 'Accès par Carte',
        categories: 'Catégories',
        categoryManagement: 'Gestion des Catégories',
        addCategory: 'Ajouter Catégorie',
        editCategory: 'Modifier Catégorie',
        categoryName: 'Nom de Catégorie',
        charts: 'Graphiques',
        salesChart: 'Graphique des Ventes',
        productChart: 'Graphique des Produits',
        dailySales: 'Ventes Quotidiennes',
        weeklySales: 'Ventes Hebdomadaires',
        monthlySales: 'Ventes Mensuelles',
        category: 'Catégorie',
        addedSuccessfully: 'ajouté avec succès',
        updatedSuccessfully: 'mis à jour avec succès',
        successfully: 'avec succès',
        activated: 'activé',
        deactivated: 'désactivé',
        cannotDeleteCategory: 'Impossible de supprimer la catégorie',
        productsUsingCategory: 'produits utilisant cette catégorie',
        confirmDeleteCategory: 'Êtes-vous sûr de vouloir supprimer la catégorie',
        deletedSuccessfully: 'supprimé avec succès',
        categoriesExported: 'Catégories exportées avec succès',
        productsSold: 'Produits Vendus',
        tools: 'Outils',
        hardware: 'Quincaillerie',
        construction: 'Construction',
        electrical: 'Électrique',
        plumbing: 'Plomberie',
        accessDenied: 'Accès Refusé',
        noPermissionCategories: 'Vous n\'avez pas la permission de gérer les catégories.',
        topSellingProducts: 'Produits les Plus Vendus',
        minStock: 'Stock Minimum',
        supplier: 'Fournisseur',
        adjustStock: 'Ajuster Stock',
        id: 'ID',
        notAvailable: 'N/D',
        report: 'Rapport',
        fullName: 'Nom Complet',
        newPassword: 'Nouveau Mot de Passe (laisser vide pour conserver actuel)',
        englishName: 'Nom Anglais',
        arabicName: 'Nom Arabe',
        frenchName: 'Nom Français',
        spanishName: 'Nom Espagnol',
        requested: 'Demandé',
        outOfStock: 'Rupture de Stock',
        remaining: 'restant',
        andMore: 'et {0} de plus',
        time: 'Heure',
        items: 'Articles',
        completeSale: 'Finaliser Vente',
        printBarcode: 'Imprimer Code-Barres',
        generateBarcode: 'Générer Code-Barres',
        barcodeGenerated: 'Code-barres généré et prêt à imprimer',
        noBarcodeFound: 'Aucun code-barres disponible pour ce produit',
        bulkBarcodePrint: 'Impression Code-Barres en Lot',
        selectProductsForBarcode: 'Sélectionner produits pour imprimer codes-barres',
        printSelectedBarcodes: 'Imprimer Codes-Barres Sélectionnés',
        quantityPerProduct: 'Quantité par produit',
        selectAll: 'Tout Sélectionner',
        deselectAll: 'Tout Désélectionner',
        selectWithoutBarcode: 'Sélectionner Sans Code-Barres',
        selectAtLeastOneProduct: 'Veuillez sélectionner au moins un produit',
        products: 'produits',
        name: 'Nom',
        actions: 'Actions',
        adminOnlySettings: 'Les paramètres système ne peuvent être modifiés que par les administrateurs.',
        contactAdministrator: 'Veuillez contacter votre administrateur système pour les modifications.',
        unitPrice: 'Prix Unitaire',
        qty: 'Qté',
        managerAuthRequired: 'Autorisation Gestionnaire Requise',
        managerAuthMessage: 'Cette action nécessite une autorisation de gestionnaire ou administrateur.',
        enterManagerUsername: 'Entrez le nom d\'utilisateur du gestionnaire',
        enterManagerPassword: 'Entrez le mot de passe du gestionnaire',
        authorize: 'Autoriser',
        pleaseEnterCredentials: 'Veuillez entrer le nom d\'utilisateur et le mot de passe',
        invalidManagerCredentials: 'Identifiants gestionnaire invalides',
        confirmClearCart: 'Êtes-vous sûr de vouloir vider le panier',
        cartCleared: 'Panier vidé avec succès',
        authorizedBy: 'Autorisé par',
        pleaseSelectPayment: 'Veuillez sélectionner un mode de paiement',
        saleCompleted: 'Vente Terminée',
        receiptNumber: 'Reçu #',
        thankYou: 'Merci pour votre confiance',
        quickCash: 'Paiement Rapide',
        quickCard: 'Carte Rapide',
        printQuotation: 'Imprimer Devis',
        quotation: 'Devis',
        quotationNumber: 'Devis #',
        validUntil: 'Valide Jusqu\'au',
        quotationNote: 'Ceci est un devis seulement. Aucun paiement n\'a été traité.',
        quotationFooter: 'Merci de considérer nos services',
        preparedBy: 'Préparé Par',
        status: 'Statut',
        pending: 'En Attente',
        item: 'Article',
        note: 'Note',
        generatedOn: 'Généré Le',
        noProductsFound: 'Aucun produit trouvé',
        tryDifferentCategory: 'Essayez de sélectionner une catégorie différente',
        regular: 'Régulier',
        multiPriceOptions: 'Options de Prix Multiples',
        optional: 'Optionnel',
        wholesalePrice: 'Prix de Gros',
        retailPrice: 'Prix de Détail',
        vipPrice: 'Prix VIP',
        bulkPrice: 'Prix en Vrac',
        priceType: 'Type de Prix',
        selectPriceType: 'Sélectionner le Type de Prix',
        cannotAddMore: 'Impossible d\'ajouter plus',
        onlyInStock: 'Seulement en stock',
        product: 'Produit',
        each: 'chacun',
        scan: 'Scanner',
        priceTypeChanged: 'Type de prix changé en',
        editQuantity: 'Modifier la quantité',
        removeItem: 'Supprimer l\'article',
        invalidQuantity: 'Quantité invalide. Veuillez entrer un nombre valide.'
    },
    es: {
        welcome: 'Bienvenido a MyPOS',
        categories: 'Categorías',
        products: 'Productos',
        currentOrder: 'Pedido Actual',
        subtotal: 'Subtotal',
        tax: 'Impuesto',
        total: 'Total',
        clearCart: 'Limpiar Carrito',
        checkout: 'Pagar',
        emptyCart: 'No hay artículos en el carrito',
        allItems: 'Todos los Artículos',
        food: 'Comida',
        drinks: 'Bebidas',
        snacks: 'Aperitivos',
        cashier: 'Cajero',
        admin: 'Administrador',
        manager: 'Gerente',
        login: 'Iniciar Sesión',
        logout: 'Cerrar Sesión',
        username: 'Usuario',
        password: 'Contraseña',
        lowStock: 'Alerta Stock Bajo',
        printReceipt: 'Imprimir Recibo',
        reports: 'Informes',
        inventory: 'Inventario',
        settings: 'Configuración',
        currency: 'Moneda',
        language: 'Idioma',
        sales: 'Ventas',
        dashboard: 'Panel de Control',
        users: 'Usuarios',
        addProduct: 'Agregar Producto',
        editProduct: 'Editar Producto',
        deleteProduct: 'Eliminar Producto',
        stock: 'Stock',
        price: 'Precio',
        barcode: 'Código de Barras',
        category: 'Categoría',
        save: 'Guardar',
        cancel: 'Cancelar',
        delete: 'Eliminar',
        edit: 'Editar',
        add: 'Agregar',
        search: 'Buscar',
        filter: 'Filtrar',
        export: 'Exportar',
        import: 'Importar',
        backup: 'Respaldo',
        restore: 'Restaurar',
        invoice: 'Factura',
        receipt: 'Recibo',
        printInvoice: 'Imprimir Factura',
        lowStockReport: 'Reporte Stock Bajo',
        expiredItems: 'Artículos Vencidos',
        printLowStock: 'Imprimir Stock Bajo',
        printExpired: 'Imprimir Vencidos',
        productImage: 'Imagen Producto',
        uploadImage: 'Subir Imagen',
        changeImage: 'Cambiar Imagen',
        removeImage: 'Quitar Imagen',
        expiryDate: 'Fecha de Vencimiento',
        expired: 'Vencido',
        nearExpiry: 'Próximo a Vencer',
        supplier: 'Proveedor',
        cost: 'Costo',
        profit: 'Ganancia',
        margin: 'Margen',
        todaysSales: 'Ventas de Hoy',
        thisWeek: 'Esta Semana',
        thisMonth: 'Este Mes',
        totalProducts: 'Total Productos',
        transactions: 'Transacciones',
        averageTransaction: 'Transacción Promedio',
        topSellingProducts: 'Productos Más Vendidos',
        cashierPerformance: 'Rendimiento Cajeros',
        recentSales: 'Ventas Recientes',
        dailyReport: 'Reporte Diario',
        weeklyReport: 'Reporte Semanal',
        monthlyReport: 'Reporte Mensual',
        salesReport: 'Reporte de Ventas',
        inventoryReport: 'Reporte de Inventario',
        profitReport: 'Reporte de Ganancias',
        taxReport: 'Reporte de Impuestos',
        customerReceipt: 'Recibo Cliente',
        businessInvoice: 'Factura Comercial',
        companyInfo: 'Información Empresa',
        customerInfo: 'Información Cliente',
        itemsNeedRestocking: 'artículos necesitan reabastecimiento',
        activeProducts: 'productos activos',
        outOfStock: 'Sin Stock',
        inStock: 'En Stock',
        lowStock: 'Stock Bajo',
        goodStock: 'Buen Stock',
        description: 'Descripción',
        quantity: 'Cantidad',
        time: 'Hora',
        date: 'Fecha',
        summary: 'Resumen',
        urgentAction: 'Acción Urgente Requerida',
        restockImmediately: 'Reabastecer estos artículos inmediatamente',
        productName: 'Nombre del Producto',
        currentStock: 'Stock Actual',
        minimumStock: 'Stock Mínimo',
        generatedBy: 'Generado por',
        printedOn: 'Impreso el',
        noLowStockItems: 'No se encontraron artículos con stock bajo',
        noExpiredItems: 'No se encontraron artículos vencidos o próximos a vencer',
        expiryStatus: 'Estado de Vencimiento',
        daysUntilExpiry: 'Días Hasta Vencimiento',
        daysOverdue: 'Días Vencidos',
        totalSales: 'Ventas Totales',
        totalTransactions: 'Transacciones Totales',
        paymentMethod: 'Método de Pago',
        companyLogo: 'Logo de la Empresa',
        uploadLogo: 'Subir Logo',
        removeLogo: 'Quitar Logo',
        companySettings: 'Configuración Empresa',
        logoSettings: 'Configuración Logo',
        addProduct: 'Agregar Producto',
        editProduct: 'Editar Producto',
        allItems: 'Todos los Artículos',
        emptyCart: 'Carrito vacío',
        address: 'Dirección',
        phone: 'Teléfono',
        receiptFooter: 'Pie de Página Recibo',
        recommendedSize: 'Tamaño recomendado',
        invalidFileType: 'Por favor seleccione un archivo de imagen válido (PNG, JPG, GIF)',
        fileTooLarge: 'El tamaño del archivo debe ser menor a 2MB',
        logoUpdated: '¡Logo actualizado exitosamente!',
        confirmRemoveLogo: '¿Está seguro de que desea eliminar el logo de la empresa?',
        logoRemoved: '¡Logo eliminado exitosamente!',
        addUser: 'Agregar Usuario',
        exportUsers: 'Exportar Usuarios',
        saveSettings: 'Guardar Configuración',
        resetSettings: 'Restablecer por Defecto',
        exportData: 'Exportar Datos',
        importData: 'Importar Datos',
        createBackup: 'Crear Respaldo',
        clearAllData: 'Limpiar Todos los Datos',
        lowStockReport: 'Reporte Stock Bajo',
        inventoryExported: '¡Inventario exportado exitosamente!',
        reportsExported: '¡Reportes exportados exitosamente!',
        usersExported: '¡Usuarios exportados exitosamente!',
        accessDenied: 'Acceso denegado',
        confirmResetSettings: '¿Está seguro de que desea restablecer toda la configuración por defecto?',
        settingsReset: '¡Configuración restablecida por defecto exitosamente!',
        dataExported: '¡Datos exportados exitosamente!',
        confirmImportData: 'Esto reemplazará los datos actuales. ¿Está seguro?',
        dataImported: '¡Datos importados exitosamente!',
        importError: 'Error de importación',
        confirmClearAllData: 'ADVERTENCIA: ¡Esto eliminará todos los productos y datos de ventas!',
        confirmClearAllDataFinal: 'ADVERTENCIA FINAL: ¡Esta acción no se puede deshacer!',
        allDataCleared: '¡Todos los datos eliminados exitosamente!',
        username: 'Usuario',
        active: 'Activo',
        inactive: 'Inactivo',
        status: 'Estado',
        allStockLevels: 'Todos Niveles de Stock',
        lowStockOnly: 'Solo Stock Bajo',
        outOfStockOnly: 'Solo Sin Stock',
        search: 'Buscar',
        selectPaymentMethod: 'Por favor seleccione un método de pago',
        insufficientStock: 'Stock insuficiente',
        available: 'Disponible',
        saleCompleted: 'Venta completada',
        cardNumber: 'Número de Tarjeta',
        cardAccess: 'Acceso con Tarjeta',
        categories: 'Categorías',
        categoryManagement: 'Gestión de Categorías',
        addCategory: 'Agregar Categoría',
        editCategory: 'Editar Categoría',
        categoryName: 'Nombre de Categoría',
        charts: 'Gráficos',
        salesChart: 'Gráfico de Ventas',
        productChart: 'Gráfico de Productos',
        dailySales: 'Ventas Diarias',
        weeklySales: 'Ventas Semanales',
        monthlySales: 'Ventas Mensuales',
        category: 'Categoría',
        addedSuccessfully: 'agregado exitosamente',
        updatedSuccessfully: 'actualizado exitosamente',
        successfully: 'exitosamente',
        activated: 'activado',
        deactivated: 'desactivado',
        cannotDeleteCategory: 'No se puede eliminar la categoría',
        productsUsingCategory: 'productos usando esta categoría',
        confirmDeleteCategory: '¿Está seguro de que desea eliminar la categoría',
        deletedSuccessfully: 'eliminado exitosamente',
        categoriesExported: 'Categorías exportadas exitosamente',
        productsSold: 'Productos Vendidos',
        tools: 'Herramientas',
        hardware: 'Ferretería',
        construction: 'Construcción',
        electrical: 'Eléctrico',
        plumbing: 'Fontanería',
        accessDenied: 'Acceso Denegado',
        noPermissionCategories: 'No tienes permiso para gestionar categorías.',
        topSellingProducts: 'Productos Más Vendidos',
        minStock: 'Stock Mínimo',
        supplier: 'Proveedor',
        adjustStock: 'Ajustar Stock',
        id: 'ID',
        notAvailable: 'N/D',
        report: 'Reporte',
        fullName: 'Nombre Completo',
        newPassword: 'Nueva Contraseña (dejar en blanco para mantener actual)',
        englishName: 'Nombre en Inglés',
        arabicName: 'Nombre en Árabe',
        frenchName: 'Nombre en Francés',
        spanishName: 'Nombre en Español',
        requested: 'Solicitado',
        outOfStock: 'Agotado',
        remaining: 'restante',
        andMore: 'y {0} más',
        time: 'Hora',
        items: 'Artículos',
        completeSale: 'Completar Venta',
        printBarcode: 'Imprimir Código de Barras',
        generateBarcode: 'Generar Código de Barras',
        barcodeGenerated: 'Código de barras generado y listo para imprimir',
        noBarcodeFound: 'No hay código de barras disponible para este producto',
        bulkBarcodePrint: 'Impresión Masiva de Códigos',
        selectProductsForBarcode: 'Seleccionar productos para imprimir códigos',
        printSelectedBarcodes: 'Imprimir Códigos Seleccionados',
        quantityPerProduct: 'Cantidad por producto',
        selectAll: 'Seleccionar Todo',
        deselectAll: 'Deseleccionar Todo',
        selectWithoutBarcode: 'Seleccionar Sin Código',
        selectAtLeastOneProduct: 'Por favor seleccione al menos un producto',
        products: 'productos',
        name: 'Nombre',
        actions: 'Acciones',
        adminOnlySettings: 'La configuración del sistema solo puede ser modificada por administradores.',
        contactAdministrator: 'Por favor contacte a su administrador del sistema para cambios.',
        unitPrice: 'Precio Unitario',
        qty: 'Cant',
        managerAuthRequired: 'Autorización de Gerente Requerida',
        managerAuthMessage: 'Esta acción requiere autorización de gerente o administrador.',
        enterManagerUsername: 'Ingrese nombre de usuario del gerente',
        enterManagerPassword: 'Ingrese contraseña del gerente',
        authorize: 'Autorizar',
        pleaseEnterCredentials: 'Por favor ingrese usuario y contraseña',
        invalidManagerCredentials: 'Credenciales de gerente inválidas',
        confirmClearCart: '¿Está seguro de que desea limpiar el carrito',
        cartCleared: 'Carrito limpiado exitosamente',
        authorizedBy: 'Autorizado por',
        pleaseSelectPayment: 'Por favor seleccione un método de pago',
        saleCompleted: 'Venta Completada',
        receiptNumber: 'Recibo #',
        thankYou: 'Gracias por su compra',
        quickCash: 'Efectivo Rápido',
        quickCard: 'Tarjeta Rápida',
        printQuotation: 'Imprimir Cotización',
        quotation: 'Cotización',
        quotationNumber: 'Cotización #',
        validUntil: 'Válido Hasta',
        quotationNote: 'Esta es solo una cotización. No se ha procesado ningún pago.',
        quotationFooter: 'Gracias por considerar nuestros servicios',
        preparedBy: 'Preparado Por',
        status: 'Estado',
        pending: 'Pendiente',
        item: 'Artículo',
        note: 'Nota',
        generatedOn: 'Generado El',
        noProductsFound: 'No se encontraron productos',
        tryDifferentCategory: 'Intente seleccionar una categoría diferente',
        regular: 'Regular',
        multiPriceOptions: 'Opciones de Precios Múltiples',
        optional: 'Opcional',
        wholesalePrice: 'Precio Mayorista',
        retailPrice: 'Precio Minorista',
        vipPrice: 'Precio VIP',
        bulkPrice: 'Precio por Volumen',
        priceType: 'Tipo de Precio',
        selectPriceType: 'Seleccionar Tipo de Precio',
        cannotAddMore: 'No se puede agregar más',
        onlyInStock: 'Solo en stock',
        product: 'Producto',
        each: 'cada uno',
        scan: 'Escanear',
        priceTypeChanged: 'Tipo de precio cambiado a',
        editQuantity: 'Editar cantidad',
        removeItem: 'Eliminar artículo',
        invalidQuantity: 'Cantidad inválida. Por favor ingrese un número válido.'
    }
};

// Multi-currency support including Algerian Dinar with language-specific names
const currencies = {
    USD: {
        symbol: '$',
        rate: 1.0,
        names: {
            en: 'US Dollar',
            ar: 'دولار أمريكي',
            fr: 'Dollar Américain',
            es: 'Dólar Estadounidense'
        }
    },
    EUR: {
        symbol: '€',
        rate: 0.85,
        names: {
            en: 'Euro',
            ar: 'يورو',
            fr: 'Euro',
            es: 'Euro'
        }
    },
    AED: {
        symbol: 'د.إ',
        rate: 3.67,
        names: {
            en: 'UAE Dirham',
            ar: 'درهم إماراتي',
            fr: 'Dirham des EAU',
            es: 'Dirham de EAU'
        }
    },
    SAR: {
        symbol: 'ر.س',
        rate: 3.75,
        names: {
            en: 'Saudi Riyal',
            ar: 'ريال سعودي',
            fr: 'Riyal Saoudien',
            es: 'Riyal Saudí'
        }
    },
    DZD: {
        symbol: { en: 'د.ج', ar: 'د.ج', fr: 'DA', es: 'DA' },
        rate: 134.5,
        names: {
            en: 'Algerian Dinar',
            ar: 'دينار جزائري',
            fr: 'Dinar Algérien',
            es: 'Dinar Argelino'
        }
    },
    GBP: {
        symbol: '£',
        rate: 0.73,
        names: {
            en: 'British Pound',
            ar: 'جنيه إسترليني',
            fr: 'Livre Sterling',
            es: 'Libra Esterlina'
        }
    },
    MAD: {
        symbol: 'د.م',
        rate: 10.2,
        names: {
            en: 'Moroccan Dirham',
            ar: 'درهم مغربي',
            fr: 'Dirham Marocain',
            es: 'Dirham Marroquí'
        }
    },
    TND: {
        symbol: 'د.ت',
        rate: 3.1,
        names: {
            en: 'Tunisian Dinar',
            ar: 'دينار تونسي',
            fr: 'Dinar Tunisien',
            es: 'Dinar Tunecino'
        }
    }
};

// User roles and permissions
const userRoles = {
    admin: {
        name: 'Admin',
        permissions: ['all']
    },
    manager: {
        name: 'Manager', 
        permissions: ['sales', 'inventory', 'reports', 'users', 'settings']
    },
    cashier: {
        name: 'Cashier',
        permissions: ['sales', 'basic_reports']
    }
};

// Sample users with card access (in production, this would be in a secure database)
const users = [
    { id: 1, username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator', active: true, cardNumber: '1001', cardAccess: true },
    { id: 2, username: 'manager', password: 'manager123', role: 'manager', name: 'Store Manager', active: true, cardNumber: '1002', cardAccess: true },
    { id: 3, username: 'cashier1', password: 'cashier123', role: 'cashier', name: 'Ahmed Ali', active: true, cardNumber: '1003', cardAccess: true },
    { id: 4, username: 'cashier2', password: 'cashier123', role: 'cashier', name: 'Fatima Hassan', active: true, cardNumber: '1004', cardAccess: true },
    { id: 5, username: 'cashier3', password: 'cashier123', role: 'cashier', name: 'Omar Benali', active: true, cardNumber: '1005', cardAccess: false }
];

// Categories management - Enhanced for hardware store
let categories = JSON.parse(localStorage.getItem('categories')) || [
    { id: 1, name: 'Food', nameAr: 'طعام', nameFr: 'Nourriture', nameEs: 'Comida', active: true },
    { id: 2, name: 'Drinks', nameAr: 'مشروبات', nameFr: 'Boissons', nameEs: 'Bebidas', active: true },
    { id: 3, name: 'Snacks', nameAr: 'وجبات خفيفة', nameFr: 'Collations', nameEs: 'Aperitivos', active: true },
    { id: 4, name: 'Tools', nameAr: 'أدوات', nameFr: 'Outils', nameEs: 'Herramientas', active: true },
    { id: 5, name: 'Hardware', nameAr: 'أجهزة', nameFr: 'Quincaillerie', nameEs: 'Ferretería', active: true },
    { id: 6, name: 'Construction', nameAr: 'بناء', nameFr: 'Construction', nameEs: 'Construcción', active: true },
    { id: 7, name: 'Electrical', nameAr: 'كهربائي', nameFr: 'Électrique', nameEs: 'Eléctrico', active: true },
    { id: 8, name: 'Plumbing', nameAr: 'سباكة', nameFr: 'Plomberie', nameEs: 'Fontanería', active: true }
];

// Enhanced product data with full inventory management, images, and expiry dates
const products = [
    {
        id: 1, name: 'Hamburger', nameAr: 'همبرغر', nameFr: 'Hamburger', nameEs: 'Hamburguesa',
        price: 8.99, category: 'food', stock: 25, minStock: 5, maxStock: 100,
        barcode: '1234567890123', supplier: 'Food Corp', cost: 5.50, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkY2QjM1Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍔</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 7 days from now
    },
    {
        id: 2, name: 'Cheeseburger', nameAr: 'تشيز برغر', nameFr: 'Cheeseburger', nameEs: 'Hamburguesa con Queso',
        price: 9.99, category: 'food', stock: 20, minStock: 5, maxStock: 80,
        barcode: '1234567890124', supplier: 'Food Corp', cost: 6.20, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZENzAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🧀🍔</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 5 days from now
    },
    {
        id: 3, name: 'French Fries', nameAr: 'بطاطس مقلية', nameFr: 'Frites', nameEs: 'Papas Fritas',
        price: 3.99, category: 'food', stock: 50, minStock: 10, maxStock: 200,
        barcode: '1234567890125', supplier: 'Food Corp', cost: 1.80, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZBNTAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍟</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 3 days from now
    },
    {
        id: 4, name: 'Chicken Wings', nameAr: 'أجنحة دجاج', nameFr: 'Ailes de Poulet', nameEs: 'Alitas de Pollo',
        price: 12.99, category: 'food', stock: 15, minStock: 5, maxStock: 60,
        barcode: '1234567890126', supplier: 'Poultry Plus', cost: 8.50, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjOEI0NTEzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍗</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 2 days from now (near expiry)
    },
    {
        id: 5, name: 'Caesar Salad', nameAr: 'سلطة قيصر', nameFr: 'Salade César', nameEs: 'Ensalada César',
        price: 7.99, category: 'food', stock: 12, minStock: 5, maxStock: 40,
        barcode: '1234567890127', supplier: 'Fresh Greens', cost: 4.20, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzJDRDMyIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🥗</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 1 day from now (near expiry)
    },
    {
        id: 6, name: 'Coca Cola', nameAr: 'كوكا كولا', nameFr: 'Coca Cola', nameEs: 'Coca Cola',
        price: 2.99, category: 'drinks', stock: 100, minStock: 20, maxStock: 500,
        barcode: '1234567890128', supplier: 'Beverage Co', cost: 1.50, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjREMyNjI2Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🥤</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 1 year from now
    },
    {
        id: 7, name: 'Orange Juice', nameAr: 'عصير برتقال', nameFr: 'Jus d\'Orange', nameEs: 'Jugo de Naranja',
        price: 3.49, category: 'drinks', stock: 30, minStock: 10, maxStock: 150,
        barcode: '1234567890129', supplier: 'Juice Factory', cost: 2.10, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZBNTAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍊</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 14 days from now
    },
    {
        id: 8, name: 'Coffee', nameAr: 'قهوة', nameFr: 'Café', nameEs: 'Café',
        price: 2.49, category: 'drinks', stock: 80, minStock: 15, maxStock: 300,
        barcode: '1234567890130', supplier: 'Coffee Roasters', cost: 1.20, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkY0RTM3Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+☕</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 6 months from now
    },
    {
        id: 9, name: 'Water Bottle', nameAr: 'زجاجة ماء', nameFr: 'Bouteille d\'Eau', nameEs: 'Botella de Agua',
        price: 1.99, category: 'drinks', stock: 200, minStock: 50, maxStock: 1000,
        barcode: '1234567890131', supplier: 'Pure Water', cost: 0.80, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMDA5NkZGIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+💧</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 730 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 2 years from now
    },
    {
        id: 10, name: 'Potato Chips', nameAr: 'رقائق البطاطس', nameFr: 'Chips de Pomme de Terre', nameEs: 'Papas Fritas',
        price: 2.99, category: 'snacks', stock: 3, minStock: 10, maxStock: 200,
        barcode: '1234567890132', supplier: 'Snack Foods', cost: 1.50, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZENzAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🥔</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 3 months from now
    },
    {
        id: 11, name: 'Chocolate Bar', nameAr: 'لوح شوكولاتة', nameFr: 'Barre de Chocolat', nameEs: 'Barra de Chocolate',
        price: 1.99, category: 'snacks', stock: 45, minStock: 15, maxStock: 150,
        barcode: '1234567890133', supplier: 'Sweet Treats', cost: 1.10, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjOEI0NTEzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍫</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() + 120 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 4 months from now
    },
    {
        id: 12, name: 'Cookies', nameAr: 'كوكيز', nameFr: 'Biscuits', nameEs: 'Galletas',
        price: 3.49, category: 'snacks', stock: 2, minStock: 8, maxStock: 100,
        barcode: '1234567890134', supplier: 'Bakery Plus', cost: 2.00, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRDI2OTFFIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🍪</dGV4dD4KPC9zdmc+',
        expiryDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] // 1 day ago (expired)
    },

    // ===== HARDWARE PRODUCTS - ALGERIA MARKET =====

    // TOOLS CATEGORY
    {
        id: 13, name: 'Hammer', nameAr: 'مطرقة', nameFr: 'Marteau', nameEs: 'Martillo',
        price: 1250, category: 'tools', stock: 25, minStock: 5, maxStock: 100,
        barcode: '2001001001', supplier: 'Algeria Tools Co', cost: 850, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjOEI0NTEzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🔨</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 14, name: 'Screwdriver Set', nameAr: 'مجموعة مفكات', nameFr: 'Jeu de Tournevis', nameEs: 'Juego de Destornilladores',
        price: 850, category: 'tools', stock: 40, minStock: 10, maxStock: 150,
        barcode: '2001001002', supplier: 'Algeria Tools Co', cost: 580, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNDY5MEU3Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🪛</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 15, name: 'Wrench Set', nameAr: 'مجموعة مفاتيح ربط', nameFr: 'Jeu de Clés', nameEs: 'Juego de Llaves',
        price: 1450, category: 'tools', stock: 30, minStock: 8, maxStock: 120,
        barcode: '2001001003', supplier: 'Algeria Tools Co', cost: 980, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkM3NTdEIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🔧</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 16, name: 'Drill Bits Set', nameAr: 'مجموعة لقم الحفر', nameFr: 'Jeu de Forets', nameEs: 'Juego de Brocas',
        price: 750, category: 'tools', stock: 50, minStock: 15, maxStock: 200,
        barcode: '2001001004', supplier: 'Algeria Tools Co', cost: 480, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjMzQ0OTVFIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🪚</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 17, name: 'Measuring Tape', nameAr: 'شريط قياس', nameFr: 'Mètre Ruban', nameEs: 'Cinta Métrica',
        price: 450, category: 'tools', stock: 60, minStock: 20, maxStock: 250,
        barcode: '2001001005', supplier: 'Algeria Tools Co', cost: 280, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZENzAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+📏</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },

    // HARDWARE CATEGORY
    {
        id: 18, name: 'Wood Screws 4x50mm (100pcs)', nameAr: 'براغي خشب 4×50مم (100 قطعة)', nameFr: 'Vis à Bois 4x50mm (100pcs)', nameEs: 'Tornillos para Madera 4x50mm (100pcs)',
        price: 320, category: 'hardware', stock: 200, minStock: 50, maxStock: 1000,
        barcode: '2002001001', supplier: 'Algerian Hardware Supply', cost: 180, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkM3NTdEIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🔩</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 19, name: 'Metal Bolts M8x40mm (50pcs)', nameAr: 'براغي معدنية M8×40مم (50 قطعة)', nameFr: 'Boulons Métal M8x40mm (50pcs)', nameEs: 'Pernos de Metal M8x40mm (50pcs)',
        price: 580, category: 'hardware', stock: 150, minStock: 30, maxStock: 800,
        barcode: '2002001002', supplier: 'Algerian Hardware Supply', cost: 350, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNDk1MDU3Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+⚙️</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 20, name: 'Nails 3 inch (1kg)', nameAr: 'مسامير 3 بوصة (1 كيلو)', nameFr: 'Clous 3 pouces (1kg)', nameEs: 'Clavos 3 pulgadas (1kg)',
        price: 420, category: 'hardware', stock: 80, minStock: 20, maxStock: 400,
        barcode: '2002001003', supplier: 'Algerian Hardware Supply', cost: 250, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjOEI0NTEzIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+📌</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 21, name: 'Washers Assorted (200pcs)', nameAr: 'حلقات معدنية متنوعة (200 قطعة)', nameFr: 'Rondelles Assorties (200pcs)', nameEs: 'Arandelas Surtidas (200pcs)',
        price: 280, category: 'hardware', stock: 120, minStock: 25, maxStock: 600,
        barcode: '2002001004', supplier: 'Algerian Hardware Supply', cost: 160, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkM3NTdEIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+⭕</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 22, name: 'Hinges 3 inch (pair)', nameAr: 'مفصلات 3 بوصة (زوج)', nameFr: 'Charnières 3 pouces (paire)', nameEs: 'Bisagras 3 pulgadas (par)',
        price: 650, category: 'hardware', stock: 45, minStock: 10, maxStock: 200,
        barcode: '2002001005', supplier: 'Algerian Hardware Supply', cost: 420, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNDk1MDU3Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🚪</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },

    // CONSTRUCTION CATEGORY
    {
        id: 23, name: 'Cement 50kg Bag', nameAr: 'كيس إسمنت 50 كيلو', nameFr: 'Sac de Ciment 50kg', nameEs: 'Bolsa de Cemento 50kg',
        price: 850, category: 'construction', stock: 100, minStock: 20, maxStock: 500,
        barcode: '2003001001', supplier: 'Algeria Construction Materials', cost: 650, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkM3NTdEIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🏗️</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 24, name: 'Sand 25kg Bag', nameAr: 'كيس رمل 25 كيلو', nameFr: 'Sac de Sable 25kg', nameEs: 'Bolsa de Arena 25kg',
        price: 320, category: 'construction', stock: 150, minStock: 30, maxStock: 800,
        barcode: '2003001002', supplier: 'Algeria Construction Materials', cost: 220, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjRBNDYwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🏖️</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 25, name: 'Bricks (per piece)', nameAr: 'طوب (القطعة)', nameFr: 'Briques (à l\'unité)', nameEs: 'Ladrillos (por pieza)',
        price: 45, category: 'construction', stock: 500, minStock: 100, maxStock: 2000,
        barcode: '2003001003', supplier: 'Algeria Construction Materials', cost: 28, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjQ0Q1QzVDIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+🧱</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 26, name: 'Steel Rebar 12mm (6m)', nameAr: 'حديد تسليح 12مم (6 متر)', nameFr: 'Fer à Béton 12mm (6m)', nameEs: 'Varilla de Acero 12mm (6m)',
        price: 1850, category: 'construction', stock: 80, minStock: 15, maxStock: 300,
        barcode: '2003001004', supplier: 'Algeria Steel Co', cost: 1420, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNDk1MDU3Ii8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🔗</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },

    // ELECTRICAL CATEGORY
    {
        id: 27, name: 'Electrical Wire 2.5mm (100m)', nameAr: 'سلك كهربائي 2.5مم (100 متر)', nameFr: 'Fil Électrique 2.5mm (100m)', nameEs: 'Cable Eléctrico 2.5mm (100m)',
        price: 2850, category: 'electrical', stock: 35, minStock: 8, maxStock: 150,
        barcode: '2004001001', supplier: 'Algeria Electric Supply', cost: 2100, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRkZENzAwIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">⚡</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 28, name: 'Light Switch', nameAr: 'مفتاح إضاءة', nameFr: 'Interrupteur', nameEs: 'Interruptor de Luz',
        price: 180, category: 'electrical', stock: 120, minStock: 25, maxStock: 500,
        barcode: '2004001002', supplier: 'Algeria Electric Supply', cost: 110, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjhGOUZBIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJibGFjayIgdGV4dC1hbmNob3I9Im1pZGRsZSI">💡</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 29, name: 'Power Outlet', nameAr: 'مقبس كهربائي', nameFr: 'Prise Électrique', nameEs: 'Toma de Corriente',
        price: 220, category: 'electrical', stock: 90, minStock: 20, maxStock: 400,
        barcode: '2004001003', supplier: 'Algeria Electric Supply', cost: 140, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjhGOUZBIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJibGFjayIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🔌</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },

    // PLUMBING CATEGORY
    {
        id: 30, name: 'PVC Pipe 32mm (3m)', nameAr: 'أنبوب PVC 32مم (3 متر)', nameFr: 'Tuyau PVC 32mm (3m)', nameEs: 'Tubo PVC 32mm (3m)',
        price: 380, category: 'plumbing', stock: 75, minStock: 15, maxStock: 300,
        barcode: '2005001001', supplier: 'Algeria Plumbing Co', cost: 250, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjRjhGOUZBIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJibGFjayIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🚰</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 31, name: 'Pipe Fittings Set', nameAr: 'مجموعة وصلات الأنابيب', nameFr: 'Jeu de Raccords', nameEs: 'Juego de Accesorios',
        price: 650, category: 'plumbing', stock: 55, minStock: 12, maxStock: 250,
        barcode: '2005001002', supplier: 'Algeria Plumbing Co', cost: 420, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNkM3NTdEIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🔧</dGV4dD4KPC9zdmc+',
        expiryDate: null
    },
    {
        id: 32, name: 'Faucet Standard', nameAr: 'صنبور عادي', nameFr: 'Robinet Standard', nameEs: 'Grifo Estándar',
        price: 1250, category: 'plumbing', stock: 25, minStock: 5, maxStock: 100,
        barcode: '2005001003', supplier: 'Algeria Plumbing Co', cost: 850, active: true,
        image: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiBmaWxsPSIjNEZBNEZGIi8+Cjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI">🚿</dGV4dD4KPC9zdmc+',
        expiryDate: null
    }
];

// ===== GLOBAL STATE =====
let cart = [];
let currentCategory = 'all';
let currentUser = null;
let currentLanguage = localStorage.getItem('posLanguage') || 'en';
let currentCurrency = localStorage.getItem('posCurrency') || 'USD';
let salesHistory = JSON.parse(localStorage.getItem('salesHistory')) || [];
let isLoggedIn = false;
let currentView = 'pos'; // pos, inventory, reports, settings, users

// System settings
const settings = {
    taxRate: parseFloat(localStorage.getItem('taxRate')) || 0.19, // 19% VAT (Algeria standard)
    companyName: localStorage.getItem('companyName') || 'My POS System',
    companyAddress: localStorage.getItem('companyAddress') || 'Algiers, Algeria',
    companyPhone: localStorage.getItem('companyPhone') || '+213 21 123 456',
    receiptFooter: localStorage.getItem('receiptFooter') || 'شكراً لزيارتكم - Thank you for your visit!',
    companyLogo: localStorage.getItem('companyLogo') || '',
    lowStockThreshold: parseInt(localStorage.getItem('lowStockThreshold')) || 10,
    autoBackup: localStorage.getItem('autoBackup') === 'true',
    printAfterSale: localStorage.getItem('printAfterSale') === 'true',
    showBarcode: localStorage.getItem('showBarcode') === 'true'
};

// ===== UTILITY FUNCTIONS =====

// Get translated text
function t(key) {
    return languages[currentLanguage][key] || key;
}

// Get product name in current language
function getProductName(product) {
    switch(currentLanguage) {
        case 'ar': return product.nameAr || product.name;
        case 'fr': return product.nameFr || product.name;
        case 'es': return product.nameEs || product.name;
        default: return product.name;
    }
}

// Format currency with language-specific symbols
function formatCurrency(amount) {
    const currency = currencies[currentCurrency];
    const convertedAmount = amount * currency.rate;

    // Get language-specific symbol
    let symbol;
    if (typeof currency.symbol === 'object') {
        symbol = currency.symbol[currentLanguage] || currency.symbol.en;
    } else {
        symbol = currency.symbol;
    }

    // Format based on language
    if (currentLanguage === 'ar') {
        return `${convertedAmount.toFixed(2)} ${symbol}`;
    } else {
        return `${symbol}${convertedAmount.toFixed(2)}`;
    }
}

// Get currency name in current language
function getCurrencyName(currencyCode) {
    const currency = currencies[currencyCode];
    return currency.names[currentLanguage] || currency.names.en;
}

// Convert price to current currency
function convertPrice(price) {
    return price * currencies[currentCurrency].rate;
}

// Format price without conversion (for product display)
function formatPrice(amount) {
    const currency = currencies[currentCurrency];

    // Get language-specific symbol
    let symbol;
    if (typeof currency.symbol === 'object') {
        symbol = currency.symbol[currentLanguage] || currency.symbol.en;
    } else {
        symbol = currency.symbol;
    }

    // Format based on language (no conversion)
    if (currentLanguage === 'ar') {
        return `${amount.toFixed(2)} ${symbol}`;
    } else {
        return `${symbol}${amount.toFixed(2)}`;
    }
}

// Generate unique ID
function generateId() {
    return Date.now() + Math.random().toString(36).substr(2, 9);
}

// Save to localStorage
function saveToStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
    } catch (e) {
        console.error('Failed to save to localStorage:', e);
    }
}

// Load from localStorage
function loadFromStorage(key, defaultValue = null) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error('Failed to load from localStorage:', e);
        return defaultValue;
    }
}

// ===== AUTHENTICATION SYSTEM =====

function showLoginScreen() {
    const loginHTML = `
        <div class="login-screen">
            <div class="login-container">
                <div class="login-header">
                    <h1>${t('welcome')}</h1>
                    <div class="language-selector">
                        <label>Choose Language / اختر اللغة:</label>
                        <select id="login-language" onchange="changeLanguage(this.value)">
                            <option value="en" ${currentLanguage === 'en' ? 'selected' : ''}>🇺🇸 English</option>
                            <option value="ar" ${currentLanguage === 'ar' ? 'selected' : ''}>🇩🇿 العربية (Arabic)</option>
                            <option value="fr" ${currentLanguage === 'fr' ? 'selected' : ''}>🇫🇷 Français (French)</option>
                            <option value="es" ${currentLanguage === 'es' ? 'selected' : ''}>🇪🇸 Español (Spanish)</option>
                        </select>
                    </div>
                </div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">${t('username')}:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">${t('password')}:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">${t('login')}</button>
                </form>
                <div class="demo-users">
                    <h3>Demo Users:</h3>
                    <p><strong>Admin:</strong> admin / admin123</p>
                    <p><strong>Manager:</strong> manager / manager123</p>
                    <p><strong>Cashier:</strong> cashier1 / cashier123</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.innerHTML = loginHTML;
    
    // Add login screen styles
    const loginStyles = `
        <style>
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-width: 400px;
            text-align: center;
        }
        .login-header {
            margin-bottom: 30px;
        }
        .login-header h1 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .language-selector select {
            padding: 8px 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .login-form {
            text-align: left;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        .demo-users {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
        }
        .demo-users h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .demo-users p {
            margin: 5px 0;
            font-size: 14px;
        }
        </style>
    `;
    
    document.head.insertAdjacentHTML('beforeend', loginStyles);
}

function handleLogin(event) {
    event.preventDefault();
    
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    const user = users.find(u => u.username === username && u.password === password && u.active);
    
    if (user) {
        currentUser = user;
        isLoggedIn = true;
        localStorage.setItem('currentUser', JSON.stringify(user));
        localStorage.setItem('isLoggedIn', 'true');
        
        // Reload the page to initialize the main system
        location.reload();
    } else {
        alert('Invalid username or password');
    }
}

function logout() {
    currentUser = null;
    isLoggedIn = false;
    localStorage.removeItem('currentUser');
    localStorage.removeItem('isLoggedIn');
    location.reload();
}

function checkLoginStatus() {
    const savedUser = localStorage.getItem('currentUser');
    const savedLoginStatus = localStorage.getItem('isLoggedIn');
    
    if (savedUser && savedLoginStatus === 'true') {
        currentUser = JSON.parse(savedUser);
        isLoggedIn = true;
    }
}

// ===== LANGUAGE & CURRENCY FUNCTIONS =====

function changeLanguage(lang) {
    currentLanguage = lang;
    localStorage.setItem('posLanguage', lang);

    if (isLoggedIn) {
        updateLanguage();
        displayProducts();
        updateCartDisplay();

        // Refresh current view content
        switch(currentView) {
            case 'inventory':
                loadInventoryView();
                break;
            case 'reports':
                loadReportsView();
                break;
            case 'users':
                loadUsersView();
                break;
            case 'settings':
                loadSettingsView();
                break;
        }

        // Update currency selector
        updateCurrencySelector();

        // Update low stock alerts
        checkLowStock();
    } else {
        // Just update the login screen
        showLoginScreen();
    }
}

function changeCurrency(currency) {
    currentCurrency = currency;
    localStorage.setItem('posCurrency', currency);
    displayProducts();
    updateCartDisplay();

    // Refresh current view if it contains currency data
    if (currentView === 'reports') {
        loadReportsView();
    }
}

function updateCurrencySelector() {
    const currencySelector = document.getElementById('currency-selector');
    if (currencySelector) {
        currencySelector.innerHTML = Object.entries(currencies).map(([code, curr]) => {
            const symbol = typeof curr.symbol === 'object' ? curr.symbol[currentLanguage] || curr.symbol.en : curr.symbol;
            const name = curr.names[currentLanguage] || curr.names.en;
            return `<option value="${code}" ${currentCurrency === code ? 'selected' : ''}>${symbol} ${name}</option>`;
        }).join('');
    }
}

function updateLanguage() {
    // Update all text elements with translations
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        const translatedText = t(key);

        // Handle different element types
        if (element.tagName === 'INPUT' && element.type === 'button') {
            element.value = translatedText;
        } else if (element.tagName === 'INPUT' && element.placeholder) {
            element.placeholder = translatedText;
        } else if (element.tagName === 'BUTTON') {
            element.textContent = translatedText;
        } else {
            element.textContent = translatedText;
        }
    });

    // Update document direction for Arabic
    document.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
    document.documentElement.lang = currentLanguage;

    // Update language selector
    const languageSelector = document.getElementById('language-selector');
    if (languageSelector) {
        languageSelector.value = currentLanguage;
    }

    // Update currency selector with translated names
    updateCurrencySelector();

    // Update category buttons with translated names
    updateCategoryButtons();
}

// ===== MAIN SYSTEM INITIALIZATION =====

document.addEventListener('DOMContentLoaded', function() {
    initializeSystem();
});

function initializeSystem() {
    checkLoginStatus();

    if (!isLoggedIn) {
        showLoginScreen();
        return;
    }

    // Initialize main system
    loadSettings();
    createMainInterface();
    updateLanguage();
    displayProducts();
    updateCartDisplay();
    updateTime();
    checkLowStock();

    // Set up category buttons
    attachCategoryButtonListeners();

    // Set up intervals
    setInterval(updateTime, 1000);
    setInterval(checkLowStock, 60000); // Check every minute
    setInterval(autoSave, 30000); // Auto-save every 30 seconds

    // Event listeners
    setupEventListeners();

    console.log('Professional POS System initialized successfully');
}

function createMainInterface() {
    const mainHTML = `
        <div class="pos-container">
            <!-- Top Navigation -->
            <nav class="top-nav">
                <div class="nav-container">
                    <div class="nav-left">
                        <div class="company-branding">
                            <div id="main-logo" class="company-logo">
                                ${settings.companyLogo ?
                                    `<img src="${settings.companyLogo}" alt="${settings.companyName}" class="logo-image">` :
                                    `<div class="logo-text">${settings.companyName}</div>`
                                }
                            </div>
                            <h1 class="welcome-title" data-translate="welcome">${t('welcome')}</h1>
                        </div>
                        <div class="nav-tabs-container">
                            <div class="nav-tabs">
                                <button class="nav-tab active" onclick="switchView('pos')" data-translate="sales">${t('sales')}</button>
                                ${hasPermission('inventory') ? `<button class="nav-tab" onclick="switchView('inventory')" data-translate="inventory">${t('inventory')}</button>` : ''}
                                ${hasPermission('inventory') ? `<button class="nav-tab" onclick="switchView('categories')" data-translate="categories">${t('categories')}</button>` : ''}
                                ${hasPermission('reports') ? `<button class="nav-tab" onclick="switchView('reports')" data-translate="reports">${t('reports')}</button>` : ''}
                                ${hasPermission('users') ? `<button class="nav-tab" onclick="switchView('users')" data-translate="users">${t('users')}</button>` : ''}
                                ${currentUser && currentUser.role === 'admin' ? `<button class="nav-tab" onclick="switchView('settings')" data-translate="settings">${t('settings')}</button>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="nav-right">
                        <div class="controls-panel">
                            <div class="language-currency-controls">
                                <div class="control-item">
                                    <label class="control-label">
                                        <i class="icon">🌐</i>
                                        <span data-translate="language">${t('language')}</span>
                                    </label>
                                    <select id="language-selector" class="enhanced-select" onchange="changeLanguage(this.value)">
                                        <option value="en" ${currentLanguage === 'en' ? 'selected' : ''}>🇺🇸 English</option>
                                        <option value="ar" ${currentLanguage === 'ar' ? 'selected' : ''}>🇩🇿 العربية</option>
                                        <option value="fr" ${currentLanguage === 'fr' ? 'selected' : ''}>🇫🇷 Français</option>
                                        <option value="es" ${currentLanguage === 'es' ? 'selected' : ''}>🇪🇸 Español</option>
                                    </select>
                                </div>
                                <div class="control-item">
                                    <label class="control-label">
                                        <i class="icon">💰</i>
                                        <span data-translate="currency">${t('currency')}</span>
                                    </label>
                                    <select id="currency-selector" class="enhanced-select" onchange="changeCurrency(this.value)">
                                        ${Object.entries(currencies).map(([code, curr]) =>
                                            `<option value="${code}" ${currentCurrency === code ? 'selected' : ''}>${curr.symbol} ${curr.name}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="user-info-panel">
                                <div class="user-details">
                                    <div class="user-avatar">
                                        <i class="user-icon">👤</i>
                                    </div>
                                    <div class="user-text">
                                        <span class="user-name">${currentUser.name}</span>
                                        <span class="user-role">${t(currentUser.role)}</span>
                                    </div>
                                </div>
                                <div class="time-display">
                                    <i class="time-icon">🕐</i>
                                    <span id="current-time"></span>
                                </div>
                                <button class="btn btn-logout" onclick="logout()" data-translate="logout">
                                    <i class="logout-icon">🚪</i>
                                    ${t('logout')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                <!-- POS View -->
                <div id="pos-view" class="view active">
                    <div class="pos-layout">
                        <!-- Categories & Search -->
                        <section class="categories-section">
                            <div class="search-bar">
                                <input type="text" id="product-search" placeholder="${t('search')}..." onkeyup="searchProducts()">
                                <div class="price-type-selector-container">
                                    <label for="price-type-selector">${t('priceType')}:</label>
                                    <select id="price-type-selector" class="price-type-select" onchange="updatePriceTypeDisplay()" title="${t('selectPriceType')}">
                                        <option value="regular">${t('regular')}</option>
                                        <option value="wholesale">${t('wholesalePrice')}</option>
                                        <option value="retail">${t('retailPrice')}</option>
                                        <option value="vip">${t('vipPrice')}</option>
                                        <option value="bulk">${t('bulkPrice')}</option>
                                    </select>
                                </div>
                                <button onclick="scanBarcode()" class="btn btn-secondary">📷 Scan</button>
                            </div>
                            <h2 data-translate="categories">${t('categories')}</h2>
                            <div class="category-buttons" id="category-buttons">
                                ${generateCategoryButtons()}
                            </div>
                            <div class="low-stock-alert" id="low-stock-alert" style="display: none;">
                                <h3 data-translate="lowStock">${t('lowStock')}</h3>
                                <div id="low-stock-items"></div>
                            </div>
                        </section>

                        <!-- Products Grid -->
                        <section class="products-section">
                            <h2 data-translate="products">${t('products')}</h2>
                            <div class="products-grid" id="products-grid">
                                <!-- Products will be loaded here -->
                            </div>
                        </section>

                        <!-- Shopping Cart -->
                        <section class="cart-section">
                            <h2 data-translate="currentOrder">${t('currentOrder')}</h2>
                            <div class="cart-items" id="cart-items">
                                <p class="empty-cart" data-translate="emptyCart">${t('emptyCart')}</p>
                            </div>
                            <div class="cart-summary">
                                <div class="total-line">
                                    <span data-translate="subtotal">${t('subtotal')}:</span>
                                    <span id="subtotal">${formatCurrency(0)}</span>
                                </div>
                                <div class="total-line">
                                    <span data-translate="tax">${t('tax')} (${(settings.taxRate * 100).toFixed(0)}%):</span>
                                    <span id="tax">${formatCurrency(0)}</span>
                                </div>
                                <div class="total-line total">
                                    <span data-translate="total">${t('total')}:</span>
                                    <span id="total">${formatCurrency(0)}</span>
                                </div>
                            </div>
                            <div class="cart-actions">
                                <div class="quick-payment-buttons">
                                    <button class="btn btn-success btn-large" onclick="quickCashPayment()" data-translate="quickCash">💵 ${t('quickCash')}</button>
                                    <button class="btn btn-info btn-large" onclick="quickCardPayment()" data-translate="quickCard">💳 ${t('quickCard')}</button>
                                </div>
                                <div class="standard-actions">
                                    <button class="btn btn-primary" id="checkout" data-translate="checkout">${t('checkout')}</button>
                                    <button class="btn btn-warning" onclick="printQuotation()" data-translate="quotation">📋 ${t('quotation')}</button>
                                    <button class="btn btn-secondary" id="clear-cart" data-translate="clearCart">${t('clearCart')}</button>
                                </div>
                                <div class="print-actions">
                                    <button class="btn btn-warning btn-small" id="print-quotation" data-translate="printQuotation">${t('printQuotation')}</button>
                                    <button class="btn btn-success btn-small" id="print-receipt" data-translate="printReceipt">${t('printReceipt')}</button>
                                    <button class="btn btn-info btn-small" id="print-invoice" data-translate="printInvoice">${t('printInvoice')}</button>
                                </div>
                            </div>
                            <div class="management-actions" style="margin-top: 15px;">
                                <button class="btn btn-warning btn-small" onclick="printLowStockReport()" data-translate="printLowStock">${t('printLowStock')}</button>
                                <button class="btn btn-danger btn-small" onclick="printExpiredItemsReport()" data-translate="printExpired">${t('printExpired')}</button>
                            </div>
                        </section>
                    </div>
                </div>

                <!-- Other views will be added here -->
                <div id="inventory-view" class="view" style="display: none;">
                    <h2 data-translate="inventory">${t('inventory')}</h2>
                    <div class="inventory-content">
                        <!-- Inventory management will be added -->
                    </div>
                </div>

                <div id="categories-view" class="view" style="display: none;">
                    <h2 data-translate="categoryManagement">${t('categoryManagement')}</h2>
                    <div class="categories-content">
                        <!-- Categories management will be loaded here -->
                    </div>
                </div>

                <div id="reports-view" class="view" style="display: none;">
                    <h2 data-translate="reports">${t('reports')}</h2>
                    <div class="reports-content">
                        <!-- Reports will be added -->
                    </div>
                </div>

                <div id="users-view" class="view" style="display: none;">
                    <h2 data-translate="users">${t('users')}</h2>
                    <div class="users-content">
                        <!-- User management will be added -->
                    </div>
                </div>

                <div id="settings-view" class="view" style="display: none;">
                    <h2 data-translate="settings">${t('settings')}</h2>
                    <div class="settings-content">
                        <!-- Settings will be added -->
                    </div>
                </div>
            </main>
        </div>

        <!-- Checkout Modal -->
        <div class="modal" id="checkout-modal">
            <div class="modal-content">
                <h2 data-translate="checkout">${t('checkout')}</h2>
                <div class="checkout-summary">
                    <div class="checkout-items" id="checkout-items"></div>
                    <div class="checkout-total">
                        <h3><span data-translate="total">${t('total')}</span>: <span id="checkout-total-amount"></span></h3>
                    </div>
                </div>
                <div class="payment-methods">
                    <h3>Payment Method:</h3>
                    <button class="payment-btn" data-method="cash">💵 Cash</button>
                    <button class="payment-btn" data-method="card">💳 Card</button>
                    <button class="payment-btn" data-method="digital">📱 Digital</button>
                </div>
                <div class="payment-details" id="payment-details">
                    <!-- Payment details will be shown here -->
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="cancel-checkout" data-translate="cancel">${t('cancel')}</button>
                    <button class="btn btn-primary" id="complete-sale" data-translate="completeSale">${t('completeSale')}</button>
                </div>
            </div>
        </div>
    `;

    document.body.innerHTML = mainHTML;
}

// ===== PERMISSION SYSTEM =====

function hasPermission(permission) {
    if (!currentUser) return false;
    const userRole = userRoles[currentUser.role];
    return userRole.permissions.includes('all') || userRole.permissions.includes(permission);
}

// ===== VIEW MANAGEMENT =====

function switchView(viewName) {
    // Hide all views
    document.querySelectorAll('.view').forEach(view => {
        view.style.display = 'none';
    });

    // Remove active class from all tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Show selected view
    const targetView = document.getElementById(`${viewName}-view`);
    if (targetView) {
        targetView.style.display = 'block';
        currentView = viewName;
    }

    // Add active class to selected tab
    event.target.classList.add('active');

    // Load view-specific content
    switch(viewName) {
        case 'inventory':
            loadInventoryView();
            break;
        case 'categories':
            loadCategoriesView();
            break;
        case 'reports':
            loadReportsView();
            break;
        case 'users':
            loadUsersView();
            break;
        case 'settings':
            loadSettingsView();
            break;
    }
}

// ===== INVENTORY MANAGEMENT =====

function loadInventoryView() {
    const inventoryView = document.getElementById('inventory-view');
    inventoryView.innerHTML = `
        <div class="inventory-header">
            <h2 data-translate="inventory">${t('inventory')}</h2>
            <div class="inventory-actions">
                <button class="btn btn-primary" onclick="showAddProductModal()" data-translate="addProduct">${t('addProduct')}</button>
                <button class="btn btn-secondary" onclick="exportInventory()" data-translate="export">${t('export')}</button>
                <button class="btn btn-warning" onclick="printLowStockReport()" data-translate="lowStockReport">${t('lowStockReport')}</button>
                <button class="btn btn-info" onclick="showBulkBarcodeModal()" data-translate="bulkBarcodePrint">${t('bulkBarcodePrint')}</button>
            </div>
        </div>

        <div class="inventory-filters">
            <input type="text" id="inventory-search" placeholder="${t('search')}..." onkeyup="filterInventory()">
            <select id="category-filter" onchange="filterInventory()">
                <option value="all">${t('allItems')}</option>
                <option value="food">${t('food')}</option>
                <option value="drinks">${t('drinks')}</option>
                <option value="snacks">${t('snacks')}</option>
                <option value="tools">${t('tools')}</option>
                <option value="hardware">${t('hardware')}</option>
                <option value="construction">${t('construction')}</option>
                <option value="electrical">${t('electrical')}</option>
                <option value="plumbing">${t('plumbing')}</option>
            </select>
            <select id="stock-filter" onchange="filterInventory()">
                <option value="all" data-translate="allStockLevels">${t('allStockLevels')}</option>
                <option value="low" data-translate="lowStockOnly">${t('lowStockOnly')}</option>
                <option value="out" data-translate="outOfStockOnly">${t('outOfStockOnly')}</option>
            </select>
        </div>

        <div class="inventory-table">
            <table>
                <thead>
                    <tr>
                        <th data-translate="name">${t('name')}</th>
                        <th data-translate="category">${t('category')}</th>
                        <th data-translate="price">${t('price')}</th>
                        <th data-translate="stock">${t('stock')}</th>
                        <th data-translate="minStock">${t('minStock')}</th>
                        <th data-translate="barcode">${t('barcode')}</th>
                        <th data-translate="supplier">${t('supplier')}</th>
                        <th data-translate="actions">${t('actions')}</th>
                    </tr>
                </thead>
                <tbody id="inventory-tbody">
                    ${generateInventoryRows()}
                </tbody>
            </table>
        </div>
    `;
}

function generateInventoryRows() {
    return products.map(product => {
        const productName = currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name;
        const isLowStock = product.stock <= product.minStock;
        const isOutOfStock = product.stock === 0;

        return `
            <tr class="${isOutOfStock ? 'out-of-stock' : isLowStock ? 'low-stock' : ''}">
                <td>${productName}</td>
                <td>${t(product.category)}</td>
                <td>${formatPrice(product.price)}</td>
                <td>
                    <span class="stock-level ${isOutOfStock ? 'out' : isLowStock ? 'low' : 'normal'}">
                        ${product.stock}
                    </span>
                </td>
                <td>${product.minStock}</td>
                <td>${product.barcode}</td>
                <td>${product.supplier || t('notAvailable')}</td>
                <td class="actions">
                    <button class="btn-small btn-primary" onclick="editProduct(${product.id})" data-translate="edit">${t('edit')}</button>
                    <button class="btn-small btn-success" onclick="adjustStock(${product.id})" data-translate="adjustStock">${t('adjustStock')}</button>
                    ${!product.barcode || product.barcode === '' ?
                        `<button class="btn-small btn-info" onclick="printBarcode(${product.id})" data-translate="printBarcode">${t('printBarcode')}</button>` :
                        `<button class="btn-small btn-secondary" onclick="printBarcode(${product.id})" data-translate="printBarcode">${t('printBarcode')}</button>`
                    }
                    <button class="btn-small btn-danger" onclick="deleteProduct(${product.id})" data-translate="delete">${t('delete')}</button>
                </td>
            </tr>
        `;
    }).join('');
}

function filterInventory() {
    const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
    const categoryFilter = document.getElementById('category-filter').value;
    const stockFilter = document.getElementById('stock-filter').value;

    let filteredProducts = products.filter(product => {
        const name = (currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name).toLowerCase();
        const matchesSearch = name.includes(searchTerm) || product.barcode.includes(searchTerm);
        const matchesCategory = categoryFilter === 'all' || product.category === categoryFilter;

        let matchesStock = true;
        if (stockFilter === 'low') {
            matchesStock = product.stock <= product.minStock && product.stock > 0;
        } else if (stockFilter === 'out') {
            matchesStock = product.stock === 0;
        }

        return matchesSearch && matchesCategory && matchesStock;
    });

    document.getElementById('inventory-tbody').innerHTML = filteredProducts.map(product => {
        const productName = currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name;
        const isLowStock = product.stock <= product.minStock;
        const isOutOfStock = product.stock === 0;

        return `
            <tr class="${isOutOfStock ? 'out-of-stock' : isLowStock ? 'low-stock' : ''}">
                <td>${productName}</td>
                <td>${t(product.category)}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>
                    <span class="stock-level ${isOutOfStock ? 'out' : isLowStock ? 'low' : 'normal'}">
                        ${product.stock}
                    </span>
                </td>
                <td>${product.minStock}</td>
                <td>${product.barcode}</td>
                <td>${product.supplier || t('notAvailable')}</td>
                <td class="actions">
                    <button class="btn-small btn-primary" onclick="editProduct(${product.id})" data-translate="edit">${t('edit')}</button>
                    <button class="btn-small btn-success" onclick="adjustStock(${product.id})" data-translate="adjustStock">${t('adjustStock')}</button>
                    ${!product.barcode || product.barcode === '' ?
                        `<button class="btn-small btn-info" onclick="printBarcode(${product.id})" data-translate="printBarcode">${t('printBarcode')}</button>` :
                        `<button class="btn-small btn-secondary" onclick="printBarcode(${product.id})" data-translate="printBarcode">${t('printBarcode')}</button>`
                    }
                    <button class="btn-small btn-danger" onclick="deleteProduct(${product.id})" data-translate="delete">${t('delete')}</button>
                </td>
            </tr>
        `;
    }).join('');
}

function showAddProductModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>${t('addProduct')}</h2>
            <form onsubmit="addNewProduct(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('name')} (English):</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label>${t('name')} (Arabic):</label>
                        <input type="text" id="product-name-ar">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('category')}:</label>
                        <select id="product-category" required>
                            <option value="food">${t('food')}</option>
                            <option value="drinks">${t('drinks')}</option>
                            <option value="snacks">${t('snacks')}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${t('price')} (${t('regular')}):</label>
                        <input type="number" id="product-price" step="0.01" required>
                    </div>
                </div>
                <div class="form-section">
                    <h3>${t('multiPriceOptions')} (${t('optional')})</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>${t('wholesalePrice')}:</label>
                            <input type="number" id="product-wholesale-price" step="0.01" placeholder="${t('optional')}">
                        </div>
                        <div class="form-group">
                            <label>${t('retailPrice')}:</label>
                            <input type="number" id="product-retail-price" step="0.01" placeholder="${t('optional')}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>${t('vipPrice')}:</label>
                            <input type="number" id="product-vip-price" step="0.01" placeholder="${t('optional')}">
                        </div>
                        <div class="form-group">
                            <label>${t('bulkPrice')}:</label>
                            <input type="number" id="product-bulk-price" step="0.01" placeholder="${t('optional')}">
                        </div>
                    </div>
                </div>
                <div class="form-row">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('stock')}:</label>
                        <input type="number" id="product-stock" required>
                    </div>
                    <div class="form-group">
                        <label data-translate="minStock">${t('minStock')}:</label>
                        <input type="number" id="product-min-stock" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-translate="barcode">${t('barcode')}:</label>
                        <input type="text" id="product-barcode" required>
                    </div>
                    <div class="form-group">
                        <label data-translate="supplier">${t('supplier')}:</label>
                        <input type="text" id="product-supplier">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function addNewProduct(event) {
    event.preventDefault();

    // Get multi-price values
    const wholesalePrice = document.getElementById('product-wholesale-price').value;
    const retailPrice = document.getElementById('product-retail-price').value;
    const vipPrice = document.getElementById('product-vip-price').value;
    const bulkPrice = document.getElementById('product-bulk-price').value;

    const newProduct = {
        id: Math.max(...products.map(p => p.id)) + 1,
        name: document.getElementById('product-name').value,
        nameAr: document.getElementById('product-name-ar').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value),
        // Multi-price options
        prices: {
            regular: parseFloat(document.getElementById('product-price').value),
            wholesale: wholesalePrice ? parseFloat(wholesalePrice) : null,
            retail: retailPrice ? parseFloat(retailPrice) : null,
            vip: vipPrice ? parseFloat(vipPrice) : null,
            bulk: bulkPrice ? parseFloat(bulkPrice) : null
        },
        stock: parseInt(document.getElementById('product-stock').value),
        minStock: parseInt(document.getElementById('product-min-stock').value),
        maxStock: parseInt(document.getElementById('product-stock').value) * 5,
        barcode: document.getElementById('product-barcode').value,
        supplier: document.getElementById('product-supplier').value,
        cost: parseFloat(document.getElementById('product-price').value) * 0.6,
        active: true
    };

    products.push(newProduct);
    saveToStorage('products', products);

    closeModal();
    loadInventoryView();
    displayProducts(); // Refresh main products view

    alert(`Product "${newProduct.name}" added successfully!`);
}

function editProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>${t('editProduct')}</h2>
            <form onsubmit="updateProduct(event, ${productId})">
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('name')} (English):</label>
                        <input type="text" id="edit-product-name" value="${product.name}" required>
                    </div>
                    <div class="form-group">
                        <label>${t('name')} (Arabic):</label>
                        <input type="text" id="edit-product-name-ar" value="${product.nameAr || ''}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('category')}:</label>
                        <select id="edit-product-category" required>
                            <option value="food" ${product.category === 'food' ? 'selected' : ''}>${t('food')}</option>
                            <option value="drinks" ${product.category === 'drinks' ? 'selected' : ''}>${t('drinks')}</option>
                            <option value="snacks" ${product.category === 'snacks' ? 'selected' : ''}>${t('snacks')}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>${t('price')}:</label>
                        <input type="number" id="edit-product-price" step="0.01" value="${product.price}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>${t('stock')}:</label>
                        <input type="number" id="edit-product-stock" value="${product.stock}" required>
                    </div>
                    <div class="form-group">
                        <label data-translate="minStock">${t('minStock')}:</label>
                        <input type="number" id="edit-product-min-stock" value="${product.minStock}" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label data-translate="barcode">${t('barcode')}:</label>
                        <input type="text" id="edit-product-barcode" value="${product.barcode}" required>
                    </div>
                    <div class="form-group">
                        <label data-translate="supplier">${t('supplier')}:</label>
                        <input type="text" id="edit-product-supplier" value="${product.supplier || ''}">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateProduct(event, productId) {
    event.preventDefault();

    const product = products.find(p => p.id === productId);
    if (!product) return;

    product.name = document.getElementById('edit-product-name').value;
    product.nameAr = document.getElementById('edit-product-name-ar').value;
    product.category = document.getElementById('edit-product-category').value;
    product.price = parseFloat(document.getElementById('edit-product-price').value);
    product.stock = parseInt(document.getElementById('edit-product-stock').value);
    product.minStock = parseInt(document.getElementById('edit-product-min-stock').value);
    product.barcode = document.getElementById('edit-product-barcode').value;
    product.supplier = document.getElementById('edit-product-supplier').value;

    saveToStorage('products', products);

    closeModal();
    loadInventoryView();
    displayProducts(); // Refresh main products view

    alert(`Product "${product.name}" updated successfully!`);
}

function adjustStock(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const adjustment = prompt(`Current stock: ${product.stock}\nEnter adjustment (+/- number):`);
    if (adjustment === null) return;

    const adjustmentValue = parseInt(adjustment);
    if (isNaN(adjustmentValue)) {
        alert('Please enter a valid number');
        return;
    }

    const newStock = product.stock + adjustmentValue;
    if (newStock < 0) {
        alert('Stock cannot be negative');
        return;
    }

    product.stock = newStock;
    saveToStorage('products', products);

    loadInventoryView();
    displayProducts(); // Refresh main products view

    alert(`Stock adjusted for "${product.name}". New stock: ${product.stock}`);
}

function deleteProduct(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    if (confirm(`Are you sure you want to delete "${product.name}"?`)) {
        const index = products.findIndex(p => p.id === productId);
        products.splice(index, 1);
        saveToStorage('products', products);

        loadInventoryView();
        displayProducts(); // Refresh main products view

        alert(`Product "${product.name}" deleted successfully!`);
    }
}

function closeModal() {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => modal.remove());
}

// ===== REPORTS MANAGEMENT =====

function loadReportsView() {
    const reportsView = document.getElementById('reports-view');
    reportsView.innerHTML = `
        <div class="reports-header">
            <h2 data-translate="reports">${t('reports')}</h2>
            <div class="reports-actions">
                <button class="btn btn-primary" onclick="generateDailyReport()" data-translate="dailyReport">${t('dailyReport')}</button>
                <button class="btn btn-secondary" onclick="generateWeeklyReport()" data-translate="weeklyReport">${t('weeklyReport')}</button>
                <button class="btn btn-info" onclick="toggleCharts()" data-translate="charts">${t('charts')}</button>
                <button class="btn btn-success" onclick="exportReports()" data-translate="export">${t('export')}</button>
            </div>
        </div>

        <div class="reports-dashboard">
            <div class="report-cards">
                <div class="report-card">
                    <h3 data-translate="todaysSales">${t('todaysSales')}</h3>
                    <div class="report-value">${formatCurrency(getTodaysSales())}</div>
                    <div class="report-subtitle">${getTodaysTransactions()} ${t('transactions')}</div>
                </div>
                <div class="report-card">
                    <h3 data-translate="thisWeek">${t('thisWeek')}</h3>
                    <div class="report-value">${formatCurrency(getWeekSales())}</div>
                    <div class="report-subtitle">${getWeekTransactions()} ${t('transactions')}</div>
                </div>
                <div class="report-card">
                    <h3 data-translate="lowStock">${t('lowStock')} ${t('products')}</h3>
                    <div class="report-value">${getLowStockCount()}</div>
                    <div class="report-subtitle">${t('itemsNeedRestocking')}</div>
                </div>
                <div class="report-card">
                    <h3 data-translate="totalProducts">${t('totalProducts')}</h3>
                    <div class="report-value">${products.length}</div>
                    <div class="report-subtitle">${t('activeProducts')}</div>
                </div>
            </div>

            <div class="charts-section" id="charts-section" style="display: none;">
                <div class="charts-container">
                    <div class="chart-card">
                        <h3 data-translate="salesChart">${t('salesChart')}</h3>
                        <canvas id="salesChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-card">
                        <h3 data-translate="productChart">${t('productChart')}</h3>
                        <canvas id="productChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="reports-content">
                <div class="report-section">
                    <h3 data-translate="recentSales">${t('recentSales')}</h3>
                    <div class="sales-table">
                        <table>
                            <thead>
                                <tr>
                                    <th data-translate="date">${t('date')}</th>
                                    <th data-translate="receipt">${t('receipt')} #</th>
                                    <th data-translate="cashier">${t('cashier')}</th>
                                    <th data-translate="products">${t('products')}</th>
                                    <th data-translate="total">${t('total')}</th>
                                    <th data-translate="paymentMethod">${t('paymentMethod')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateRecentSalesRows()}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="report-section">
                    <h3 data-translate="topSellingProducts">${t('topSellingProducts')}</h3>
                    <div class="top-products">
                        ${generateTopProductsReport()}
                    </div>
                </div>

                <div class="report-section">
                    <h3 data-translate="cashierPerformance">${t('cashierPerformance')}</h3>
                    <div class="cashier-performance">
                        ${generateCashierPerformance()}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function getTodaysSales() {
    const today = new Date().toDateString();
    return salesHistory
        .filter(sale => new Date(sale.date).toDateString() === today)
        .reduce((sum, sale) => sum + sale.total, 0);
}

function getTodaysTransactions() {
    const today = new Date().toDateString();
    return salesHistory.filter(sale => new Date(sale.date).toDateString() === today).length;
}

function getWeekSales() {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return salesHistory
        .filter(sale => new Date(sale.date) >= weekAgo)
        .reduce((sum, sale) => sum + sale.total, 0);
}

function getWeekTransactions() {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    return salesHistory.filter(sale => new Date(sale.date) >= weekAgo).length;
}

function getLowStockCount() {
    return products.filter(product => product.stock <= product.minStock).length;
}

function generateRecentSalesRows() {
    const recentSales = salesHistory.slice(-10).reverse();
    return recentSales.map(sale => {
        const date = new Date(sale.date);
        return `
            <tr>
                <td>${date.toLocaleDateString()}</td>
                <td>${sale.id}</td>
                <td>${sale.cashier}</td>
                <td>${sale.items.length}</td>
                <td>${formatCurrency(sale.total)}</td>
                <td>${sale.paymentMethod}</td>
            </tr>
        `;
    }).join('');
}

function generateTopProductsReport() {
    const productSales = {};

    salesHistory.forEach(sale => {
        sale.items.forEach(item => {
            if (!productSales[item.id]) {
                productSales[item.id] = {
                    name: item.name,
                    quantity: 0,
                    revenue: 0
                };
            }
            productSales[item.id].quantity += item.quantity;
            productSales[item.id].revenue += item.price * item.quantity;
        });
    });

    const sortedProducts = Object.values(productSales)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);

    return sortedProducts.map((product, index) => `
        <div class="top-product-item">
            <span class="rank">#${index + 1}</span>
            <span class="product-name">${product.name}</span>
            <span class="quantity">${product.quantity} sold</span>
            <span class="revenue">${formatCurrency(product.revenue)}</span>
        </div>
    `).join('');
}

function generateCashierPerformance() {
    const cashierStats = {};

    salesHistory.forEach(sale => {
        if (!cashierStats[sale.cashier]) {
            cashierStats[sale.cashier] = {
                transactions: 0,
                revenue: 0
            };
        }
        cashierStats[sale.cashier].transactions++;
        cashierStats[sale.cashier].revenue += sale.total;
    });

    return Object.entries(cashierStats).map(([cashier, stats]) => `
        <div class="cashier-stat">
            <span class="cashier-name">${cashier}</span>
            <span class="transactions">${stats.transactions} transactions</span>
            <span class="revenue">${formatCurrency(stats.revenue)}</span>
        </div>
    `).join('');
}

function generateDailyReport() {
    const today = new Date().toDateString();
    const todaySales = salesHistory.filter(sale => new Date(sale.date).toDateString() === today);

    const reportWindow = window.open('', '_blank');
    const reportHTML = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${t('dailyReport')} - ${today}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .summary { background: #f5f5f5; padding: 20px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total { font-weight: bold; background: #f0f0f0; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${settings.companyName}</h1>
                <h2>${t('dailyReport')}</h2>
                <p>${t('date')}: ${today}</p>
            </div>

            <div class="summary">
                <h3>${t('summary')}</h3>
                <p>Total Sales: ${formatCurrency(todaySales.reduce((sum, sale) => sum + sale.total, 0))}</p>
                <p>Total Transactions: ${todaySales.length}</p>
                <p>Average Transaction: ${formatCurrency(todaySales.reduce((sum, sale) => sum + sale.total, 0) / todaySales.length || 0)}</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th data-translate="time">${t('time')}</th>
                        <th data-translate="receipt">${t('receipt')} #</th>
                        <th data-translate="cashier">${t('cashier')}</th>
                        <th data-translate="items">${t('items')}</th>
                        <th data-translate="total">${t('total')}</th>
                        <th data-translate="paymentMethod">${t('paymentMethod')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${todaySales.map(sale => `
                        <tr>
                            <td>${new Date(sale.date).toLocaleTimeString()}</td>
                            <td>${sale.id}</td>
                            <td>${sale.cashier}</td>
                            <td>${sale.items.length}</td>
                            <td>${formatCurrency(sale.total)}</td>
                            <td>${sale.paymentMethod}</td>
                        </tr>
                    `).join('')}
                    <tr class="total">
                        <td colspan="4"><strong>TOTAL</strong></td>
                        <td><strong>${formatCurrency(todaySales.reduce((sum, sale) => sum + sale.total, 0))}</strong></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </body>
        </html>
    `;

    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
    reportWindow.focus();
    reportWindow.print();
}

function generateWeeklyReport() {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weeklySales = salesHistory.filter(sale => new Date(sale.date) >= weekAgo);

    const reportWindow = window.open('', '_blank');
    const reportHTML = `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" lang="${currentLanguage}">
        <head>
            <title>${t('weeklyReport')} - ${settings.companyName}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .summary { background: #f5f5f5; padding: 20px; margin-bottom: 20px; }
                table { width: 100%; border-collapse: collapse; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background: #667eea; color: white; }
                .total { font-weight: bold; background: #f0f0f0; }
                [dir="rtl"] th, [dir="rtl"] td { text-align: right; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${settings.companyName}</h1>
                <h2>${t('weeklyReport')}</h2>
                <p>${t('date')}: ${weekAgo.toLocaleDateString()} - ${new Date().toLocaleDateString()}</p>
            </div>

            <div class="summary">
                <h3>${t('summary')}</h3>
                <p><strong>${t('totalSales')}:</strong> ${formatCurrency(weeklySales.reduce((sum, sale) => sum + sale.total, 0))}</p>
                <p><strong>${t('totalTransactions')}:</strong> ${weeklySales.length}</p>
                <p><strong>${t('averageTransaction')}:</strong> ${formatCurrency(weeklySales.reduce((sum, sale) => sum + sale.total, 0) / weeklySales.length || 0)}</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>${t('date')}</th>
                        <th>${t('receipt')} #</th>
                        <th>${t('cashier')}</th>
                        <th>${t('products')}</th>
                        <th>${t('total')}</th>
                        <th>${t('paymentMethod')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${weeklySales.map(sale => `
                        <tr>
                            <td>${new Date(sale.date).toLocaleDateString()}</td>
                            <td>${sale.id}</td>
                            <td>${sale.cashier}</td>
                            <td>${sale.items.length}</td>
                            <td>${formatCurrency(sale.total)}</td>
                            <td>${sale.paymentMethod}</td>
                        </tr>
                    `).join('')}
                    <tr class="total">
                        <td colspan="4"><strong>${t('total').toUpperCase()}</strong></td>
                        <td><strong>${formatCurrency(weeklySales.reduce((sum, sale) => sum + sale.total, 0))}</strong></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </body>
        </html>
    `;

    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
    reportWindow.focus();
    reportWindow.print();
}

// ===== INVOICE SYSTEM =====

function printInvoice(sale = null) {
    if (!sale && cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    let invoiceData;
    if (sale) {
        invoiceData = sale;
    } else {
        // Create temporary invoice data for current cart
        const subtotal = cart.reduce((sum, item) => sum + (convertPrice(item.price) * item.quantity), 0);
        const tax = subtotal * settings.taxRate;
        const total = subtotal + tax;

        invoiceData = {
            id: 'INV-' + Date.now(),
            date: new Date().toISOString(),
            cashier: currentUser.name,
            items: [...cart],
            subtotal: subtotal / currencies[currentCurrency].rate,
            tax: tax / currencies[currentCurrency].rate,
            total: total / currencies[currentCurrency].rate,
            paymentMethod: 'N/A',
            currency: currentCurrency
        };
    }

    const invoiceWindow = window.open('', '_blank');
    const invoiceHTML = generateInvoiceHTML(invoiceData);

    invoiceWindow.document.write(invoiceHTML);
    invoiceWindow.document.close();
    invoiceWindow.focus();
    invoiceWindow.print();
}

function generateInvoiceHTML(sale) {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US');
    const formattedTime = date.toLocaleTimeString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US');

    return `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" lang="${currentLanguage}">
        <head>
            <meta charset="UTF-8">
            <title>${t('businessInvoice')} - ${sale.id}</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #333;
                }
                .invoice-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 40px;
                    border-bottom: 3px solid #667eea;
                    padding-bottom: 20px;
                }
                .company-info h1 {
                    color: #667eea;
                    margin: 0 0 10px 0;
                    font-size: 28px;
                }
                .invoice-details {
                    text-align: right;
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                }
                .invoice-title {
                    font-size: 24px;
                    color: #667eea;
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .customer-section {
                    margin: 30px 0;
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                }
                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 30px 0;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }
                .items-table th, .items-table td {
                    border: 1px solid #ddd;
                    padding: 12px;
                    text-align: left;
                }
                .items-table th {
                    background: #667eea;
                    color: white;
                    font-weight: bold;
                }
                .items-table tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .totals-section {
                    margin-top: 30px;
                    display: flex;
                    justify-content: flex-end;
                }
                .totals-table {
                    width: 300px;
                    border-collapse: collapse;
                }
                .totals-table td {
                    padding: 8px 15px;
                    border: 1px solid #ddd;
                }
                .total-row {
                    font-weight: bold;
                    background: #667eea;
                    color: white;
                    font-size: 16px;
                }
                .footer {
                    text-align: center;
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 1px solid #ddd;
                    color: #666;
                }
                [dir="rtl"] .invoice-details {
                    text-align: left;
                }
                [dir="rtl"] .items-table th, [dir="rtl"] .items-table td {
                    text-align: right;
                }
                @media print {
                    body { margin: 0; padding: 10px; }
                }
            </style>
        </head>
        <body>
            <div class="invoice-header">
                <div class="company-info">
                    <h1>${settings.companyName}</h1>
                    <div>${settings.companyAddress}</div>
                    <div>${settings.companyPhone}</div>
                </div>
                <div class="invoice-details">
                    <div class="invoice-title">${t('businessInvoice')}</div>
                    <div><strong>${t('invoice')} #:</strong> ${sale.id}</div>
                    <div><strong>${t('date')}:</strong> ${formattedDate}</div>
                    <div><strong>${t('time')}:</strong> ${formattedTime}</div>
                    <div><strong>${t('cashier')}:</strong> ${sale.cashier}</div>
                </div>
            </div>

            <div class="customer-section">
                <h3>${t('customerInfo')}</h3>
                <div><strong>${t('currency')}:</strong> ${getCurrencyName(sale.currency)}</div>
                <div><strong>${t('paymentMethod')}:</strong> ${sale.paymentMethod}</div>
            </div>

            <table class="items-table">
                <thead>
                    <tr>
                        <th>${t('description')}</th>
                        <th>${t('quantity')}</th>
                        <th>${t('price')}</th>
                        <th>${t('total')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${sale.items.map(item => {
                        const itemName = getProductName(item);
                        const itemTotal = item.price * item.quantity;
                        return `
                            <tr>
                                <td>${itemName}</td>
                                <td>${item.quantity}</td>
                                <td>${formatCurrency(item.price)}</td>
                                <td>${formatCurrency(itemTotal)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="totals-section">
                <table class="totals-table">
                    <tr>
                        <td>${t('subtotal')}:</td>
                        <td>${formatCurrency(sale.subtotal)}</td>
                    </tr>
                    <tr>
                        <td>${t('tax')} (${(settings.taxRate * 100).toFixed(0)}%):</td>
                        <td>${formatCurrency(sale.tax)}</td>
                    </tr>
                    <tr class="total-row">
                        <td>${t('total')}:</td>
                        <td>${formatCurrency(sale.total)}</td>
                    </tr>
                </table>
            </div>

            <div class="footer">
                <div>${settings.receiptFooter}</div>
                <div style="margin-top: 10px; font-size: 12px;">
                    ${t('businessInvoice')} - ${settings.companyName}
                </div>
            </div>
        </body>
        </html>
    `;
}

// ===== LOW STOCK & EXPIRED ITEMS PRINTING =====

function printLowStockReport() {
    const lowStockProducts = products.filter(product =>
        product.active && product.stock <= product.minStock
    );

    if (lowStockProducts.length === 0) {
        alert(t('noLowStockItems'));
        return;
    }

    const reportWindow = window.open('', '_blank');
    const reportHTML = generateLowStockReportHTML(lowStockProducts);

    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
    reportWindow.focus();
    reportWindow.print();
}

function printExpiredItemsReport() {
    const expiredProducts = products.filter(product =>
        product.active && product.expiryDate && new Date(product.expiryDate) < new Date()
    );

    const nearExpiryProducts = products.filter(product =>
        product.active && product.expiryDate &&
        new Date(product.expiryDate) <= new Date(Date.now() + 3 * 24 * 60 * 60 * 1000) &&
        new Date(product.expiryDate) >= new Date()
    );

    if (expiredProducts.length === 0 && nearExpiryProducts.length === 0) {
        alert(t('noExpiredItems'));
        return;
    }

    const reportWindow = window.open('', '_blank');
    const reportHTML = generateExpiredItemsReportHTML(expiredProducts, nearExpiryProducts);

    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
    reportWindow.focus();
    reportWindow.print();
}

function generateLowStockReportHTML(lowStockProducts) {
    const currentDate = new Date().toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US');

    return `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" lang="${currentLanguage}">
        <head>
            <meta charset="UTF-8">
            <title>${t('lowStockReport')} - ${currentDate}</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    font-size: 14px;
                    line-height: 1.6;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #dc3545;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #dc3545;
                    margin-bottom: 10px;
                }
                .summary {
                    background: #f8d7da;
                    padding: 20px;
                    margin-bottom: 20px;
                    border-radius: 8px;
                    border-left: 4px solid #dc3545;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 12px;
                    text-align: left;
                }
                th {
                    background: #dc3545;
                    color: white;
                    font-weight: bold;
                }
                tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .urgent {
                    background: #f8d7da !important;
                    font-weight: bold;
                }
                .footer {
                    text-align: center;
                    margin-top: 30px;
                    color: #666;
                }
                [dir="rtl"] th, [dir="rtl"] td {
                    text-align: right;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${settings.companyName}</h1>
                <h2>${t('lowStockReport')}</h2>
                <p>${t('date')}: ${currentDate}</p>
            </div>

            <div class="summary">
                <h3>${t('summary')}</h3>
                <p><strong>${t('totalProducts')}:</strong> ${lowStockProducts.length} ${t('itemsNeedRestocking')}</p>
                <p><strong>${t('urgentAction')}:</strong> ${t('restockImmediately')}</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>${t('productName')}</th>
                        <th>${t('category')}</th>
                        <th>${t('currentStock')}</th>
                        <th>${t('minimumStock')}</th>
                        <th>${t('supplier')}</th>
                        <th>${t('status')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${lowStockProducts.map(product => {
                        const productName = getProductName(product);
                        const isUrgent = product.stock === 0;
                        return `
                            <tr class="${isUrgent ? 'urgent' : ''}">
                                <td>${productName}</td>
                                <td>${t(product.category)}</td>
                                <td>${product.stock}</td>
                                <td>${product.minStock}</td>
                                <td>${product.supplier || t('notAvailable')}</td>
                                <td>${isUrgent ? t('outOfStock') : t('lowStock')}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="footer">
                <p>${t('generatedBy')}: ${settings.companyName} POS System</p>
                <p>${t('printedOn')}: ${new Date().toLocaleString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</p>
            </div>
        </body>
        </html>
    `;
}

function generateExpiredItemsReportHTML(expiredProducts, nearExpiryProducts) {
    const currentDate = new Date().toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US');

    return `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}" lang="${currentLanguage}">
        <head>
            <meta charset="UTF-8">
            <title>${t('expiredItems')} ${t('report')} - ${currentDate}</title>
            <style>
                body {
                    font-family: 'Arial', sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    font-size: 14px;
                    line-height: 1.6;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #dc3545;
                    padding-bottom: 20px;
                }
                .header h1 {
                    color: #dc3545;
                    margin-bottom: 10px;
                }
                .summary {
                    background: #f8d7da;
                    padding: 20px;
                    margin-bottom: 20px;
                    border-radius: 8px;
                    border-left: 4px solid #dc3545;
                }
                .section {
                    margin-bottom: 30px;
                }
                .section h3 {
                    color: #dc3545;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 10px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 12px;
                    text-align: left;
                }
                th {
                    background: #dc3545;
                    color: white;
                    font-weight: bold;
                }
                tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .expired-row {
                    background: #f8d7da !important;
                    font-weight: bold;
                }
                .near-expiry-row {
                    background: #fff3cd !important;
                }
                .footer {
                    text-align: center;
                    margin-top: 30px;
                    color: #666;
                }
                [dir="rtl"] th, [dir="rtl"] td {
                    text-align: right;
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${settings.companyName}</h1>
                <h2>${t('expiredItems')} ${t('report')}</h2>
                <p>${t('date')}: ${currentDate}</p>
            </div>

            <div class="summary">
                <h3>${t('summary')}</h3>
                <p><strong>${t('expired')}:</strong> ${expiredProducts.length} ${t('products')}</p>
                <p><strong>${t('nearExpiry')}:</strong> ${nearExpiryProducts.length} ${t('products')}</p>
                <p><strong>${t('urgentAction')}:</strong> Remove expired items immediately</p>
            </div>

            ${expiredProducts.length > 0 ? `
            <div class="section">
                <h3>${t('expired')} ${t('products')}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>${t('productName')}</th>
                            <th>${t('category')}</th>
                            <th>${t('expiryDate')}</th>
                            <th>${t('daysOverdue')}</th>
                            <th>${t('currentStock')}</th>
                            <th>${t('supplier')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expiredProducts.map(product => {
                            const productName = getProductName(product);
                            const expiryDate = new Date(product.expiryDate);
                            const daysOverdue = Math.floor((new Date() - expiryDate) / (1000 * 60 * 60 * 24));
                            return `
                                <tr class="expired-row">
                                    <td>${productName}</td>
                                    <td>${t(product.category)}</td>
                                    <td>${expiryDate.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                                    <td>${daysOverdue}</td>
                                    <td>${product.stock}</td>
                                    <td>${product.supplier || t('notAvailable')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}

            ${nearExpiryProducts.length > 0 ? `
            <div class="section">
                <h3>${t('nearExpiry')} ${t('products')}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>${t('productName')}</th>
                            <th>${t('category')}</th>
                            <th>${t('expiryDate')}</th>
                            <th>${t('daysUntilExpiry')}</th>
                            <th>${t('currentStock')}</th>
                            <th>${t('supplier')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${nearExpiryProducts.map(product => {
                            const productName = getProductName(product);
                            const expiryDate = new Date(product.expiryDate);
                            const daysUntilExpiry = Math.floor((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
                            return `
                                <tr class="near-expiry-row">
                                    <td>${productName}</td>
                                    <td>${t(product.category)}</td>
                                    <td>${expiryDate.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</td>
                                    <td>${daysUntilExpiry}</td>
                                    <td>${product.stock}</td>
                                    <td>${product.supplier || t('notAvailable')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            ` : ''}

            <div class="footer">
                <p>${t('generatedBy')}: ${settings.companyName} POS System</p>
                <p>${t('printedOn')}: ${new Date().toLocaleString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</p>
            </div>
        </body>
        </html>
    `;
}

// ===== USERS MANAGEMENT =====

function loadUsersView() {
    if (!hasPermission('users')) {
        document.getElementById('users-view').innerHTML = `
            <div class="access-denied">
                <h2>Access Denied</h2>
                <p>You don't have permission to manage users.</p>
            </div>
        `;
        return;
    }

    const usersView = document.getElementById('users-view');
    usersView.innerHTML = `
        <div class="users-header">
            <h2 data-translate="users">${t('users')}</h2>
            <div class="users-actions">
                <button class="btn btn-primary" onclick="showAddUserModal()" data-translate="addUser">${t('addUser')}</button>
                <button class="btn btn-secondary" onclick="exportUsers()" data-translate="exportUsers">${t('exportUsers')}</button>
            </div>
        </div>

        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th data-translate="id">${t('id')}</th>
                        <th data-translate="username">${t('username')}</th>
                        <th data-translate="name">${t('name')}</th>
                        <th data-translate="role">${t('role')}</th>
                        <th data-translate="cardNumber">${t('cardNumber')}</th>
                        <th data-translate="cardAccess">${t('cardAccess')}</th>
                        <th data-translate="status">${t('status')}</th>
                        <th data-translate="actions">${t('actions')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${generateUsersRows()}
                </tbody>
            </table>
        </div>
    `;
}

function generateUsersRows() {
    return users.map(user => `
        <tr class="${user.active ? '' : 'inactive'}">
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.name}</td>
            <td>
                <span class="role-badge role-${user.role}">${t(user.role)}</span>
            </td>
            <td>${user.cardNumber || t('notAvailable')}</td>
            <td>
                <span class="status-badge ${user.cardAccess ? 'active' : 'inactive'}">
                    ${user.cardAccess ? t('active') : t('inactive')}
                </span>
            </td>
            <td>
                <span class="status-badge ${user.active ? 'active' : 'inactive'}">
                    ${user.active ? t('active') : t('inactive')}
                </span>
            </td>
            <td class="actions">
                <button class="btn-small btn-primary" onclick="editUser(${user.id})">${t('edit')}</button>
                <button class="btn-small ${user.active ? 'btn-warning' : 'btn-success'}"
                        onclick="toggleUserStatus(${user.id})"
                        data-translate="${user.active ? 'deactivate' : 'activate'}">
                    ${user.active ? t('deactivate') : t('activate')}
                </button>
                ${user.id !== currentUser.id ? `<button class="btn-small btn-danger" onclick="deleteUser(${user.id})">${t('delete')}</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function showAddUserModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Add New User</h2>
            <form onsubmit="addNewUser(event)">
                <div class="form-group">
                    <label data-translate="username">${t('username')}:</label>
                    <input type="text" id="user-username" required>
                </div>
                <div class="form-group">
                    <label data-translate="fullName">${t('fullName')}:</label>
                    <input type="text" id="user-name" required>
                </div>
                <div class="form-group">
                    <label data-translate="password">${t('password')}:</label>
                    <input type="password" id="user-password" required>
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="user-role" required>
                        <option value="cashier">${t('cashier')}</option>
                        <option value="manager">${t('manager')}</option>
                        ${currentUser.role === 'admin' ? `<option value="admin">${t('admin')}</option>` : ''}
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function addNewUser(event) {
    event.preventDefault();

    const username = document.getElementById('user-username').value;

    // Check if username already exists
    if (users.find(u => u.username === username)) {
        alert('Username already exists!');
        return;
    }

    const newUser = {
        id: Math.max(...users.map(u => u.id)) + 1,
        username: username,
        name: document.getElementById('user-name').value,
        password: document.getElementById('user-password').value,
        role: document.getElementById('user-role').value,
        active: true
    };

    users.push(newUser);
    saveToStorage('users', users);

    closeModal();
    loadUsersView();

    alert(`User "${newUser.name}" added successfully!`);
}

function editUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2>Edit User</h2>
            <form onsubmit="updateUser(event, ${userId})">
                <div class="form-group">
                    <label data-translate="username">${t('username')}:</label>
                    <input type="text" id="edit-user-username" value="${user.username}" required>
                </div>
                <div class="form-group">
                    <label data-translate="fullName">${t('fullName')}:</label>
                    <input type="text" id="edit-user-name" value="${user.name}" required>
                </div>
                <div class="form-group">
                    <label data-translate="newPassword">${t('newPassword')}:</label>
                    <input type="password" id="edit-user-password">
                </div>
                <div class="form-group">
                    <label>Role:</label>
                    <select id="edit-user-role" required>
                        <option value="cashier" ${user.role === 'cashier' ? 'selected' : ''}>${t('cashier')}</option>
                        <option value="manager" ${user.role === 'manager' ? 'selected' : ''}>${t('manager')}</option>
                        ${currentUser.role === 'admin' ? `<option value="admin" ${user.role === 'admin' ? 'selected' : ''}>${t('admin')}</option>` : ''}
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateUser(event, userId) {
    event.preventDefault();

    const user = users.find(u => u.id === userId);
    if (!user) return;

    const newUsername = document.getElementById('edit-user-username').value;

    // Check if username already exists (excluding current user)
    if (users.find(u => u.username === newUsername && u.id !== userId)) {
        alert('Username already exists!');
        return;
    }

    user.username = newUsername;
    user.name = document.getElementById('edit-user-name').value;
    user.role = document.getElementById('edit-user-role').value;

    const newPassword = document.getElementById('edit-user-password').value;
    if (newPassword) {
        user.password = newPassword;
    }

    saveToStorage('users', users);

    closeModal();
    loadUsersView();

    alert(`User "${user.name}" updated successfully!`);
}

function toggleUserStatus(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    if (user.id === currentUser.id) {
        alert("You cannot deactivate your own account!");
        return;
    }

    user.active = !user.active;
    saveToStorage('users', users);

    loadUsersView();

    alert(`User "${user.name}" ${user.active ? 'activated' : 'deactivated'} successfully!`);
}

function deleteUser(userId) {
    const user = users.find(u => u.id === userId);
    if (!user) return;

    if (user.id === currentUser.id) {
        alert("You cannot delete your own account!");
        return;
    }

    if (confirm(`Are you sure you want to delete user "${user.name}"?`)) {
        const index = users.findIndex(u => u.id === userId);
        users.splice(index, 1);
        saveToStorage('users', users);

        loadUsersView();

        alert(`User "${user.name}" deleted successfully!`);
    }
}

// ===== SETTINGS MANAGEMENT =====

function loadSettingsView() {
    // Only administrators can access system settings
    if (!currentUser || currentUser.role !== 'admin') {
        document.getElementById('settings-view').innerHTML = `
            <div class="access-denied">
                <h2 data-translate="accessDenied">${t('accessDenied')}</h2>
                <p data-translate="adminOnlySettings">${t('adminOnlySettings')}</p>
                <div class="access-denied-icon">🔒</div>
                <p class="access-denied-note">${t('contactAdministrator')}</p>
            </div>
        `;
        return;
    }

    const settingsView = document.getElementById('settings-view');
    settingsView.innerHTML = `
        <div class="settings-header">
            <h2 data-translate="settings">${t('settings')}</h2>
            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSettings()" data-translate="saveSettings">${t('saveSettings')}</button>
                <button class="btn btn-secondary" onclick="resetSettings()" data-translate="resetSettings">${t('resetSettings')}</button>
                <button class="btn btn-warning" onclick="exportData()" data-translate="exportData">${t('exportData')}</button>
                <button class="btn btn-success" onclick="importData()" data-translate="importData">${t('importData')}</button>
            </div>
        </div>

        <div class="settings-content">
            <div class="settings-section">
                <h3 data-translate="companySettings">${t('companySettings')}</h3>
                <div class="form-group">
                    <label data-translate="name">${t('name')}:</label>
                    <input type="text" id="setting-company-name" value="${settings.companyName}">
                </div>
                <div class="form-group">
                    <label data-translate="address">${t('address')}:</label>
                    <input type="text" id="setting-company-address" value="${settings.companyAddress}">
                </div>
                <div class="form-group">
                    <label data-translate="phone">${t('phone')}:</label>
                    <input type="text" id="setting-company-phone" value="${settings.companyPhone}">
                </div>
                <div class="form-group">
                    <label data-translate="receiptFooter">${t('receiptFooter')}:</label>
                    <textarea id="setting-receipt-footer">${settings.receiptFooter}</textarea>
                </div>
            </div>

            <div class="settings-section">
                <h3 data-translate="logoSettings">${t('logoSettings')}</h3>
                <div class="logo-upload-section">
                    <div class="current-logo">
                        ${settings.companyLogo ? `
                            <img src="${settings.companyLogo}" alt="Company Logo" id="current-logo-preview" style="max-width: 200px; max-height: 100px; border: 1px solid #ddd; border-radius: 8px;">
                            <button type="button" class="btn btn-danger btn-small" onclick="removeLogo()" data-translate="removeLogo">${t('removeLogo')}</button>
                        ` : `
                            <div class="no-logo" style="width: 200px; height: 100px; border: 2px dashed #ddd; display: flex; align-items: center; justify-content: center; color: #666; border-radius: 8px;">
                                ${t('companyLogo')}
                            </div>
                        `}
                    </div>
                    <div class="logo-upload-controls">
                        <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('logo-upload').click()" data-translate="uploadLogo">${t('uploadLogo')}</button>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            ${t('recommendedSize')}: 200x100px, PNG/JPG
                        </p>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>System Settings</h3>
                <div class="form-group">
                    <label>Tax Rate (%):</label>
                    <input type="number" id="setting-tax-rate" step="0.01" value="${(settings.taxRate * 100).toFixed(2)}">
                </div>
                <div class="form-group">
                    <label>Low Stock Threshold:</label>
                    <input type="number" id="setting-low-stock-threshold" value="${settings.lowStockThreshold}">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-auto-backup" ${settings.autoBackup ? 'checked' : ''}>
                        Enable Auto Backup
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-print-after-sale" ${settings.printAfterSale ? 'checked' : ''}>
                        Auto Print Receipt After Sale
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="setting-show-barcode" ${settings.showBarcode ? 'checked' : ''}>
                        Show Barcodes on Products
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3>Default Language & Currency</h3>
                <div class="form-group">
                    <label>Default Language:</label>
                    <select id="setting-default-language">
                        <option value="en" ${currentLanguage === 'en' ? 'selected' : ''}>🇺🇸 English</option>
                        <option value="ar" ${currentLanguage === 'ar' ? 'selected' : ''}>🇩🇿 العربية</option>
                        <option value="fr" ${currentLanguage === 'fr' ? 'selected' : ''}>🇫🇷 Français</option>
                        <option value="es" ${currentLanguage === 'es' ? 'selected' : ''}>🇪🇸 Español</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Default Currency:</label>
                    <select id="setting-default-currency">
                        ${Object.entries(currencies).map(([code, curr]) =>
                            `<option value="${code}" ${currentCurrency === code ? 'selected' : ''}>${curr.symbol} ${curr.name}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h3>Data Management</h3>
                <div class="data-stats">
                    <p><strong>Products:</strong> ${products.length} items</p>
                    <p><strong>Sales History:</strong> ${salesHistory.length} transactions</p>
                    <p><strong>Users:</strong> ${users.length} accounts</p>
                    <p><strong>Last Backup:</strong> ${localStorage.getItem('lastBackup') || 'Never'}</p>
                </div>
                <div class="data-actions">
                    <button class="btn btn-info" onclick="createBackup()" data-translate="createBackup">${t('createBackup')}</button>
                    <button class="btn btn-warning" onclick="clearAllData()" data-translate="clearAllData">${t('clearAllData')}</button>
                </div>
            </div>
        </div>
    `;
}

function saveSettings() {
    settings.companyName = document.getElementById('setting-company-name').value;
    settings.companyAddress = document.getElementById('setting-company-address').value;
    settings.companyPhone = document.getElementById('setting-company-phone').value;
    settings.receiptFooter = document.getElementById('setting-receipt-footer').value;
    settings.taxRate = parseFloat(document.getElementById('setting-tax-rate').value) / 100;
    settings.lowStockThreshold = parseInt(document.getElementById('setting-low-stock-threshold').value);
    settings.autoBackup = document.getElementById('setting-auto-backup').checked;
    settings.printAfterSale = document.getElementById('setting-print-after-sale').checked;
    settings.showBarcode = document.getElementById('setting-show-barcode').checked;

    // Save to localStorage
    Object.keys(settings).forEach(key => {
        localStorage.setItem(key, settings[key]);
    });

    // Update language and currency if changed
    const newLanguage = document.getElementById('setting-default-language').value;
    const newCurrency = document.getElementById('setting-default-currency').value;

    if (newLanguage !== currentLanguage) {
        changeLanguage(newLanguage);
    }

    if (newCurrency !== currentCurrency) {
        changeCurrency(newCurrency);
    }

    alert('Settings saved successfully!');

    // Refresh displays
    displayProducts();
    updateCartDisplay();
}

function createBackup() {
    const backupData = {
        products: products,
        salesHistory: salesHistory,
        users: users,
        settings: settings,
        timestamp: new Date().toISOString()
    };

    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `pos-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    localStorage.setItem('lastBackup', new Date().toLocaleString());

    alert('Backup created successfully!');
}

// ===== MISSING BUTTON FUNCTIONS =====

function exportInventory() {
    const inventoryData = products.map(product => ({
        id: product.id,
        name: getProductName(product),
        category: t(product.category),
        price: formatCurrency(product.price),
        stock: product.stock,
        minStock: product.minStock,
        barcode: product.barcode,
        supplier: product.supplier || t('notAvailable'),
        expiryDate: product.expiryDate || t('notAvailable')
    }));

    const csvContent = "data:text/csv;charset=utf-8,"
        + [
            [t('name'), t('category'), t('price'), t('stock'), t('minStock'), t('barcode'), t('supplier'), t('expiryDate')].join(','),
            ...inventoryData.map(row => Object.values(row).join(','))
        ].join('\n');

    const link = document.createElement('a');
    link.href = encodeURI(csvContent);
    link.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    alert(t('inventoryExported'));
}

function exportReports() {
    const reportsData = {
        todaysSales: getTodaysSales(),
        weekSales: getWeekSales(),
        lowStockCount: getLowStockCount(),
        totalProducts: products.length,
        recentSales: salesHistory.slice(-10),
        generatedAt: new Date().toISOString()
    };

    const dataStr = JSON.stringify(reportsData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `reports-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    alert(t('reportsExported'));
}

function exportUsers() {
    if (!hasPermission('users')) {
        alert(t('accessDenied'));
        return;
    }

    const usersData = users.map(user => ({
        id: user.id,
        username: user.username,
        name: user.name,
        role: t(user.role),
        status: user.active ? t('active') : t('inactive')
    }));

    const csvContent = "data:text/csv;charset=utf-8,"
        + [
            [t('id'), t('username'), t('name'), t('role'), t('status')].join(','),
            ...usersData.map(row => Object.values(row).join(','))
        ].join('\n');

    const link = document.createElement('a');
    link.href = encodeURI(csvContent);
    link.download = `users-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    alert(t('usersExported'));
}

function resetSettings() {
    if (confirm(t('confirmResetSettings'))) {
        // Reset to default values
        const defaultSettings = {
            taxRate: 0.19,
            companyName: 'My POS System',
            companyAddress: 'Algiers, Algeria',
            companyPhone: '+213 21 123 456',
            receiptFooter: 'شكراً لزيارتكم - Thank you for your visit!',
            companyLogo: '',
            lowStockThreshold: 10,
            autoBackup: false,
            printAfterSale: false,
            showBarcode: false
        };

        // Update settings object
        Object.assign(settings, defaultSettings);

        // Clear localStorage
        Object.keys(defaultSettings).forEach(key => {
            localStorage.removeItem(key);
        });

        // Refresh settings view
        loadSettingsView();

        // Update main interface
        updateMainLogo();

        alert(t('settingsReset'));
    }
}

function exportData() {
    const allData = {
        products: products,
        salesHistory: salesHistory,
        users: users.map(u => ({...u, password: '***'})), // Hide passwords
        settings: settings,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };

    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});

    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `pos-data-export-${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    alert(t('dataExported'));
}

function importData() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);

                if (confirm(t('confirmImportData'))) {
                    // Import products (if available)
                    if (importedData.products) {
                        products.splice(0, products.length, ...importedData.products);
                        saveToStorage('products', products);
                    }

                    // Import sales history (if available)
                    if (importedData.salesHistory) {
                        salesHistory.splice(0, salesHistory.length, ...importedData.salesHistory);
                        saveToStorage('salesHistory', salesHistory);
                    }

                    // Import settings (if available)
                    if (importedData.settings) {
                        Object.assign(settings, importedData.settings);
                        Object.keys(importedData.settings).forEach(key => {
                            localStorage.setItem(key, importedData.settings[key]);
                        });
                    }

                    alert(t('dataImported'));
                    location.reload(); // Refresh to apply changes
                }
            } catch (error) {
                alert(t('importError') + ': ' + error.message);
            }
        };
        reader.readAsText(file);
    };

    input.click();
}

function clearAllData() {
    if (confirm(t('confirmClearAllData'))) {
        if (confirm(t('confirmClearAllDataFinal'))) {
            // Clear all data except users (for security)
            products.splice(0, products.length);
            salesHistory.splice(0, salesHistory.length);

            // Save empty arrays
            saveToStorage('products', products);
            saveToStorage('salesHistory', salesHistory);

            // Clear cart
            cart.splice(0, cart.length);

            alert(t('allDataCleared'));
            location.reload();
        }
    }
}

function startCameraScanning() {
    // This function is already implemented above
    // Just ensuring it's available
    console.log('Camera scanning started');
}

function connectUSBScanner() {
    // This function is already implemented above
    // Just ensuring it's available
    console.log('USB scanner connected');
}

// ===== DYNAMIC CATEGORY BUTTONS =====

function generateCategoryButtons() {
    // Always start with "All Items" button
    let buttonsHTML = `<button class="category-btn active" data-category="all" data-translate="allItems">${t('allItems')}</button>`;

    // Add buttons for active categories from database
    const activeCategories = categories.filter(category => category.active);

    activeCategories.forEach(category => {
        const categoryKey = category.name.toLowerCase();
        const categoryName = getCategoryName(category);

        buttonsHTML += `<button class="category-btn" data-category="${categoryKey}" title="${categoryName}">${categoryName}</button>`;
    });

    return buttonsHTML;
}

function updateCategoryButtons() {
    const categoryButtonsContainer = document.getElementById('category-buttons');
    if (categoryButtonsContainer) {
        categoryButtonsContainer.innerHTML = generateCategoryButtons();

        // Re-attach event listeners for category buttons
        attachCategoryButtonListeners();
    }
}

function attachCategoryButtonListeners() {
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));

            // Add active class to clicked button
            this.classList.add('active');

            // Filter products by category
            const category = this.dataset.category;
            filterProductsByCategory(category);
        });
    });
}

function filterProductsByCategory(category) {
    if (category === 'all') {
        displayProducts(); // Show all products
    } else {
        // Filter products by the selected category
        const filteredProducts = products.filter(product =>
            product.category.toLowerCase() === category.toLowerCase()
        );
        displayFilteredProducts(filteredProducts);
    }
}

function displayFilteredProducts(filteredProducts) {
    const productsGrid = document.getElementById('products-grid');
    if (!productsGrid) return;

    if (filteredProducts.length === 0) {
        productsGrid.innerHTML = `
            <div class="no-products">
                <h3>${t('noProductsFound')}</h3>
                <p>${t('tryDifferentCategory')}</p>
            </div>
        `;
        return;
    }

    productsGrid.innerHTML = '';

    filteredProducts.forEach(product => {
        const productName = getProductName(product);
        const isLowStock = product.stock <= product.minStock;
        const isOutOfStock = product.stock === 0;

        let statusClass = '';
        let statusBadge = '';

        if (isOutOfStock) {
            statusClass = 'out-of-stock';
            statusBadge = `<span class="stock-badge out-of-stock">${t('outOfStock')}</span>`;
        } else if (isLowStock) {
            statusClass = 'low-stock';
            statusBadge = `<span class="stock-badge low-stock">${t('lowStock')}</span>`;
        }

        const productCard = document.createElement('div');
        productCard.className = `product-card ${statusClass}`;
        productCard.innerHTML = `
            ${product.image ? `<div class="product-image"><img src="${product.image}" alt="${productName}" /></div>` : ''}
            <div class="product-info">
                <h3>${productName}</h3>
                <div class="price">${formatPrice(product.price)}</div>
                <div class="stock-info">
                    <span class="stock-count">${t('stock')}: ${product.stock}</span>
                    ${statusBadge}
                </div>
                ${product.expiryDate ? `<div class="expiry-date">${t('expiryDate')}: ${new Date(product.expiryDate).toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</div>` : ''}
                ${settings.showBarcode ? `<div class="barcode">${product.barcode}</div>` : ''}
            </div>
        `;

        if (!isOutOfStock) {
            productCard.addEventListener('click', () => addToCart(product));
        }

        productsGrid.appendChild(productCard);
    });
}

// ===== CATEGORIES MANAGEMENT =====

function loadCategoriesView() {
    if (!hasPermission('inventory')) {
        document.getElementById('categories-view').innerHTML = `
            <div class="access-denied">
                <h2>${t('accessDenied')}</h2>
                <p>${t('noPermissionCategories')}</p>
            </div>
        `;
        return;
    }

    const categoriesView = document.getElementById('categories-view');
    categoriesView.innerHTML = `
        <div class="categories-header">
            <h2 data-translate="categoryManagement">${t('categoryManagement')}</h2>
            <div class="categories-actions">
                <button class="btn btn-primary" onclick="showAddCategoryModal()" data-translate="addCategory">${t('addCategory')}</button>
                <button class="btn btn-secondary" onclick="exportCategories()" data-translate="export">${t('export')}</button>
            </div>
        </div>

        <div class="categories-table">
            <table>
                <thead>
                    <tr>
                        <th data-translate="id">${t('id')}</th>
                        <th data-translate="categoryName">${t('categoryName')}</th>
                        <th data-translate="status">${t('status')}</th>
                        <th data-translate="actions">${t('actions')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${generateCategoriesRows()}
                </tbody>
            </table>
        </div>
    `;
}

function generateCategoriesRows() {
    return categories.map(category => `
        <tr class="${category.active ? '' : 'inactive'}">
            <td>${category.id}</td>
            <td>${getCategoryName(category)}</td>
            <td>
                <span class="status-badge ${category.active ? 'active' : 'inactive'}">
                    ${category.active ? t('active') : t('inactive')}
                </span>
            </td>
            <td class="actions">
                <button class="btn-small btn-primary" onclick="editCategory(${category.id})" data-translate="edit">${t('edit')}</button>
                <button class="btn-small ${category.active ? 'btn-warning' : 'btn-success'}"
                        onclick="toggleCategoryStatus(${category.id})">
                    ${category.active ? t('deactivate') : t('activate')}
                </button>
                <button class="btn-small btn-danger" onclick="deleteCategory(${category.id})" data-translate="delete">${t('delete')}</button>
            </td>
        </tr>
    `).join('');
}

function getCategoryName(category) {
    switch(currentLanguage) {
        case 'ar': return category.nameAr || category.name;
        case 'fr': return category.nameFr || category.name;
        case 'es': return category.nameEs || category.name;
        default: return category.name;
    }
}

function showAddCategoryModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 data-translate="addCategory">${t('addCategory')}</h2>
            <form onsubmit="addNewCategory(event)">
                <div class="form-group">
                    <label data-translate="englishName">${t('englishName')}:</label>
                    <input type="text" id="category-name-en" required>
                </div>
                <div class="form-group">
                    <label data-translate="arabicName">${t('arabicName')}:</label>
                    <input type="text" id="category-name-ar" required>
                </div>
                <div class="form-group">
                    <label data-translate="frenchName">${t('frenchName')}:</label>
                    <input type="text" id="category-name-fr" required>
                </div>
                <div class="form-group">
                    <label data-translate="spanishName">${t('spanishName')}:</label>
                    <input type="text" id="category-name-es" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" data-translate="cancel">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function addNewCategory(event) {
    event.preventDefault();

    const newCategory = {
        id: Math.max(...categories.map(c => c.id)) + 1,
        name: document.getElementById('category-name-en').value,
        nameAr: document.getElementById('category-name-ar').value,
        nameFr: document.getElementById('category-name-fr').value,
        nameEs: document.getElementById('category-name-es').value,
        active: true
    };

    categories.push(newCategory);
    saveToStorage('categories', categories);

    closeModal();
    loadCategoriesView();

    // Refresh product categories
    updateProductCategories();

    // Update main screen category buttons
    updateCategoryButtons();

    alert(`${t('category')} "${getCategoryName(newCategory)}" ${t('addedSuccessfully')}!`);
}

function editCategory(categoryId) {
    const category = categories.find(c => c.id === categoryId);
    if (!category) return;

    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 data-translate="editCategory">${t('editCategory')}</h2>
            <form onsubmit="updateCategory(event, ${categoryId})">
                <div class="form-group">
                    <label data-translate="englishName">${t('englishName')}:</label>
                    <input type="text" id="edit-category-name-en" value="${category.name}" required>
                </div>
                <div class="form-group">
                    <label data-translate="arabicName">${t('arabicName')}:</label>
                    <input type="text" id="edit-category-name-ar" value="${category.nameAr}" required>
                </div>
                <div class="form-group">
                    <label data-translate="frenchName">${t('frenchName')}:</label>
                    <input type="text" id="edit-category-name-fr" value="${category.nameFr}" required>
                </div>
                <div class="form-group">
                    <label data-translate="spanishName">${t('spanishName')}:</label>
                    <input type="text" id="edit-category-name-es" value="${category.nameEs}" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()" data-translate="cancel">${t('cancel')}</button>
                    <button type="submit" class="btn btn-primary" data-translate="save">${t('save')}</button>
                </div>
            </form>
        </div>
    `;
    document.body.appendChild(modal);
}

function updateCategory(event, categoryId) {
    event.preventDefault();

    const category = categories.find(c => c.id === categoryId);
    if (!category) return;

    category.name = document.getElementById('edit-category-name-en').value;
    category.nameAr = document.getElementById('edit-category-name-ar').value;
    category.nameFr = document.getElementById('edit-category-name-fr').value;
    category.nameEs = document.getElementById('edit-category-name-es').value;

    saveToStorage('categories', categories);

    closeModal();
    loadCategoriesView();

    // Refresh product categories
    updateProductCategories();

    // Update main screen category buttons
    updateCategoryButtons();

    alert(`${t('category')} "${getCategoryName(category)}" ${t('updatedSuccessfully')}!`);
}

function toggleCategoryStatus(categoryId) {
    const category = categories.find(c => c.id === categoryId);
    if (!category) return;

    category.active = !category.active;
    saveToStorage('categories', categories);

    loadCategoriesView();

    // Refresh product categories
    updateProductCategories();

    // Update main screen category buttons
    updateCategoryButtons();

    alert(`${t('category')} "${getCategoryName(category)}" ${category.active ? t('activated') : t('deactivated')} ${t('successfully')}!`);
}

function deleteCategory(categoryId) {
    const category = categories.find(c => c.id === categoryId);
    if (!category) return;

    // Check if category is used by products
    const productsUsingCategory = products.filter(p => p.category === category.name.toLowerCase());
    if (productsUsingCategory.length > 0) {
        alert(`${t('cannotDeleteCategory')} "${getCategoryName(category)}" - ${productsUsingCategory.length} ${t('productsUsingCategory')}`);
        return;
    }

    if (confirm(`${t('confirmDeleteCategory')} "${getCategoryName(category)}"?`)) {
        const index = categories.findIndex(c => c.id === categoryId);
        categories.splice(index, 1);
        saveToStorage('categories', categories);

        loadCategoriesView();

        // Refresh product categories
        updateProductCategories();

        // Update main screen category buttons
        updateCategoryButtons();

        alert(`${t('category')} "${getCategoryName(category)}" ${t('deletedSuccessfully')}!`);
    }
}

function exportCategories() {
    const categoriesData = categories.map(category => ({
        id: category.id,
        name: category.name,
        nameAr: category.nameAr,
        nameFr: category.nameFr,
        nameEs: category.nameEs,
        status: category.active ? t('active') : t('inactive')
    }));

    const csvContent = "data:text/csv;charset=utf-8,"
        + [
            ['ID', 'English', 'Arabic', 'French', 'Spanish', t('status')].join(','),
            ...categoriesData.map(row => Object.values(row).join(','))
        ].join('\n');

    const link = document.createElement('a');
    link.href = encodeURI(csvContent);
    link.download = `categories-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    alert(t('categoriesExported'));
}

function updateProductCategories() {
    // Refresh product display if on sales tab
    if (currentView === 'sales') {
        displayProducts();
    }

    // Refresh inventory if on inventory tab
    if (currentView === 'inventory') {
        loadInventoryView();
    }
}

// ===== CHARTS FUNCTIONALITY =====

let chartsVisible = false;
let salesChart = null;
let productChart = null;

function toggleCharts() {
    const chartsSection = document.getElementById('charts-section');
    chartsVisible = !chartsVisible;

    if (chartsVisible) {
        chartsSection.style.display = 'block';
        // Load Chart.js if not already loaded
        if (typeof Chart === 'undefined') {
            loadChartJS(() => initializeCharts());
        } else {
            initializeCharts();
        }
    } else {
        chartsSection.style.display = 'none';
        destroyCharts();
    }
}

function loadChartJS(callback) {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    script.onload = callback;
    document.head.appendChild(script);
}

function initializeCharts() {
    // Small delay to ensure Chart.js is fully loaded
    setTimeout(() => {
        initializeSalesChart();
        initializeProductChart();
    }, 100);
}

function destroyCharts() {
    if (salesChart) {
        salesChart.destroy();
        salesChart = null;
    }
    if (productChart) {
        productChart.destroy();
        productChart = null;
    }
}

function initializeSalesChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx || typeof Chart === 'undefined') return;

    // Get last 7 days of sales data
    const last7Days = [];
    const salesData = [];

    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toDateString();

        last7Days.push(date.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US'));

        const dayTotal = salesHistory
            .filter(sale => new Date(sale.date).toDateString() === dateStr)
            .reduce((sum, sale) => sum + sale.total, 0);

        salesData.push(dayTotal);
    }

    salesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: last7Days,
            datasets: [{
                label: t('dailySales'),
                data: salesData,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('salesChart')
                },
                legend: {
                    display: true
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                }
            }
        }
    });
}

function initializeProductChart() {
    const ctx = document.getElementById('productChart');
    if (!ctx || typeof Chart === 'undefined') return;

    // Get top 5 selling products
    const productSales = {};

    salesHistory.forEach(sale => {
        sale.items.forEach(item => {
            if (!productSales[item.id]) {
                productSales[item.id] = {
                    name: getProductName(item),
                    quantity: 0
                };
            }
            productSales[item.id].quantity += item.quantity;
        });
    });

    const sortedProducts = Object.values(productSales)
        .sort((a, b) => b.quantity - a.quantity)
        .slice(0, 5);

    const labels = sortedProducts.map(p => p.name);
    const data = sortedProducts.map(p => p.quantity);

    productChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                label: t('productsSold'),
                data: data,
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#f5576c',
                    '#4facfe'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: t('topSellingProducts')
                },
                legend: {
                    display: true,
                    position: 'bottom'
                }
            }
        }
    });
}

// ===== LOGO MANAGEMENT =====

function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert(t('invalidFileType'));
        return;
    }

    // Validate file size (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
        alert(t('fileTooLarge'));
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const logoData = e.target.result;

        // Update settings
        settings.companyLogo = logoData;
        localStorage.setItem('companyLogo', logoData);

        // Update preview
        updateLogoPreview(logoData);

        // Update main interface logo
        updateMainLogo();

        alert(t('logoUpdated'));
    };

    reader.readAsDataURL(file);
}

function removeLogo() {
    if (confirm(t('confirmRemoveLogo'))) {
        settings.companyLogo = '';
        localStorage.removeItem('companyLogo');

        // Update preview
        updateLogoPreview('');

        // Update main interface
        updateMainLogo();

        // Refresh settings view
        loadSettingsView();

        alert(t('logoRemoved'));
    }
}

function updateLogoPreview(logoData) {
    const preview = document.getElementById('current-logo-preview');
    if (preview) {
        if (logoData) {
            preview.src = logoData;
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }
}

function updateMainLogo() {
    // Update logo in main interface
    const mainLogo = document.getElementById('main-logo');
    if (mainLogo) {
        if (settings.companyLogo) {
            mainLogo.innerHTML = `<img src="${settings.companyLogo}" alt="${settings.companyName}" style="max-height: 40px;">`;
        } else {
            mainLogo.innerHTML = `<span style="font-weight: bold; color: var(--primary-color);">${settings.companyName}</span>`;
        }
    }

    // Update logo in receipts and invoices (will be used in next print)
    // The logo will automatically appear in printed documents
}

// ===== PRODUCT MANAGEMENT =====

function displayProducts() {
    const filteredProducts = currentCategory === 'all'
        ? products.filter(p => p.active)
        : products.filter(p => p.category === currentCategory && p.active);

    const productsGrid = document.getElementById('products-grid');
    if (!productsGrid) return;

    productsGrid.innerHTML = '';

    filteredProducts.forEach(product => {
        const productName = getProductName(product);
        const isLowStock = product.stock <= product.minStock;
        const isExpired = product.expiryDate && new Date(product.expiryDate) < new Date();
        const isNearExpiry = product.expiryDate && new Date(product.expiryDate) <= new Date(Date.now() + 3 * 24 * 60 * 60 * 1000);

        let statusClass = '';
        let statusBadge = '';

        if (isExpired) {
            statusClass = 'expired';
            statusBadge = `<span class="expired-badge">⚠️ ${t('expired')}</span>`;
        } else if (isNearExpiry) {
            statusClass = 'near-expiry';
            statusBadge = `<span class="near-expiry-badge">⏰ ${t('nearExpiry')}</span>`;
        } else if (isLowStock) {
            statusClass = 'low-stock';
            statusBadge = `<span class="low-stock-badge">📦 ${t('lowStock')}</span>`;
        }

        const productCard = document.createElement('div');
        productCard.className = `product-card ${statusClass}`;
        productCard.innerHTML = `
            ${product.image ? `<div class="product-image"><img src="${product.image}" alt="${productName}" /></div>` : ''}
            <div class="product-info">
                <h3>${productName}</h3>
                <div class="price">${formatPrice(product.price)}</div>
                <div class="stock-info">
                    <span class="stock-count">${t('stock')}: ${product.stock}</span>
                    ${statusBadge}
                </div>
                ${product.expiryDate ? `<div class="expiry-date">${t('expiryDate')}: ${new Date(product.expiryDate).toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : currentLanguage === 'fr' ? 'fr-FR' : currentLanguage === 'es' ? 'es-ES' : 'en-US')}</div>` : ''}
                ${settings.showBarcode ? `<div class="barcode">${product.barcode}</div>` : ''}
            </div>
        `;

        // Don't allow adding expired products to cart
        if (!isExpired) {
            productCard.addEventListener('click', () => addToCart(product));
        } else {
            productCard.style.cursor = 'not-allowed';
            productCard.style.opacity = '0.6';
        }

        productsGrid.appendChild(productCard);
    });
}

function searchProducts() {
    const searchTerm = document.getElementById('product-search').value.toLowerCase();
    const filteredProducts = products.filter(product => {
        const name = (currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name).toLowerCase();
        const barcode = product.barcode.toLowerCase();
        return product.active && (name.includes(searchTerm) || barcode.includes(searchTerm));
    });

    displayFilteredProducts(filteredProducts);
}

function displayFilteredProducts(filteredProducts) {
    const productsGrid = document.getElementById('products-grid');
    if (!productsGrid) return;

    productsGrid.innerHTML = '';

    filteredProducts.forEach(product => {
        const productName = currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name;
        const isLowStock = product.stock <= product.minStock;

        const productCard = document.createElement('div');
        productCard.className = `product-card ${isLowStock ? 'low-stock' : ''}`;
        productCard.innerHTML = `
            <div class="product-info">
                <h3>${productName}</h3>
                <div class="price">${formatCurrency(product.price)}</div>
                <div class="stock-info">
                    <span class="stock-count">${t('stock')}: ${product.stock}</span>
                    ${isLowStock ? '<span class="low-stock-badge">⚠️ Low</span>' : ''}
                </div>
                ${settings.showBarcode ? `<div class="barcode">${product.barcode}</div>` : ''}
            </div>
        `;

        productCard.addEventListener('click', () => addToCart(product));
        productsGrid.appendChild(productCard);
    });
}

// ===== CART MANAGEMENT =====

function addToCart(product, priceType = null) {
    if (product.stock <= 0) {
        alert(`${getProductName(product)} ${t('outOfStock')}!`);
        return;
    }

    // Get selected price type from selector if not specified
    if (!priceType) {
        const priceTypeSelector = document.getElementById('price-type-selector');
        priceType = priceTypeSelector ? priceTypeSelector.value : 'regular';
    }

    // Get the selected price
    let selectedPrice = getProductPrice(product, priceType);

    // If selected price type not available, fallback to regular price
    if (selectedPrice === null || selectedPrice === undefined) {
        selectedPrice = product.price;
        priceType = 'regular';
    }

    const existingItem = cart.find(item => item.id === product.id && (item.priceType || 'regular') === priceType);

    if (existingItem) {
        if (existingItem.quantity >= product.stock) {
            alert(`${t('cannotAddMore')} ${getProductName(product)}. ${t('onlyInStock')}: ${product.stock}.`);
            return;
        }
        existingItem.quantity += 1;
    } else {
        cart.push({
            ...product,
            quantity: 1,
            price: selectedPrice,
            priceType: priceType,
            priceLabel: t(priceType)
        });
    }

    updateCartDisplay();
    saveCart();
}

// Update price type display when selector changes
function updatePriceTypeDisplay() {
    const priceTypeSelector = document.getElementById('price-type-selector');
    const selectedType = priceTypeSelector.value;

    // Update product cards to show selected price type
    displayProducts();

    // Show notification of price type change
    const notification = document.createElement('div');
    notification.className = 'price-type-notification';
    notification.innerHTML = `${t('priceTypeChanged')}: ${t(selectedType)}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        z-index: 1000;
        font-size: 14px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 2000);
}

function hasMultiplePrices(product) {
    if (!product.prices) return false;

    const priceCount = Object.values(product.prices).filter(price => price !== null && price !== undefined).length;
    return priceCount > 1;
}

function getProductPrice(product, priceType = 'regular') {
    if (product.prices && product.prices[priceType] !== null && product.prices[priceType] !== undefined) {
        return product.prices[priceType];
    }
    return product.price; // Fallback to regular price
}

function showPriceSelectionModal(product) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';

    const availablePrices = [];
    if (product.prices) {
        Object.entries(product.prices).forEach(([type, price]) => {
            if (price !== null && price !== undefined) {
                availablePrices.push({ type, price });
            }
        });
    }

    modal.innerHTML = `
        <div class="modal-content price-selection-modal">
            <h2>${t('selectPriceType')}</h2>
            <p>${t('product')}: <strong>${getProductName(product)}</strong></p>

            <div class="price-options">
                ${availablePrices.map(({ type, price }) => `
                    <button class="price-option-btn" onclick="addToCartWithPrice(${product.id}, '${type}')">
                        <div class="price-type">${t(type)}</div>
                        <div class="price-amount">${formatPrice(price)}</div>
                    </button>
                `).join('')}
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

function addToCartWithPrice(productId, priceType) {
    const product = products.find(p => p.id === productId);
    if (product) {
        closeModal();
        addToCart(product, priceType);
    }
}

function removeFromCart(productId, priceType = 'regular') {
    cart = cart.filter(item => !(item.id === productId && (item.priceType || 'regular') === priceType));
    updateCartDisplay();
    saveCart();
}

function updateQuantity(productId, change, priceType = 'regular') {
    const item = cart.find(item => item.id === productId && (item.priceType || 'regular') === priceType);
    const product = products.find(p => p.id === productId);

    if (item && product) {
        const newQuantity = item.quantity + change;

        if (newQuantity <= 0) {
            removeFromCart(productId, priceType);
        } else if (newQuantity > product.stock) {
            alert(`${t('cannotAddMore')} ${getProductName(product)}. ${t('onlyInStock')}: ${product.stock}.`);
        } else {
            item.quantity = newQuantity;
            updateCartDisplay();
            saveCart();
        }
    }
}

// Direct quantity editing function
function updateQuantityDirect(productId, newQuantity, priceType = 'regular') {
    const item = cart.find(item => item.id === productId && (item.priceType || 'regular') === priceType);
    const product = products.find(p => p.id === productId);

    if (!item || !product) return;

    const quantity = parseInt(newQuantity);

    // Validate quantity
    if (isNaN(quantity) || quantity < 1) {
        alert(t('invalidQuantity'));
        updateCartDisplay(); // Reset to previous value
        return;
    }

    if (quantity > product.stock) {
        alert(`${t('cannotAddMore')} ${getProductName(product)}. ${t('onlyInStock')}: ${product.stock}.`);
        updateCartDisplay(); // Reset to previous value
        return;
    }

    item.quantity = quantity;
    updateCartDisplay();
    saveCart();
}

function updateCartDisplay() {
    const cartItemsEl = document.getElementById('cart-items');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');

    if (!cartItemsEl) return;

    if (cart.length === 0) {
        cartItemsEl.innerHTML = `<p class="empty-cart" data-translate="emptyCart">${t('emptyCart')}</p>`;
    } else {
        cartItemsEl.innerHTML = cart.map(item => {
            const itemName = currentLanguage === 'ar' && item.nameAr ? item.nameAr : item.name;
            const priceTypeLabel = item.priceType && item.priceType !== 'regular' ? ` (${t(item.priceType)})` : '';
            return `
                <div class="cart-item">
                    <div class="item-info">
                        <div class="item-name">${itemName}${priceTypeLabel}</div>
                        <div class="item-price">${formatPrice(item.price)} ${t('each')}</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, -1, '${item.priceType || 'regular'}')">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1" max="${item.stock}"
                               onchange="updateQuantityDirect(${item.id}, this.value, '${item.priceType || 'regular'}')"
                               onblur="updateQuantityDirect(${item.id}, this.value, '${item.priceType || 'regular'}')"
                               title="Edit quantity">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, 1, '${item.priceType || 'regular'}')">+</button>
                        <button class="remove-btn" onclick="removeFromCart(${item.id}, '${item.priceType || 'regular'}')" title="Remove item">🗑️</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    updateTotals();
}

function updateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + (convertPrice(item.price) * item.quantity), 0);
    const tax = subtotal * settings.taxRate;
    const total = subtotal + tax;

    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const totalEl = document.getElementById('total');

    if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal / currencies[currentCurrency].rate);
    if (taxEl) taxEl.textContent = formatCurrency(tax / currencies[currentCurrency].rate);
    if (totalEl) totalEl.textContent = formatCurrency(total / currencies[currentCurrency].rate);
}

function clearCart() {
    if (cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    // Check if current user is manager or admin
    if (currentUser.role !== 'manager' && currentUser.role !== 'admin') {
        // Request manager authorization
        showManagerAuthModal('clearCart');
        return;
    }

    // Manager/Admin can clear cart directly
    if (confirm(`${t('confirmClearCart')}?`)) {
        cart = [];
        updateCartDisplay();
        saveCart();
        alert(t('cartCleared'));
    }
}

// Manager authorization modal
function showManagerAuthModal(action) {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';

    modal.innerHTML = `
        <div class="modal-content manager-auth-modal">
            <h2 data-translate="managerAuthRequired">${t('managerAuthRequired')}</h2>
            <p data-translate="managerAuthMessage">${t('managerAuthMessage')}</p>

            <div class="auth-form">
                <div class="form-group">
                    <label data-translate="username">${t('username')}:</label>
                    <input type="text" id="manager-username" placeholder="${t('enterManagerUsername')}" autocomplete="username">
                </div>
                <div class="form-group">
                    <label data-translate="password">${t('password')}:</label>
                    <input type="password" id="manager-password" placeholder="${t('enterManagerPassword')}" autocomplete="current-password">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeManagerAuth()" data-translate="cancel">${t('cancel')}</button>
                <button type="button" class="btn btn-primary" onclick="authorizeManagerAction('${action}')" data-translate="authorize">${t('authorize')}</button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    document.getElementById('manager-username').focus();

    // Add Enter key support
    modal.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            authorizeManagerAction(action);
        }
    });
}

function closeManagerAuth() {
    const modal = document.querySelector('.manager-auth-modal').closest('.modal');
    if (modal) {
        document.body.removeChild(modal);
    }
}

function authorizeManagerAction(action) {
    const username = document.getElementById('manager-username').value.trim();
    const password = document.getElementById('manager-password').value;

    if (!username || !password) {
        alert(t('pleaseEnterCredentials'));
        return;
    }

    // Check manager credentials
    const managerUser = users.find(user =>
        user.username === username &&
        user.password === password &&
        (user.role === 'manager' || user.role === 'admin') &&
        user.active
    );

    if (!managerUser) {
        alert(t('invalidManagerCredentials'));
        document.getElementById('manager-password').value = '';
        document.getElementById('manager-password').focus();
        return;
    }

    // Close modal
    closeManagerAuth();

    // Execute authorized action
    switch(action) {
        case 'clearCart':
            if (confirm(`${t('confirmClearCart')}?`)) {
                cart = [];
                updateCartDisplay();
                saveCart();
                alert(`${t('cartCleared')} - ${t('authorizedBy')}: ${managerUser.name}`);
            }
            break;
        default:
            console.log('Unknown action:', action);
    }
}

function saveCart() {
    saveToStorage('currentCart', cart);
}

function loadCart() {
    const savedCart = loadFromStorage('currentCart', []);
    cart = savedCart;
    updateCartDisplay();
}

// ===== CHECKOUT & PAYMENT SYSTEM =====

function openCheckout() {
    if (cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    // Validate stock before opening checkout
    for (let cartItem of cart) {
        const product = products.find(p => p.id === cartItem.id);
        if (product && product.stock < cartItem.quantity) {
            alert(`${t('insufficientStock')}: ${getProductName(product)}\n${t('available')}: ${product.stock}, ${t('requested')}: ${cartItem.quantity}`);
            return;
        }
    }

    const modal = document.getElementById('checkout-modal');
    const checkoutItems = document.getElementById('checkout-items');
    const checkoutTotal = document.getElementById('checkout-total-amount');

    // Display checkout items with better formatting
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * settings.taxRate;
    const total = subtotal + tax;

    checkoutItems.innerHTML = cart.map(item => {
        const itemName = currentLanguage === 'ar' && item.nameAr ? item.nameAr : item.name;
        const lineTotal = item.price * item.quantity;
        return `
            <div class="checkout-item">
                <div class="item-details">
                    <span class="item-name">${itemName}</span>
                    <span class="item-qty">${item.quantity} x ${formatPrice(item.price)}</span>
                </div>
                <span class="item-total">${formatPrice(lineTotal)}</span>
            </div>
        `;
    }).join('');

    checkoutTotal.textContent = formatPrice(total);

    // Auto-select cash payment for faster checkout
    const cashBtn = document.querySelector('.payment-btn[data-method="cash"]');
    if (cashBtn) {
        document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('active'));
        cashBtn.classList.add('active');
    }

    modal.style.display = 'block';

    // Focus on complete sale button for keyboard users
    setTimeout(() => {
        const completeSaleBtn = document.getElementById('complete-sale');
        if (completeSaleBtn) completeSaleBtn.focus();
    }, 100);
}

function closeCheckout() {
    const modal = document.getElementById('checkout-modal');
    modal.style.display = 'none';
    document.querySelectorAll('.payment-btn').forEach(btn => btn.classList.remove('active'));
}

function completeSale() {
    const selectedPayment = document.querySelector('.payment-btn.active');

    if (!selectedPayment) {
        alert(t('pleaseSelectPayment'));
        return;
    }

    const paymentMethod = selectedPayment.dataset.method;
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * settings.taxRate;
    const total = subtotal + tax;

    // Create sale record
    const sale = {
        id: generateId(),
        date: new Date().toISOString(),
        cashier: currentUser.name,
        items: [...cart],
        subtotal: subtotal,
        tax: tax,
        total: total,
        paymentMethod: paymentMethod,
        currency: currentCurrency
    };

    // Validate stock availability before completing sale
    for (let cartItem of cart) {
        const product = products.find(p => p.id === cartItem.id);
        if (product && product.stock < cartItem.quantity) {
            alert(`${t('insufficientStock')}: ${getProductName(product)}\n${t('available')}: ${product.stock}, ${t('requested')}: ${cartItem.quantity}`);
            return;
        }
    }

    // Update inventory - reduce stock for sold items
    cart.forEach(cartItem => {
        const product = products.find(p => p.id === cartItem.id);
        if (product) {
            product.stock -= cartItem.quantity;
            // Ensure stock doesn't go negative
            if (product.stock < 0) {
                product.stock = 0;
            }
        }
    });

    // Save sale
    salesHistory.push(sale);
    saveToStorage('salesHistory', salesHistory);
    saveToStorage('products', products);

    // Print receipt if enabled
    if (settings.printAfterSale) {
        printReceipt(sale);
    }

    // Show success message
    showSaleSuccessMessage(sale);

    // Clear cart and close modal
    cart = [];
    updateCartDisplay();
    displayProducts(); // Refresh to show updated stock
    closeCheckout();
    saveCart();

    // Check for low stock alerts after sale
    checkLowStockAfterSale();
}

// Show sale success message with options
function showSaleSuccessMessage(sale) {
    const message = `✅ ${t('saleCompleted')}!\n\n` +
                   `${t('receiptNumber')}: ${sale.id}\n` +
                   `${t('total')}: ${formatPrice(sale.total)}\n` +
                   `${t('paymentMethod')}: ${t(sale.paymentMethod)}\n` +
                   `${t('cashier')}: ${sale.cashier}\n\n` +
                   `${t('thankYou')}!`;

    alert(message);
}

// Quick payment functions for common scenarios
function quickCashPayment() {
    if (cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    // Validate stock
    for (let cartItem of cart) {
        const product = products.find(p => p.id === cartItem.id);
        if (product && product.stock < cartItem.quantity) {
            alert(`${t('insufficientStock')}: ${getProductName(product)}\n${t('available')}: ${product.stock}, ${t('requested')}: ${cartItem.quantity}`);
            return;
        }
    }

    // Process cash payment directly
    processQuickPayment('cash');
}

function quickCardPayment() {
    if (cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    // Validate stock
    for (let cartItem of cart) {
        const product = products.find(p => p.id === cartItem.id);
        if (product && product.stock < cartItem.quantity) {
            alert(`${t('insufficientStock')}: ${getProductName(product)}\n${t('available')}: ${product.stock}, ${t('requested')}: ${cartItem.quantity}`);
            return;
        }
    }

    // Process card payment directly
    processQuickPayment('card');
}

function processQuickPayment(paymentMethod) {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * settings.taxRate;
    const total = subtotal + tax;

    // Create sale record
    const sale = {
        id: generateId(),
        date: new Date().toISOString(),
        cashier: currentUser.name,
        items: [...cart],
        subtotal: subtotal,
        tax: tax,
        total: total,
        paymentMethod: paymentMethod,
        currency: currentCurrency
    };

    // Update inventory
    cart.forEach(cartItem => {
        const product = products.find(p => p.id === cartItem.id);
        if (product) {
            product.stock -= cartItem.quantity;
            if (product.stock < 0) {
                product.stock = 0;
            }
        }
    });

    // Save sale
    salesHistory.push(sale);
    saveToStorage('salesHistory', salesHistory);
    saveToStorage('products', products);

    // Print receipt if enabled
    if (settings.printAfterSale) {
        printReceipt(sale);
    }

    // Show success message
    showSaleSuccessMessage(sale);

    // Clear cart and refresh
    cart = [];
    updateCartDisplay();
    displayProducts();
    saveCart();

    // Check for low stock alerts
    checkLowStockAfterSale();
}

// Check for low stock items after completing a sale
function checkLowStockAfterSale() {
    const lowStockItems = products.filter(product =>
        product.active && product.stock <= product.minStock && product.stock > 0
    );

    const outOfStockItems = products.filter(product =>
        product.active && product.stock <= 0
    );

    if (lowStockItems.length > 0 || outOfStockItems.length > 0) {
        let alertMessage = '';

        if (outOfStockItems.length > 0) {
            alertMessage += `⚠️ ${t('outOfStock')} (${outOfStockItems.length}):\n`;
            outOfStockItems.slice(0, 3).forEach(item => {
                alertMessage += `• ${getProductName(item)}\n`;
            });
            if (outOfStockItems.length > 3) {
                alertMessage += `... ${t('andMore').replace('{0}', outOfStockItems.length - 3)}\n`;
            }
            alertMessage += '\n';
        }

        if (lowStockItems.length > 0) {
            alertMessage += `⚠️ ${t('lowStock')} (${lowStockItems.length}):\n`;
            lowStockItems.slice(0, 3).forEach(item => {
                alertMessage += `• ${getProductName(item)}: ${item.stock} ${t('remaining')}\n`;
            });
            if (lowStockItems.length > 3) {
                alertMessage += `... ${t('andMore').replace('{0}', lowStockItems.length - 3)}\n`;
            }
        }

        // Show alert after a short delay so sale completion message is seen first
        setTimeout(() => {
            alert(alertMessage);
        }, 1000);
    }
}

// ===== PRINTING SYSTEM =====

function printReceipt(sale = null) {
    if (!sale && cart.length === 0) {
        alert('No items to print');
        return;
    }

    let receiptData;
    if (sale) {
        receiptData = sale;
    } else {
        // Create temporary sale data for current cart
        const subtotal = cart.reduce((sum, item) => sum + (convertPrice(item.price) * item.quantity), 0);
        const tax = subtotal * settings.taxRate;
        const total = subtotal + tax;

        receiptData = {
            id: 'TEMP-' + Date.now(),
            date: new Date().toISOString(),
            cashier: currentUser.name,
            items: [...cart],
            subtotal: subtotal / currencies[currentCurrency].rate,
            tax: tax / currencies[currentCurrency].rate,
            total: total / currencies[currentCurrency].rate,
            paymentMethod: 'N/A',
            currency: currentCurrency
        };
    }

    const receiptWindow = window.open('', '_blank');
    const receiptHTML = generateReceiptHTML(receiptData);

    receiptWindow.document.write(receiptHTML);
    receiptWindow.document.close();
    receiptWindow.focus();
    receiptWindow.print();
}

// ===== QUOTATION PRINTING SYSTEM =====

function printQuotation() {
    if (cart.length === 0) {
        alert(t('emptyCart'));
        return;
    }

    const quotationData = generateQuotationData();
    const quotationWindow = window.open('', '_blank');
    const quotationHTML = generateQuotationHTML(quotationData);

    quotationWindow.document.write(quotationHTML);
    quotationWindow.document.close();
    quotationWindow.focus();
    quotationWindow.print();
}

function generateQuotationData() {
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const tax = subtotal * settings.taxRate;
    const total = subtotal + tax;

    // Create quotation valid for 30 days
    const validUntilDate = new Date();
    validUntilDate.setDate(validUntilDate.getDate() + 30);

    return {
        id: 'QUO-' + generateId(),
        date: new Date().toISOString(),
        validUntil: validUntilDate.toISOString(),
        preparedBy: currentUser.name,
        items: [...cart],
        subtotal: subtotal,
        tax: tax,
        total: total,
        currency: currentCurrency
    };
}

function generateQuotationHTML(quotation) {
    const date = new Date(quotation.date);
    const validUntil = new Date(quotation.validUntil);
    const formattedDate = date.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');
    const formattedValidUntil = validUntil.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');

    return `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
        <head>
            <meta charset="UTF-8">
            <title>${t('quotation')} - ${quotation.id}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                    font-size: 14px;
                    line-height: 1.6;
                    color: #333;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #667eea;
                    padding-bottom: 20px;
                }
                .company-name {
                    font-size: 24px;
                    font-weight: bold;
                    color: #667eea;
                    margin-bottom: 10px;
                }
                .quotation-title {
                    font-size: 20px;
                    font-weight: bold;
                    color: #495057;
                    margin: 20px 0;
                }
                .quotation-info {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 30px;
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                }
                .info-section h4 {
                    margin: 0 0 10px 0;
                    color: #495057;
                    font-weight: 600;
                }
                .info-section p {
                    margin: 5px 0;
                    color: #6c757d;
                }
                .items-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 30px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .items-table th {
                    background: #667eea;
                    color: white;
                    padding: 15px;
                    text-align: left;
                    font-weight: 600;
                }
                .items-table td {
                    padding: 12px 15px;
                    border-bottom: 1px solid #e9ecef;
                }
                .items-table tr:nth-child(even) {
                    background: #f8f9fa;
                }
                .items-table tr:hover {
                    background: #e3f2fd;
                }
                .totals-section {
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                    margin-bottom: 30px;
                }
                .totals-table {
                    width: 100%;
                    max-width: 400px;
                    margin-left: auto;
                }
                .totals-table td {
                    padding: 8px 15px;
                    border: none;
                }
                .totals-table .total-row {
                    font-weight: bold;
                    font-size: 16px;
                    border-top: 2px solid #667eea;
                    color: #667eea;
                }
                .quotation-note {
                    background: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 20px;
                    color: #856404;
                    font-weight: 500;
                }
                .footer {
                    text-align: center;
                    color: #6c757d;
                    font-size: 12px;
                    border-top: 1px solid #e9ecef;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 0; padding: 10px; }
                    .quotation-note { background: #f8f9fa !important; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">${settings.companyName}</div>
                <div>${settings.companyAddress}</div>
                <div>${settings.companyPhone}</div>
                <div class="quotation-title">${t('quotation').toUpperCase()}</div>
            </div>

            <div class="quotation-info">
                <div class="info-section">
                    <h4>${t('quotationNumber')}:</h4>
                    <p>${quotation.id}</p>
                    <h4>${t('date')}:</h4>
                    <p>${formattedDate}</p>
                    <h4>${t('validUntil')}:</h4>
                    <p>${formattedValidUntil}</p>
                </div>
                <div class="info-section">
                    <h4>${t('preparedBy')}:</h4>
                    <p>${quotation.preparedBy}</p>
                    <h4>${t('currency')}:</h4>
                    <p>${currencies[quotation.currency].name}</p>
                    <h4>${t('status')}:</h4>
                    <p style="color: #28a745; font-weight: 600;">${t('pending')}</p>
                </div>
            </div>

            <table class="items-table">
                <thead>
                    <tr>
                        <th>${t('item')}</th>
                        <th>${t('qty')}</th>
                        <th>${t('unitPrice')}</th>
                        <th>${t('total')}</th>
                    </tr>
                </thead>
                <tbody>
                    ${quotation.items.map(item => {
                        const itemName = currentLanguage === 'ar' && item.nameAr ? item.nameAr : item.name;
                        const itemTotal = item.price * item.quantity;
                        return `
                            <tr>
                                <td>${itemName}</td>
                                <td>${item.quantity}</td>
                                <td>${formatPrice(item.price)}</td>
                                <td>${formatPrice(itemTotal)}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>

            <div class="totals-section">
                <table class="totals-table">
                    <tr>
                        <td>${t('subtotal')}:</td>
                        <td style="text-align: right;">${formatPrice(quotation.subtotal)}</td>
                    </tr>
                    <tr>
                        <td>${t('tax')} (${(settings.taxRate * 100).toFixed(0)}%):</td>
                        <td style="text-align: right;">${formatPrice(quotation.tax)}</td>
                    </tr>
                    <tr class="total-row">
                        <td>${t('total')}:</td>
                        <td style="text-align: right;">${formatPrice(quotation.total)}</td>
                    </tr>
                </table>
            </div>

            <div class="quotation-note">
                <strong>📋 ${t('note')}:</strong> ${t('quotationNote')}
            </div>

            <div class="footer">
                <div>${t('quotationFooter')}</div>
                <div style="margin-top: 10px;">
                    ${settings.receiptFooter}
                </div>
                <div style="margin-top: 10px;">
                    ${t('generatedOn')}: ${new Date().toLocaleString()}
                </div>
            </div>
        </body>
        </html>
    `;
}

function generateReceiptHTML(sale) {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');
    const formattedTime = date.toLocaleTimeString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');

    return `
        <!DOCTYPE html>
        <html dir="${currentLanguage === 'ar' ? 'rtl' : 'ltr'}">
        <head>
            <meta charset="UTF-8">
            <title>Receipt - ${sale.id}</title>
            <style>
                body {
                    font-family: 'Courier New', monospace;
                    max-width: 300px;
                    margin: 0 auto;
                    padding: 10px;
                    font-size: 12px;
                    line-height: 1.4;
                }
                .header { text-align: center; margin-bottom: 20px; }
                .company-name { font-size: 16px; font-weight: bold; }
                .separator { border-top: 1px dashed #000; margin: 10px 0; }
                .item-line { display: flex; justify-content: space-between; margin: 5px 0; }
                .total-line { font-weight: bold; }
                .footer { text-align: center; margin-top: 20px; font-size: 10px; }
                @media print {
                    body { margin: 0; padding: 5px; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="company-name">${settings.companyName}</div>
                <div>${settings.companyAddress}</div>
                <div>${settings.companyPhone}</div>
            </div>

            <div class="separator"></div>

            <div class="receipt-info">
                <div>Receipt #: ${sale.id}</div>
                <div>Date: ${formattedDate} ${formattedTime}</div>
                <div>Cashier: ${sale.cashier}</div>
                <div>Currency: ${currencies[sale.currency].name}</div>
            </div>

            <div class="separator"></div>

            <div class="items">
                ${sale.items.map(item => {
                    const itemName = currentLanguage === 'ar' && item.nameAr ? item.nameAr : item.name;
                    const itemTotal = item.price * item.quantity;
                    return `
                        <div class="item-line">
                            <span>${itemName}</span>
                        </div>
                        <div class="item-line">
                            <span>${t('qty')}: ${item.quantity}</span>
                        </div>
                        <div class="item-line">
                            <span>${t('unitPrice')}: ${formatPrice(item.price)}</span>
                            <span>${t('total')}: ${formatPrice(itemTotal)}</span>
                        </div>
                    `;
                }).join('')}
            </div>

            <div class="separator"></div>

            <div class="totals">
                <div class="item-line">
                    <span>Subtotal:</span>
                    <span>${formatPrice(sale.subtotal)}</span>
                </div>
                <div class="item-line">
                    <span>Tax (${(settings.taxRate * 100).toFixed(0)}%):</span>
                    <span>${formatPrice(sale.tax)}</span>
                </div>
                <div class="item-line total-line">
                    <span>TOTAL:</span>
                    <span>${formatPrice(sale.total)}</span>
                </div>
            </div>

            <div class="separator"></div>

            <div class="payment-info">
                <div>Payment Method: ${sale.paymentMethod}</div>
            </div>

            <div class="footer">
                <div>${settings.receiptFooter}</div>
                <div>Powered by Professional POS System</div>
            </div>
        </body>
        </html>
    `;
}

// ===== LOW STOCK MANAGEMENT =====

function checkLowStock() {
    const lowStockProducts = products.filter(product =>
        product.active && product.stock <= product.minStock
    );

    const alertDiv = document.getElementById('low-stock-alert');
    const itemsDiv = document.getElementById('low-stock-items');

    if (lowStockProducts.length > 0) {
        alertDiv.style.display = 'block';
        itemsDiv.innerHTML = lowStockProducts.map(product => {
            const productName = currentLanguage === 'ar' && product.nameAr ? product.nameAr : product.name;
            return `<div class="low-stock-item">${productName}: ${product.stock} left (Min: ${product.minStock})</div>`;
        }).join('');
    } else {
        alertDiv.style.display = 'none';
    }
}

// ===== UTILITY FUNCTIONS =====

function updateTime() {
    const timeEl = document.getElementById('current-time');
    if (timeEl) {
        const now = new Date();
        const timeString = now.toLocaleTimeString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');
        const dateString = now.toLocaleDateString(currentLanguage === 'ar' ? 'ar-DZ' : 'en-US');
        timeEl.textContent = `${dateString} ${timeString}`;
    }
}

function setupEventListeners() {
    // Category buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentCategory = this.dataset.category;
            displayProducts();
        });
    });

    // Cart actions
    const clearCartBtn = document.getElementById('clear-cart');
    const checkoutBtn = document.getElementById('checkout');
    const printReceiptBtn = document.getElementById('print-receipt');
    const printInvoiceBtn = document.getElementById('print-invoice');
    const printQuotationBtn = document.getElementById('print-quotation');
    const cancelCheckoutBtn = document.getElementById('cancel-checkout');
    const completeSaleBtn = document.getElementById('complete-sale');

    if (clearCartBtn) clearCartBtn.addEventListener('click', clearCart);
    if (checkoutBtn) checkoutBtn.addEventListener('click', openCheckout);
    if (printReceiptBtn) printReceiptBtn.addEventListener('click', () => printReceipt());
    if (printInvoiceBtn) printInvoiceBtn.addEventListener('click', () => printInvoice());
    if (printQuotationBtn) printQuotationBtn.addEventListener('click', () => printQuotation());
    if (cancelCheckoutBtn) cancelCheckoutBtn.addEventListener('click', closeCheckout);
    if (completeSaleBtn) completeSaleBtn.addEventListener('click', completeSale);

    // Payment method buttons
    document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.payment-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Close modal when clicking outside
    const checkoutModal = document.getElementById('checkout-modal');
    if (checkoutModal) {
        checkoutModal.addEventListener('click', function(e) {
            if (e.target === checkoutModal) {
                closeCheckout();
            }
        });
    }
}

function loadSettings() {
    // Settings are already loaded in the settings object
    // This function can be extended to load from server/database
}

function autoSave() {
    saveToStorage('products', products);
    saveToStorage('salesHistory', salesHistory);
    saveToStorage('settings', settings);
}

// ===== ENHANCED BARCODE SCANNING =====

let barcodeBuffer = '';
let barcodeTimeout;
let scannerConnected = false;

// Enhanced barcode scanning with hardware support
function scanBarcode() {
    // Check if we have camera access for mobile scanning
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        showBarcodeScanModal();
    } else {
        // Fallback to manual entry
        manualBarcodeEntry();
    }
}

function manualBarcodeEntry() {
    const barcode = prompt(t('enterBarcode') + ':');
    if (barcode) {
        processBarcodeInput(barcode.trim());
    }
}

function showBarcodeScanModal() {
    const modal = document.createElement('div');
    modal.className = 'modal barcode-modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content barcode-scan-content">
            <h2>${t('scanBarcode')}</h2>
            <div class="scan-options">
                <button class="btn btn-primary" onclick="startCameraScanning()">${t('useCamera')}</button>
                <button class="btn btn-secondary" onclick="manualBarcodeEntry(); closeModal()">${t('manualEntry')}</button>
                <button class="btn btn-info" onclick="connectUSBScanner()">${t('connectScanner')}</button>
            </div>
            <div id="camera-container" style="display: none;">
                <video id="camera-preview" autoplay playsinline></video>
                <div class="scan-overlay">
                    <div class="scan-line"></div>
                </div>
                <div class="scan-instructions">${t('pointCameraAtBarcode')}</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">${t('cancel')}</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Process barcode input from any source
function processBarcodeInput(barcode) {
    console.log('Processing barcode:', barcode);

    // Find product by barcode
    const product = findProductByBarcode(barcode);

    if (product) {
        addToCart(product);
        showBarcodeSuccess(product);
    } else {
        showBarcodeError(barcode);
    }
}

function findProductByBarcode(barcode) {
    return products.find(p =>
        p.active && (
            p.barcode === barcode ||
            p.barcode === barcode.replace(/^0+/, '') || // Remove leading zeros
            barcode.includes(p.barcode) ||
            p.name.toLowerCase().includes(barcode.toLowerCase()) ||
            (p.nameAr && p.nameAr.includes(barcode)) ||
            (p.nameFr && p.nameFr.toLowerCase().includes(barcode.toLowerCase())) ||
            (p.nameEs && p.nameEs.toLowerCase().includes(barcode.toLowerCase()))
        )
    );
}

function showBarcodeSuccess(product) {
    const productName = getProductName(product);
    alert(`✅ ${t('productAdded')}: ${productName} - ${formatCurrency(product.price)}`);
}

function showBarcodeError(barcode) {
    alert(`❌ ${t('productNotFound')}: ${barcode}`);
}

// Make functions globally available
window.handleLogin = handleLogin;
window.changeLanguage = changeLanguage;
window.changeCurrency = changeCurrency;
window.logout = logout;
window.switchView = switchView;
window.searchProducts = searchProducts;
window.addToCart = addToCart;
window.removeFromCart = removeFromCart;
window.updateQuantity = updateQuantity;
window.clearCart = clearCart;
window.openCheckout = openCheckout;
window.closeCheckout = closeCheckout;
window.completeSale = completeSale;
window.printReceipt = printReceipt;
window.printQuotation = printQuotation;
window.scanBarcode = scanBarcode;
window.quickCashPayment = quickCashPayment;
window.quickCardPayment = quickCardPayment;
window.showManagerAuthModal = showManagerAuthModal;
window.closeManagerAuth = closeManagerAuth;
window.authorizeManagerAction = authorizeManagerAction;

// Inventory functions
window.filterInventory = filterInventory;
window.showAddProductModal = showAddProductModal;
window.addNewProduct = addNewProduct;
window.editProduct = editProduct;
window.updateProduct = updateProduct;
window.adjustStock = adjustStock;
window.deleteProduct = deleteProduct;
window.closeModal = closeModal;

// Reports functions
window.generateDailyReport = generateDailyReport;
window.generateWeeklyReport = generateWeeklyReport;

// Users functions
window.showAddUserModal = showAddUserModal;
window.addNewUser = addNewUser;
window.editUser = editUser;
window.updateUser = updateUser;
window.toggleUserStatus = toggleUserStatus;
window.deleteUser = deleteUser;

// Settings functions
window.saveSettings = saveSettings;
window.createBackup = createBackup;

// Printing functions
window.printInvoice = printInvoice;
window.printLowStockReport = printLowStockReport;
window.printExpiredItemsReport = printExpiredItemsReport;

// Logo functions
window.handleLogoUpload = handleLogoUpload;
window.removeLogo = removeLogo;

// Export/Import functions
window.exportInventory = exportInventory;
window.exportReports = exportReports;
window.exportUsers = exportUsers;
window.resetSettings = resetSettings;
window.exportData = exportData;
window.importData = importData;
window.clearAllData = clearAllData;

// Scanner functions
window.startCameraScanning = startCameraScanning;
window.connectUSBScanner = connectUSBScanner;

// Categories functions
window.loadCategoriesView = loadCategoriesView;
window.showAddCategoryModal = showAddCategoryModal;
window.addNewCategory = addNewCategory;
window.editCategory = editCategory;
window.updateCategory = updateCategory;
window.toggleCategoryStatus = toggleCategoryStatus;
window.deleteCategory = deleteCategory;
window.exportCategories = exportCategories;
window.generateCategoryButtons = generateCategoryButtons;
window.updateCategoryButtons = updateCategoryButtons;
window.attachCategoryButtonListeners = attachCategoryButtonListeners;
window.filterProductsByCategory = filterProductsByCategory;
window.addToCartWithPrice = addToCartWithPrice;
window.hasMultiplePrices = hasMultiplePrices;
window.getProductPrice = getProductPrice;
window.showPriceSelectionModal = showPriceSelectionModal;
window.updateQuantityDirect = updateQuantityDirect;
window.updatePriceTypeDisplay = updatePriceTypeDisplay;

// Charts functions
window.toggleCharts = toggleCharts;

// Stock management functions
window.checkLowStockAfterSale = checkLowStockAfterSale;

// Barcode printing functions
window.printBarcode = printBarcode;
window.printMultipleBarcodes = printMultipleBarcodes;
window.showBulkBarcodeModal = showBulkBarcodeModal;
window.selectAllProducts = selectAllProducts;
window.selectProductsWithoutBarcode = selectProductsWithoutBarcode;
window.printSelectedBarcodes = printSelectedBarcodes;

// ===== BARCODE PRINTING FUNCTIONALITY =====

function printBarcode(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        alert(t('productNotFound'));
        return;
    }

    // Generate barcode if product doesn't have one
    if (!product.barcode || product.barcode === '') {
        product.barcode = generateProductBarcode(product);
        saveToStorage('products', products);

        // Refresh inventory display
        if (currentView === 'inventory') {
            loadInventoryView();
        }

        alert(t('barcodeGenerated'));
    }

    // Create barcode print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${t('printBarcode')} - ${getProductName(product)}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 20px;
                    text-align: center;
                }
                .barcode-container {
                    border: 2px solid #000;
                    padding: 20px;
                    margin: 20px auto;
                    width: 300px;
                    background: white;
                }
                .product-name {
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 10px;
                    color: #333;
                }
                .barcode-display {
                    font-family: 'Courier New', monospace;
                    font-size: 24px;
                    letter-spacing: 2px;
                    margin: 15px 0;
                    padding: 10px;
                    border: 1px solid #ccc;
                    background: #f9f9f9;
                }
                .barcode-visual {
                    margin: 15px 0;
                    height: 60px;
                    border: 1px solid #000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                }
                .product-info {
                    font-size: 12px;
                    color: #666;
                    margin-top: 10px;
                }
                .price {
                    font-size: 14px;
                    font-weight: bold;
                    color: #2c5aa0;
                    margin: 5px 0;
                }
                @media print {
                    body { margin: 0; }
                    .barcode-container {
                        border: 2px solid #000;
                        page-break-inside: avoid;
                    }
                }
            </style>
        </head>
        <body>
            <div class="barcode-container">
                <div class="product-name">${getProductName(product)}</div>
                <div class="barcode-visual">${createBarcodeSVG(product.barcode, 250, 60)}</div>
                <div class="barcode-display">${product.barcode}</div>
                <div class="price">${formatCurrency(product.price)}</div>
                <div class="product-info">
                    ${t('category')}: ${t(product.category)}<br>
                    ${t('stock')}: ${product.stock}<br>
                    ${new Date().toLocaleDateString()}
                </div>
            </div>
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 1000);
                };
            </script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

function generateProductBarcode(product) {
    // Generate a unique barcode based on product ID and timestamp
    const timestamp = Date.now().toString().slice(-6); // Last 6 digits of timestamp
    const productIdPadded = product.id.toString().padStart(4, '0'); // Pad product ID to 4 digits
    const categoryCode = getCategoryCode(product.category);

    // Format: CategoryCode + ProductID + Timestamp (13 digits total - EAN-13 format)
    const barcode = categoryCode + productIdPadded + timestamp;

    return barcode;
}

// Generate visual barcode pattern (EAN-13 style)
function generateBarcodePattern(barcodeNumber) {
    // EAN-13 barcode patterns for left side (odd positions)
    const leftPatterns = {
        '0': '0001101',
        '1': '0011001',
        '2': '0010011',
        '3': '0111101',
        '4': '0100011',
        '5': '0110001',
        '6': '0101111',
        '7': '0111011',
        '8': '0110111',
        '9': '0001011'
    };

    // EAN-13 barcode patterns for right side (even positions)
    const rightPatterns = {
        '0': '1110010',
        '1': '1100110',
        '2': '1101100',
        '3': '1000010',
        '4': '1011100',
        '5': '1001110',
        '6': '1010000',
        '7': '1000100',
        '8': '1001000',
        '9': '1110100'
    };

    // Ensure we have at least 12 digits
    const paddedNumber = barcodeNumber.padStart(12, '0').slice(0, 12);

    let barcodePattern = '101'; // Start guard

    // Left side (first 6 digits)
    for (let i = 0; i < 6; i++) {
        const digit = paddedNumber[i];
        barcodePattern += leftPatterns[digit] || leftPatterns['0'];
    }

    barcodePattern += '01010'; // Center guard

    // Right side (last 6 digits)
    for (let i = 6; i < 12; i++) {
        const digit = paddedNumber[i];
        barcodePattern += rightPatterns[digit] || rightPatterns['0'];
    }

    barcodePattern += '101'; // End guard

    return barcodePattern;
}

// Create SVG barcode with proper scaling and appearance
function createBarcodeSVG(barcodeNumber, width = 200, height = 60) {
    const pattern = generateBarcodePattern(barcodeNumber);
    const barWidth = Math.max(1, width / pattern.length); // Minimum 1px bar width
    const actualWidth = barWidth * pattern.length;

    let svg = `<svg width="${actualWidth}" height="${height}" xmlns="http://www.w3.org/2000/svg" style="background: white;">`;
    svg += `<rect width="${actualWidth}" height="${height}" fill="white"/>`;

    let x = 0;
    for (let i = 0; i < pattern.length; i++) {
        if (pattern[i] === '1') {
            svg += `<rect x="${x}" y="0" width="${barWidth}" height="${height * 0.8}" fill="black"/>`;
        }
        x += barWidth;
    }

    // Add the barcode number below the bars
    const fontSize = Math.min(height * 0.15, 12);
    const textY = height * 0.95;
    svg += `<text x="${actualWidth / 2}" y="${textY}" text-anchor="middle" font-family="monospace" font-size="${fontSize}" fill="black">${barcodeNumber}</text>`;

    svg += '</svg>';
    return svg;
}

function getCategoryCode(category) {
    // Map categories to 3-digit codes
    const categoryCodes = {
        'tools': '200',
        'hardware': '201',
        'construction': '202',
        'electrical': '203',
        'plumbing': '204',
        'food': '100',
        'drinks': '101',
        'snacks': '102'
    };

    return categoryCodes[category.toLowerCase()] || '999';
}

// Enhanced barcode printing with multiple labels
function printMultipleBarcodes(productId, quantity = 1) {
    const product = products.find(p => p.id === productId);
    if (!product) {
        alert(t('productNotFound'));
        return;
    }

    // Generate barcode if needed
    if (!product.barcode || product.barcode === '') {
        product.barcode = generateProductBarcode(product);
        saveToStorage('products', products);
    }

    const printWindow = window.open('', '_blank');
    let barcodeLabels = '';

    // Generate multiple barcode labels
    for (let i = 0; i < quantity; i++) {
        barcodeLabels += `
            <div class="barcode-label">
                <div class="product-name">${getProductName(product)}</div>
                <div class="barcode-visual">${createBarcodeSVG(product.barcode, 180, 30)}</div>
                <div class="barcode-display">${product.barcode}</div>
                <div class="price">${formatCurrency(product.price)}</div>
            </div>
        `;
    }

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${t('printBarcode')} - ${getProductName(product)} (${quantity}x)</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 10px;
                }
                .barcode-label {
                    border: 1px solid #000;
                    padding: 10px;
                    margin: 5px;
                    width: 200px;
                    height: 120px;
                    display: inline-block;
                    text-align: center;
                    vertical-align: top;
                    background: white;
                    page-break-inside: avoid;
                }
                .product-name {
                    font-size: 10px;
                    font-weight: bold;
                    margin-bottom: 5px;
                    height: 20px;
                    overflow: hidden;
                }
                .barcode-visual {
                    height: 30px;
                    margin: 5px 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                }
                .barcode-visual svg {
                    max-width: 100%;
                    height: 100%;
                }
                .barcode-display {
                    font-family: 'Courier New', monospace;
                    font-size: 8px;
                    margin: 5px 0;
                }
                .price {
                    font-size: 12px;
                    font-weight: bold;
                    color: #2c5aa0;
                }
                @media print {
                    body { margin: 0; }
                }
            </style>
        </head>
        <body>
            ${barcodeLabels}
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 1000);
                };
            </script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// Show bulk barcode printing modal
function showBulkBarcodeModal() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';

    const productsList = products.map(product => `
        <div class="product-checkbox">
            <label>
                <input type="checkbox" value="${product.id}" class="barcode-product-checkbox">
                <span class="product-info">
                    <strong>${getProductName(product)}</strong><br>
                    <small>${t('category')}: ${t(product.category)} | ${t('price')}: ${formatCurrency(product.price)}</small><br>
                    <small>${t('barcode')}: ${product.barcode || t('noBarcodeFound')}</small>
                </span>
            </label>
            <input type="number" min="1" max="50" value="1" class="quantity-input" data-product-id="${product.id}">
        </div>
    `).join('');

    modal.innerHTML = `
        <div class="modal-content bulk-barcode-modal">
            <h2 data-translate="bulkBarcodePrint">${t('bulkBarcodePrint')}</h2>
            <p data-translate="selectProductsForBarcode">${t('selectProductsForBarcode')}</p>

            <div class="bulk-actions">
                <button type="button" class="btn btn-secondary" onclick="selectAllProducts(true)">${t('selectAll')}</button>
                <button type="button" class="btn btn-secondary" onclick="selectAllProducts(false)">${t('deselectAll')}</button>
                <button type="button" class="btn btn-info" onclick="selectProductsWithoutBarcode()">${t('selectWithoutBarcode')}</button>
            </div>

            <div class="products-list">
                ${productsList}
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()" data-translate="cancel">${t('cancel')}</button>
                <button type="button" class="btn btn-primary" onclick="printSelectedBarcodes()" data-translate="printSelectedBarcodes">${t('printSelectedBarcodes')}</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function selectAllProducts(select) {
    const checkboxes = document.querySelectorAll('.barcode-product-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = select;
    });
}

function selectProductsWithoutBarcode() {
    const checkboxes = document.querySelectorAll('.barcode-product-checkbox');
    checkboxes.forEach(checkbox => {
        const productId = parseInt(checkbox.value);
        const product = products.find(p => p.id === productId);
        checkbox.checked = !product.barcode || product.barcode === '';
    });
}

function printSelectedBarcodes() {
    const selectedProducts = [];
    const checkboxes = document.querySelectorAll('.barcode-product-checkbox:checked');

    if (checkboxes.length === 0) {
        alert(t('selectAtLeastOneProduct'));
        return;
    }

    checkboxes.forEach(checkbox => {
        const productId = parseInt(checkbox.value);
        const quantityInput = document.querySelector(`.quantity-input[data-product-id="${productId}"]`);
        const quantity = parseInt(quantityInput.value) || 1;

        selectedProducts.push({
            productId: productId,
            quantity: quantity
        });
    });

    // Generate barcodes for products that don't have them
    selectedProducts.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product && (!product.barcode || product.barcode === '')) {
            product.barcode = generateProductBarcode(product);
        }
    });

    // Save updated products
    saveToStorage('products', products);

    // Create bulk print window
    printBulkBarcodes(selectedProducts);

    // Close modal
    closeModal();

    // Refresh inventory view
    if (currentView === 'inventory') {
        loadInventoryView();
    }
}

function printBulkBarcodes(selectedProducts) {
    const printWindow = window.open('', '_blank');
    let barcodeLabels = '';

    selectedProducts.forEach(item => {
        const product = products.find(p => p.id === item.productId);
        if (product) {
            for (let i = 0; i < item.quantity; i++) {
                barcodeLabels += `
                    <div class="barcode-label">
                        <div class="product-name">${getProductName(product)}</div>
                        <div class="barcode-visual">${createBarcodeSVG(product.barcode, 160, 25)}</div>
                        <div class="barcode-display">${product.barcode}</div>
                        <div class="price">${formatCurrency(product.price)}</div>
                        <div class="category">${t(product.category)}</div>
                    </div>
                `;
            }
        }
    });

    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${t('bulkBarcodePrint')} - ${selectedProducts.length} ${t('products')}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 10px;
                }
                .barcode-label {
                    border: 1px solid #000;
                    padding: 8px;
                    margin: 3px;
                    width: 180px;
                    height: 110px;
                    display: inline-block;
                    text-align: center;
                    vertical-align: top;
                    background: white;
                    page-break-inside: avoid;
                }
                .product-name {
                    font-size: 9px;
                    font-weight: bold;
                    margin-bottom: 3px;
                    height: 18px;
                    overflow: hidden;
                    line-height: 9px;
                }
                .barcode-visual {
                    height: 25px;
                    margin: 3px 0;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: white;
                }
                .barcode-visual svg {
                    max-width: 100%;
                    height: 100%;
                }
                .barcode-display {
                    font-family: 'Courier New', monospace;
                    font-size: 7px;
                    margin: 3px 0;
                    letter-spacing: 1px;
                }
                .price {
                    font-size: 11px;
                    font-weight: bold;
                    color: #2c5aa0;
                    margin: 2px 0;
                }
                .category {
                    font-size: 7px;
                    color: #666;
                    margin-top: 2px;
                }
                @media print {
                    body { margin: 0; }
                    .barcode-label {
                        margin: 2px;
                        page-break-inside: avoid;
                    }
                }
            </style>
        </head>
        <body>
            <h3 style="text-align: center; margin-bottom: 20px;">${t('bulkBarcodePrint')} - ${new Date().toLocaleDateString()}</h3>
            ${barcodeLabels}
            <script>
                window.onload = function() {
                    window.print();
                    setTimeout(function() {
                        window.close();
                    }, 1000);
                };
            </script>
        </body>
        </html>
    `);
    printWindow.document.close();
}
